This file is a merged representation of the entire codebase, combined into a single document by Repomix.

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)


================================================================
Directory Structure
================================================================
css/
  admin.css
  jquery-ui.css
  jquery-ui.min.css
  movie-block-editor.css
  movie-grid.css
includes/
  interfaces/
    interface-letterboxd-api-service.php
  services/
    class-letterboxd-api-service.php
  templates/
    settings-page.php
  traits/
    trait-letterboxd-error-handling.php
    trait-letterboxd-security.php
    trait-letterboxd-validation.php
  class-auto-import.php
  class-letterboxd-importer.php
  class-movie-block-renderer.php
  class-movie-post-type.php
  class-settings-manager.php
  class-tmdb-handler.php
  functions.php
js/
  movie-block.js
  settings.js
letterboxd.php
LICENSE
README.md
uninstall.php

================================================================
Files
================================================================

================
File: css/jquery-ui.css
================
.ui-button-icon-only,.ui-controlgroup-vertical .ui-controlgroup-item{box-sizing:border-box}.ui-checkboxradio-disabled,.ui-state-disabled{pointer-events:none}.ui-datepicker .ui-icon,.ui-icon{text-indent:-99999px;background-repeat:no-repeat}.ui-helper-reset,.ui-menu{outline:0;list-style:none}.ui-helper-hidden,.ui-resizable-autohide .ui-resizable-handle,.ui-resizable-disabled .ui-resizable-handle{display:none}.ui-helper-hidden-accessible{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.ui-helper-reset{margin:0;padding:0;border:0;line-height:1.3;text-decoration:none;font-size:100%}.ui-helper-clearfix:after,.ui-helper-clearfix:before{content:"";display:table;border-collapse:collapse}.ui-helper-clearfix:after{clear:both}.ui-helper-zfix{width:100%;height:100%;top:0;left:0;position:absolute;opacity:0;filter:Alpha(Opacity=0)}.ui-front{z-index:100}.ui-state-disabled{cursor:default!important}.ui-icon{display:inline-block;vertical-align:middle;margin-top:-.25em;position:relative;overflow:hidden}.ui-widget-icon-block{left:50%;margin-left:-8px;display:block}.ui-widget-overlay{position:fixed;top:0;left:0;width:100%;height:100%}.ui-accordion .ui-accordion-header{display:block;cursor:pointer;position:relative;margin:2px 0 0;padding:.5em .5em .5em .7em;font-size:100%}.ui-autocomplete,.ui-menu .ui-menu{position:absolute}.ui-accordion .ui-accordion-content{padding:1em 2.2em;border-top:0;overflow:auto}.ui-autocomplete{top:0;left:0;cursor:default}.ui-menu{padding:0;margin:0;display:block}.ui-button,.ui-controlgroup{display:inline-block;vertical-align:middle}.ui-button,.ui-menu-icons,.ui-resizable{position:relative}.ui-menu .ui-menu-item{margin:0;cursor:pointer;list-style-image:url("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7")}.ui-menu .ui-menu-item-wrapper{position:relative;padding:3px 1em 3px .4em}.ui-menu .ui-menu-divider{margin:5px 0;height:0;font-size:0;line-height:0;border-width:1px 0 0}.ui-menu .ui-state-active,.ui-menu .ui-state-focus{margin:-1px}.ui-menu-icons .ui-menu-item-wrapper{padding-left:2em}.ui-button,.ui-controlgroup .ui-controlgroup-label{padding:.4em 1em}.ui-menu .ui-icon{position:absolute;top:0;bottom:0;left:.2em;margin:auto 0}.ui-menu .ui-menu-icon{left:auto;right:0}.ui-button{line-height:normal;margin-right:.1em;cursor:pointer;text-align:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;overflow:visible}.ui-button,.ui-button:active,.ui-button:hover,.ui-button:link,.ui-button:visited{text-decoration:none}.ui-button-icon-only{width:2em;text-indent:-9999px;white-space:nowrap}input.ui-button.ui-button-icon-only{text-indent:0}.ui-button-icon-only .ui-icon{position:absolute;top:50%;left:50%;margin-top:-8px;margin-left:-8px}.ui-button.ui-icon-notext .ui-icon{padding:0;width:2.1em;height:2.1em;text-indent:-9999px;white-space:nowrap}input.ui-button.ui-icon-notext .ui-icon{width:auto;height:auto;text-indent:0;white-space:normal;padding:.4em 1em}button.ui-button::-moz-focus-inner,input.ui-button::-moz-focus-inner{border:0;padding:0}.ui-controlgroup>.ui-controlgroup-item{float:left;margin-left:0;margin-right:0}.ui-controlgroup>.ui-controlgroup-item.ui-visual-focus,.ui-controlgroup>.ui-controlgroup-item:focus{z-index:9999}.ui-controlgroup-vertical>.ui-controlgroup-item{display:block;float:none;width:100%;margin-top:0;margin-bottom:0;text-align:left}.ui-controlgroup .ui-controlgroup-label span{font-size:80%}.ui-controlgroup-horizontal .ui-controlgroup-label+.ui-controlgroup-item{border-left:none}.ui-controlgroup-vertical .ui-controlgroup-label+.ui-controlgroup-item{border-top:none}.ui-controlgroup-horizontal .ui-controlgroup-label.ui-widget-content{border-right:none}.ui-controlgroup-vertical .ui-controlgroup-label.ui-widget-content{border-bottom:none}.ui-controlgroup-vertical .ui-spinner-input{width:75%;width:calc(100% - 2.4em)}.ui-controlgroup-vertical .ui-spinner .ui-spinner-up{border-top-style:solid}.ui-checkboxradio-label .ui-icon-background{box-shadow:inset 1px 1px 1px #ccc;border-radius:.12em;border:none}.ui-checkboxradio-radio-label .ui-icon-background{width:16px;height:16px;border-radius:1em;overflow:visible;border:none}.ui-checkboxradio-radio-label.ui-checkboxradio-checked .ui-icon,.ui-checkboxradio-radio-label.ui-checkboxradio-checked:hover .ui-icon{background-image:none;width:8px;height:8px;border-width:4px;border-style:solid}.ui-datepicker{width:17em;padding:.2em .2em 0;display:none}.ui-datepicker .ui-datepicker-header{position:relative;padding:.2em 0}.ui-datepicker .ui-datepicker-next,.ui-datepicker .ui-datepicker-prev{position:absolute;top:2px;width:1.8em;height:1.8em}.ui-datepicker .ui-datepicker-next-hover,.ui-datepicker .ui-datepicker-prev-hover{top:1px}.ui-datepicker .ui-datepicker-prev{left:2px}.ui-datepicker .ui-datepicker-next{right:2px}.ui-datepicker .ui-datepicker-prev-hover{left:1px}.ui-datepicker .ui-datepicker-next-hover{right:1px}.ui-datepicker .ui-datepicker-next span,.ui-datepicker .ui-datepicker-prev span{display:block;position:absolute;left:50%;margin-left:-8px;top:50%;margin-top:-8px}.ui-datepicker .ui-datepicker-title{margin:0 2.3em;line-height:1.8em;text-align:center}.ui-datepicker .ui-datepicker-title select{font-size:1em;margin:1px 0}.ui-datepicker select.ui-datepicker-month,.ui-datepicker select.ui-datepicker-year{width:45%}.ui-datepicker table{width:100%;font-size:.9em;border-collapse:collapse;margin:0 0 .4em}.ui-datepicker th{padding:.7em .3em;text-align:center;font-weight:700;border:0}.ui-datepicker td{border:0;padding:1px}.ui-datepicker td a,.ui-datepicker td span{display:block;padding:.2em;text-align:right;text-decoration:none}.ui-datepicker .ui-datepicker-buttonpane{background-image:none;margin:.7em 0 0;padding:0 .2em;border-left:0;border-right:0;border-bottom:0}.ui-datepicker .ui-datepicker-buttonpane button{float:right;margin:.5em .2em .4em;cursor:pointer;padding:.2em .6em .3em;width:auto;overflow:visible}.ui-datepicker .ui-datepicker-buttonpane button.ui-datepicker-current,.ui-datepicker-multi .ui-datepicker-group,.ui-datepicker-rtl .ui-datepicker-buttonpane button{float:left}.ui-datepicker.ui-datepicker-multi{width:auto}.ui-datepicker-multi .ui-datepicker-group table{width:95%;margin:0 auto .4em}.ui-datepicker-multi-2 .ui-datepicker-group{width:50%}.ui-datepicker-multi-3 .ui-datepicker-group{width:33.3%}.ui-datepicker-multi-4 .ui-datepicker-group{width:25%}.ui-datepicker-multi .ui-datepicker-group-last .ui-datepicker-header,.ui-datepicker-multi .ui-datepicker-group-middle .ui-datepicker-header{border-left-width:0}.ui-datepicker-multi .ui-datepicker-buttonpane{clear:left}.ui-datepicker-row-break{clear:both;width:100%;font-size:0}.ui-datepicker-rtl{direction:rtl}.ui-datepicker-rtl .ui-datepicker-prev{right:2px;left:auto}.ui-datepicker-rtl .ui-datepicker-next{left:2px;right:auto}.ui-datepicker-rtl .ui-datepicker-prev:hover{right:1px;left:auto}.ui-datepicker-rtl .ui-datepicker-next:hover{left:1px;right:auto}.ui-datepicker-rtl .ui-datepicker-buttonpane{clear:right}.ui-datepicker-rtl .ui-datepicker-buttonpane button.ui-datepicker-current,.ui-datepicker-rtl .ui-datepicker-group,.ui-dialog .ui-dialog-buttonpane .ui-dialog-buttonset{float:right}.ui-datepicker-rtl .ui-datepicker-group-last .ui-datepicker-header,.ui-datepicker-rtl .ui-datepicker-group-middle .ui-datepicker-header{border-right-width:0;border-left-width:1px}.ui-datepicker .ui-icon{display:block;overflow:hidden;left:.5em;top:.3em}.ui-dialog{position:absolute;top:0;left:0;padding:.2em;outline:0}.ui-dialog .ui-dialog-titlebar{padding:.4em 1em;position:relative}.ui-dialog .ui-dialog-title{float:left;margin:.1em 0;white-space:nowrap;width:90%;overflow:hidden;text-overflow:ellipsis}.ui-dialog .ui-dialog-titlebar-close{position:absolute;right:.3em;top:50%;width:20px;margin:-10px 0 0;padding:1px;height:20px}.ui-dialog .ui-dialog-content{position:relative;border:0;padding:.5em 1em;background:0 0;overflow:auto}.ui-dialog .ui-dialog-buttonpane{text-align:left;border-width:1px 0 0;background-image:none;margin-top:.5em;padding:.3em 1em .5em .4em}.ui-dialog .ui-dialog-buttonpane button{margin:.5em .4em .5em 0;cursor:pointer}.ui-dialog .ui-resizable-n{height:2px;top:0}.ui-dialog .ui-resizable-e{width:2px;right:0}.ui-dialog .ui-resizable-s{height:2px;bottom:0}.ui-dialog .ui-resizable-w{width:2px;left:0}.ui-dialog .ui-resizable-ne,.ui-dialog .ui-resizable-nw,.ui-dialog .ui-resizable-se,.ui-dialog .ui-resizable-sw{width:7px;height:7px}.ui-dialog .ui-resizable-se{right:0;bottom:0}.ui-dialog .ui-resizable-sw{left:0;bottom:0}.ui-dialog .ui-resizable-ne{right:0;top:0}.ui-dialog .ui-resizable-nw{left:0;top:0}.ui-draggable .ui-dialog-titlebar{cursor:move}.ui-draggable-handle,.ui-selectable,.ui-sortable-handle{-ms-touch-action:none;touch-action:none}.ui-resizable-handle{position:absolute;font-size:.1px;display:block;-ms-touch-action:none;touch-action:none}.ui-resizable-n{cursor:n-resize;height:7px;width:100%;top:-5px;left:0}.ui-resizable-s{cursor:s-resize;height:7px;width:100%;bottom:-5px;left:0}.ui-resizable-e{cursor:e-resize;width:7px;right:-5px;top:0;height:100%}.ui-resizable-w{cursor:w-resize;width:7px;left:-5px;top:0;height:100%}.ui-resizable-se{cursor:se-resize;width:12px;height:12px;right:1px;bottom:1px}.ui-resizable-sw{cursor:sw-resize;width:9px;height:9px;left:-5px;bottom:-5px}.ui-resizable-nw{cursor:nw-resize;width:9px;height:9px;left:-5px;top:-5px}.ui-resizable-ne{cursor:ne-resize;width:9px;height:9px;right:-5px;top:-5px}.ui-progressbar{height:2em;text-align:left;overflow:hidden}.ui-progressbar .ui-progressbar-value{margin:-1px;height:100%}.ui-progressbar .ui-progressbar-overlay{background:url("data:image/gif;base64,R0lGODlhKAAoAIABAAAAAP///yH/C05FVFNDQVBFMi4wAwEAAAAh+QQJAQABACwAAAAAKAAoAAACkYwNqXrdC52DS06a7MFZI+4FHBCKoDeWKXqymPqGqxvJrXZbMx7Ttc+w9XgU2FB3lOyQRWET2IFGiU9m1frDVpxZZc6bfHwv4c1YXP6k1Vdy292Fb6UkuvFtXpvWSzA+HycXJHUXiGYIiMg2R6W459gnWGfHNdjIqDWVqemH2ekpObkpOlppWUqZiqr6edqqWQAAIfkECQEAAQAsAAAAACgAKAAAApSMgZnGfaqcg1E2uuzDmmHUBR8Qil95hiPKqWn3aqtLsS18y7G1SzNeowWBENtQd+T1JktP05nzPTdJZlR6vUxNWWjV+vUWhWNkWFwxl9VpZRedYcflIOLafaa28XdsH/ynlcc1uPVDZxQIR0K25+cICCmoqCe5mGhZOfeYSUh5yJcJyrkZWWpaR8doJ2o4NYq62lAAACH5BAkBAAEALAAAAAAoACgAAAKVDI4Yy22ZnINRNqosw0Bv7i1gyHUkFj7oSaWlu3ovC8GxNso5fluz3qLVhBVeT/Lz7ZTHyxL5dDalQWPVOsQWtRnuwXaFTj9jVVh8pma9JjZ4zYSj5ZOyma7uuolffh+IR5aW97cHuBUXKGKXlKjn+DiHWMcYJah4N0lYCMlJOXipGRr5qdgoSTrqWSq6WFl2ypoaUAAAIfkECQEAAQAsAAAAACgAKAAAApaEb6HLgd/iO7FNWtcFWe+ufODGjRfoiJ2akShbueb0wtI50zm02pbvwfWEMWBQ1zKGlLIhskiEPm9R6vRXxV4ZzWT2yHOGpWMyorblKlNp8HmHEb/lCXjcW7bmtXP8Xt229OVWR1fod2eWqNfHuMjXCPkIGNileOiImVmCOEmoSfn3yXlJWmoHGhqp6ilYuWYpmTqKUgAAIfkECQEAAQAsAAAAACgAKAAAApiEH6kb58biQ3FNWtMFWW3eNVcojuFGfqnZqSebuS06w5V80/X02pKe8zFwP6EFWOT1lDFk8rGERh1TTNOocQ61Hm4Xm2VexUHpzjymViHrFbiELsefVrn6XKfnt2Q9G/+Xdie499XHd2g4h7ioOGhXGJboGAnXSBnoBwKYyfioubZJ2Hn0RuRZaflZOil56Zp6iioKSXpUAAAh+QQJAQABACwAAAAAKAAoAAACkoQRqRvnxuI7kU1a1UU5bd5tnSeOZXhmn5lWK3qNTWvRdQxP8qvaC+/yaYQzXO7BMvaUEmJRd3TsiMAgswmNYrSgZdYrTX6tSHGZO73ezuAw2uxuQ+BbeZfMxsexY35+/Qe4J1inV0g4x3WHuMhIl2jXOKT2Q+VU5fgoSUI52VfZyfkJGkha6jmY+aaYdirq+lQAACH5BAkBAAEALAAAAAAoACgAAAKWBIKpYe0L3YNKToqswUlvznigd4wiR4KhZrKt9Upqip61i9E3vMvxRdHlbEFiEXfk9YARYxOZZD6VQ2pUunBmtRXo1Lf8hMVVcNl8JafV38aM2/Fu5V16Bn63r6xt97j09+MXSFi4BniGFae3hzbH9+hYBzkpuUh5aZmHuanZOZgIuvbGiNeomCnaxxap2upaCZsq+1kAACH5BAkBAAEALAAAAAAoACgAAAKXjI8By5zf4kOxTVrXNVlv1X0d8IGZGKLnNpYtm8Lr9cqVeuOSvfOW79D9aDHizNhDJidFZhNydEahOaDH6nomtJjp1tutKoNWkvA6JqfRVLHU/QUfau9l2x7G54d1fl995xcIGAdXqMfBNadoYrhH+Mg2KBlpVpbluCiXmMnZ2Sh4GBqJ+ckIOqqJ6LmKSllZmsoq6wpQAAAh+QQJAQABACwAAAAAKAAoAAAClYx/oLvoxuJDkU1a1YUZbJ59nSd2ZXhWqbRa2/gF8Gu2DY3iqs7yrq+xBYEkYvFSM8aSSObE+ZgRl1BHFZNr7pRCavZ5BW2142hY3AN/zWtsmf12p9XxxFl2lpLn1rseztfXZjdIWIf2s5dItwjYKBgo9yg5pHgzJXTEeGlZuenpyPmpGQoKOWkYmSpaSnqKileI2FAAACH5BAkBAAEALAAAAAAoACgAAAKVjB+gu+jG4kORTVrVhRlsnn2dJ3ZleFaptFrb+CXmO9OozeL5VfP99HvAWhpiUdcwkpBH3825AwYdU8xTqlLGhtCosArKMpvfa1mMRae9VvWZfeB2XfPkeLmm18lUcBj+p5dnN8jXZ3YIGEhYuOUn45aoCDkp16hl5IjYJvjWKcnoGQpqyPlpOhr3aElaqrq56Bq7VAAAOw==");height:100%;opacity:.25}.ui-progressbar-indeterminate .ui-progressbar-value{background-image:none}.ui-selectable-helper{position:absolute;z-index:100;border:1px dotted #000}.ui-selectmenu-menu{padding:0;margin:0;position:absolute;top:0;left:0;display:none}.ui-selectmenu-menu .ui-menu{overflow:auto;overflow-x:hidden;padding-bottom:1px}.ui-selectmenu-menu .ui-menu .ui-selectmenu-optgroup{font-size:1em;font-weight:700;line-height:1.5;padding:2px .4em;margin:.5em 0 0;height:auto;border:0}.ui-selectmenu-open{display:block}.ui-selectmenu-text{display:block;margin-right:20px;overflow:hidden;text-overflow:ellipsis}.ui-selectmenu-button.ui-button{text-align:left;white-space:nowrap;width:14em}.ui-selectmenu-icon.ui-icon{float:right;margin-top:0}.ui-slider{position:relative;text-align:left}.ui-slider .ui-slider-handle{position:absolute;z-index:2;width:1.2em;height:1.2em;cursor:default;-ms-touch-action:none;touch-action:none}.ui-slider .ui-slider-range{position:absolute;z-index:1;font-size:.7em;display:block;border:0;background-position:0 0}.ui-slider.ui-state-disabled .ui-slider-handle,.ui-slider.ui-state-disabled .ui-slider-range{filter:inherit}.ui-slider-horizontal{height:.8em}.ui-slider-horizontal .ui-slider-handle{top:-.3em;margin-left:-.6em}.ui-slider-horizontal .ui-slider-range{top:0;height:100%}.ui-slider-horizontal .ui-slider-range-min{left:0}.ui-slider-horizontal .ui-slider-range-max{right:0}.ui-slider-vertical{width:.8em;height:100px}.ui-slider-vertical .ui-slider-handle{left:-.3em;margin-left:0;margin-bottom:-.6em}.ui-slider-vertical .ui-slider-range{left:0;width:100%}.ui-slider-vertical .ui-slider-range-min,.ui-spinner-down{bottom:0}.ui-slider-vertical .ui-slider-range-max,.ui-spinner-up{top:0}.ui-spinner{position:relative;display:inline-block;overflow:hidden;padding:0;vertical-align:middle}.ui-spinner-input{border:none;background:0 0;color:inherit;padding:.222em 0;margin:.2em 2em .2em .4em;vertical-align:middle}.ui-spinner-button{width:1.6em;height:50%;font-size:.5em;padding:0;margin:0;text-align:center;position:absolute;cursor:default;display:block;overflow:hidden;right:0}.ui-spinner a.ui-spinner-button{border-top-style:none;border-bottom-style:none;border-right-style:none}.ui-tabs{position:relative;padding:.2em}.ui-tabs .ui-tabs-nav{margin:0;padding:.2em .2em 0}.ui-tabs .ui-tabs-nav li{list-style:none;float:left;position:relative;top:0;margin:1px .2em 0 0;border-bottom-width:0;padding:0;white-space:nowrap}.ui-tabs .ui-tabs-nav .ui-tabs-anchor{float:left;padding:.5em 1em;text-decoration:none}.ui-tabs .ui-tabs-nav li.ui-tabs-active{margin-bottom:-1px;padding-bottom:1px}.ui-tabs .ui-tabs-nav li.ui-state-disabled .ui-tabs-anchor,.ui-tabs .ui-tabs-nav li.ui-tabs-active .ui-tabs-anchor,.ui-tabs .ui-tabs-nav li.ui-tabs-loading .ui-tabs-anchor{cursor:text}.ui-tabs-collapsible .ui-tabs-nav li.ui-tabs-active .ui-tabs-anchor{cursor:pointer}.ui-tabs .ui-tabs-panel{display:block;border-width:0;padding:1em 1.4em;background:0 0}.ui-tooltip{padding:8px;position:absolute;z-index:9999;max-width:300px}body .ui-tooltip{border-width:2px}.ui-widget,.ui-widget button,.ui-widget input,.ui-widget select,.ui-widget textarea{font-family:Arial,Helvetica,sans-serif;font-size:1em}.ui-widget .ui-widget{font-size:1em}.ui-widget.ui-widget-content{border:1px solid #c5c5c5}.ui-widget-content{border:1px solid #ddd;background:#fff;color:#333}.ui-widget-content a,.ui-widget-header a{color:#333}.ui-widget-header{border:1px solid #ddd;background:#e9e9e9;color:#333;font-weight:700}.ui-button,.ui-state-default,.ui-widget-content .ui-state-default,.ui-widget-header .ui-state-default,html .ui-button.ui-state-disabled:active,html .ui-button.ui-state-disabled:hover{border:1px solid #c5c5c5;background:#f6f6f6;font-weight:400;color:#454545}.ui-button,.ui-state-default a,.ui-state-default a:link,.ui-state-default a:visited,a.ui-button,a:link.ui-button,a:visited.ui-button{color:#454545;text-decoration:none}.ui-button:focus,.ui-button:hover,.ui-state-focus,.ui-state-hover,.ui-widget-content .ui-state-focus,.ui-widget-content .ui-state-hover,.ui-widget-header .ui-state-focus,.ui-widget-header .ui-state-hover{border:1px solid #ccc;background:#ededed;font-weight:400;color:#2b2b2b}.ui-state-focus a,.ui-state-focus a:hover,.ui-state-focus a:link,.ui-state-focus a:visited,.ui-state-hover a,.ui-state-hover a:hover,.ui-state-hover a:link,.ui-state-hover a:visited,a.ui-button:focus,a.ui-button:hover{color:#2b2b2b;text-decoration:none}.ui-visual-focus{box-shadow:0 0 3px 1px #5e9ed6}.ui-button.ui-state-active:hover,.ui-button:active,.ui-state-active,.ui-widget-content .ui-state-active,.ui-widget-header .ui-state-active,a.ui-button:active{border:1px solid #003eff;background:#007fff;font-weight:400;color:#fff}.ui-icon-background,.ui-state-active .ui-icon-background{border:#003eff;background-color:#fff}.ui-state-active a,.ui-state-active a:link,.ui-state-active a:visited{color:#fff;text-decoration:none}.ui-state-highlight,.ui-widget-content .ui-state-highlight,.ui-widget-header .ui-state-highlight{border:1px solid #dad55e;background:#fffa90;color:#777620}.ui-state-checked{border:1px solid #dad55e;background:#fffa90}.ui-state-highlight a,.ui-widget-content .ui-state-highlight a,.ui-widget-header .ui-state-highlight a{color:#777620}.ui-state-error,.ui-widget-content .ui-state-error,.ui-widget-header .ui-state-error{border:1px solid #f1a899;background:#fddfdf;color:#5f3f3f}.ui-state-error a,.ui-state-error-text,.ui-widget-content .ui-state-error a,.ui-widget-content .ui-state-error-text,.ui-widget-header .ui-state-error a,.ui-widget-header .ui-state-error-text{color:#5f3f3f}.ui-priority-primary,.ui-widget-content .ui-priority-primary,.ui-widget-header .ui-priority-primary{font-weight:700}.ui-priority-secondary,.ui-widget-content .ui-priority-secondary,.ui-widget-header .ui-priority-secondary{opacity:.7;filter:Alpha(Opacity=70);font-weight:400}.ui-state-disabled,.ui-widget-content .ui-state-disabled,.ui-widget-header .ui-state-disabled{opacity:.35;filter:Alpha(Opacity=35);background-image:none}.ui-state-disabled .ui-icon{filter:Alpha(Opacity=35)}.ui-icon{width:16px;height:16px}.ui-icon,.ui-widget-content .ui-icon,.ui-widget-header .ui-icon{background-image:url("images/ui-icons_444444_256x240.png")}.ui-button:focus .ui-icon,.ui-button:hover .ui-icon,.ui-state-focus .ui-icon,.ui-state-hover .ui-icon{background-image:url("images/ui-icons_555555_256x240.png")}.ui-button:active .ui-icon,.ui-state-active .ui-icon{background-image:url("images/ui-icons_ffffff_256x240.png")}.ui-button .ui-state-highlight.ui-icon,.ui-state-highlight .ui-icon{background-image:url("images/ui-icons_777620_256x240.png")}.ui-state-error .ui-icon,.ui-state-error-text .ui-icon{background-image:url("images/ui-icons_cc0000_256x240.png")}.ui-button .ui-icon{background-image:url("images/ui-icons_777777_256x240.png")}.ui-icon-blank{background-position:16px 16px}.ui-icon-caret-1-n{background-position:0 0}.ui-icon-caret-1-ne{background-position:-16px 0}.ui-icon-caret-1-e{background-position:-32px 0}.ui-icon-caret-1-se{background-position:-48px 0}.ui-icon-caret-1-s{background-position:-65px 0}.ui-icon-caret-1-sw{background-position:-80px 0}.ui-icon-caret-1-w{background-position:-96px 0}.ui-icon-caret-1-nw{background-position:-112px 0}.ui-icon-caret-2-n-s{background-position:-128px 0}.ui-icon-caret-2-e-w{background-position:-144px 0}.ui-icon-triangle-1-n{background-position:0 -16px}.ui-icon-triangle-1-ne{background-position:-16px -16px}.ui-icon-triangle-1-e{background-position:-32px -16px}.ui-icon-triangle-1-se{background-position:-48px -16px}.ui-icon-triangle-1-s{background-position:-65px -16px}.ui-icon-triangle-1-sw{background-position:-80px -16px}.ui-icon-triangle-1-w{background-position:-96px -16px}.ui-icon-triangle-1-nw{background-position:-112px -16px}.ui-icon-triangle-2-n-s{background-position:-128px -16px}.ui-icon-triangle-2-e-w{background-position:-144px -16px}.ui-icon-arrow-1-n{background-position:0 -32px}.ui-icon-arrow-1-ne{background-position:-16px -32px}.ui-icon-arrow-1-e{background-position:-32px -32px}.ui-icon-arrow-1-se{background-position:-48px -32px}.ui-icon-arrow-1-s{background-position:-65px -32px}.ui-icon-arrow-1-sw{background-position:-80px -32px}.ui-icon-arrow-1-w{background-position:-96px -32px}.ui-icon-arrow-1-nw{background-position:-112px -32px}.ui-icon-arrow-2-n-s{background-position:-128px -32px}.ui-icon-arrow-2-ne-sw{background-position:-144px -32px}.ui-icon-arrow-2-e-w{background-position:-160px -32px}.ui-icon-arrow-2-se-nw{background-position:-176px -32px}.ui-icon-arrowstop-1-n{background-position:-192px -32px}.ui-icon-arrowstop-1-e{background-position:-208px -32px}.ui-icon-arrowstop-1-s{background-position:-224px -32px}.ui-icon-arrowstop-1-w{background-position:-240px -32px}.ui-icon-arrowthick-1-n{background-position:1px -48px}.ui-icon-arrowthick-1-ne{background-position:-16px -48px}.ui-icon-arrowthick-1-e{background-position:-32px -48px}.ui-icon-arrowthick-1-se{background-position:-48px -48px}.ui-icon-arrowthick-1-s{background-position:-64px -48px}.ui-icon-arrowthick-1-sw{background-position:-80px -48px}.ui-icon-arrowthick-1-w{background-position:-96px -48px}.ui-icon-arrowthick-1-nw{background-position:-112px -48px}.ui-icon-arrowthick-2-n-s{background-position:-128px -48px}.ui-icon-arrowthick-2-ne-sw{background-position:-144px -48px}.ui-icon-arrowthick-2-e-w{background-position:-160px -48px}.ui-icon-arrowthick-2-se-nw{background-position:-176px -48px}.ui-icon-arrowthickstop-1-n{background-position:-192px -48px}.ui-icon-arrowthickstop-1-e{background-position:-208px -48px}.ui-icon-arrowthickstop-1-s{background-position:-224px -48px}.ui-icon-arrowthickstop-1-w{background-position:-240px -48px}.ui-icon-arrowreturnthick-1-w{background-position:0 -64px}.ui-icon-arrowreturnthick-1-n{background-position:-16px -64px}.ui-icon-arrowreturnthick-1-e{background-position:-32px -64px}.ui-icon-arrowreturnthick-1-s{background-position:-48px -64px}.ui-icon-arrowreturn-1-w{background-position:-64px -64px}.ui-icon-arrowreturn-1-n{background-position:-80px -64px}.ui-icon-arrowreturn-1-e{background-position:-96px -64px}.ui-icon-arrowreturn-1-s{background-position:-112px -64px}.ui-icon-arrowrefresh-1-w{background-position:-128px -64px}.ui-icon-arrowrefresh-1-n{background-position:-144px -64px}.ui-icon-arrowrefresh-1-e{background-position:-160px -64px}.ui-icon-arrowrefresh-1-s{background-position:-176px -64px}.ui-icon-arrow-4{background-position:0 -80px}.ui-icon-arrow-4-diag{background-position:-16px -80px}.ui-icon-extlink{background-position:-32px -80px}.ui-icon-newwin{background-position:-48px -80px}.ui-icon-refresh{background-position:-64px -80px}.ui-icon-shuffle{background-position:-80px -80px}.ui-icon-transfer-e-w{background-position:-96px -80px}.ui-icon-transferthick-e-w{background-position:-112px -80px}.ui-icon-folder-collapsed{background-position:0 -96px}.ui-icon-folder-open{background-position:-16px -96px}.ui-icon-document{background-position:-32px -96px}.ui-icon-document-b{background-position:-48px -96px}.ui-icon-note{background-position:-64px -96px}.ui-icon-mail-closed{background-position:-80px -96px}.ui-icon-mail-open{background-position:-96px -96px}.ui-icon-suitcase{background-position:-112px -96px}.ui-icon-comment{background-position:-128px -96px}.ui-icon-person{background-position:-144px -96px}.ui-icon-print{background-position:-160px -96px}.ui-icon-trash{background-position:-176px -96px}.ui-icon-locked{background-position:-192px -96px}.ui-icon-unlocked{background-position:-208px -96px}.ui-icon-bookmark{background-position:-224px -96px}.ui-icon-tag{background-position:-240px -96px}.ui-icon-home{background-position:0 -112px}.ui-icon-flag{background-position:-16px -112px}.ui-icon-calendar{background-position:-32px -112px}.ui-icon-cart{background-position:-48px -112px}.ui-icon-pencil{background-position:-64px -112px}.ui-icon-clock{background-position:-80px -112px}.ui-icon-disk{background-position:-96px -112px}.ui-icon-calculator{background-position:-112px -112px}.ui-icon-zoomin{background-position:-128px -112px}.ui-icon-zoomout{background-position:-144px -112px}.ui-icon-search{background-position:-160px -112px}.ui-icon-wrench{background-position:-176px -112px}.ui-icon-gear{background-position:-192px -112px}.ui-icon-heart{background-position:-208px -112px}.ui-icon-star{background-position:-224px -112px}.ui-icon-link{background-position:-240px -112px}.ui-icon-cancel{background-position:0 -128px}.ui-icon-plus{background-position:-16px -128px}.ui-icon-plusthick{background-position:-32px -128px}.ui-icon-minus{background-position:-48px -128px}.ui-icon-minusthick{background-position:-64px -128px}.ui-icon-close{background-position:-80px -128px}.ui-icon-closethick{background-position:-96px -128px}.ui-icon-key{background-position:-112px -128px}.ui-icon-lightbulb{background-position:-128px -128px}.ui-icon-scissors{background-position:-144px -128px}.ui-icon-clipboard{background-position:-160px -128px}.ui-icon-copy{background-position:-176px -128px}.ui-icon-contact{background-position:-192px -128px}.ui-icon-image{background-position:-208px -128px}.ui-icon-video{background-position:-224px -128px}.ui-icon-script{background-position:-240px -128px}.ui-icon-alert{background-position:0 -144px}.ui-icon-info{background-position:-16px -144px}.ui-icon-notice{background-position:-32px -144px}.ui-icon-help{background-position:-48px -144px}.ui-icon-check{background-position:-64px -144px}.ui-icon-bullet{background-position:-80px -144px}.ui-icon-radio-on{background-position:-96px -144px}.ui-icon-radio-off{background-position:-112px -144px}.ui-icon-pin-w{background-position:-128px -144px}.ui-icon-pin-s{background-position:-144px -144px}.ui-icon-play{background-position:0 -160px}.ui-icon-pause{background-position:-16px -160px}.ui-icon-seek-next{background-position:-32px -160px}.ui-icon-seek-prev{background-position:-48px -160px}.ui-icon-seek-end{background-position:-64px -160px}.ui-icon-seek-first,.ui-icon-seek-start{background-position:-80px -160px}.ui-icon-stop{background-position:-96px -160px}.ui-icon-eject{background-position:-112px -160px}.ui-icon-volume-off{background-position:-128px -160px}.ui-icon-volume-on{background-position:-144px -160px}.ui-icon-power{background-position:0 -176px}.ui-icon-signal-diag{background-position:-16px -176px}.ui-icon-signal{background-position:-32px -176px}.ui-icon-battery-0{background-position:-48px -176px}.ui-icon-battery-1{background-position:-64px -176px}.ui-icon-battery-2{background-position:-80px -176px}.ui-icon-battery-3{background-position:-96px -176px}.ui-icon-circle-plus{background-position:0 -192px}.ui-icon-circle-minus{background-position:-16px -192px}.ui-icon-circle-close{background-position:-32px -192px}.ui-icon-circle-triangle-e{background-position:-48px -192px}.ui-icon-circle-triangle-s{background-position:-64px -192px}.ui-icon-circle-triangle-w{background-position:-80px -192px}.ui-icon-circle-triangle-n{background-position:-96px -192px}.ui-icon-circle-arrow-e{background-position:-112px -192px}.ui-icon-circle-arrow-s{background-position:-128px -192px}.ui-icon-circle-arrow-w{background-position:-144px -192px}.ui-icon-circle-arrow-n{background-position:-160px -192px}.ui-icon-circle-zoomin{background-position:-176px -192px}.ui-icon-circle-zoomout{background-position:-192px -192px}.ui-icon-circle-check{background-position:-208px -192px}.ui-icon-circlesmall-plus{background-position:0 -208px}.ui-icon-circlesmall-minus{background-position:-16px -208px}.ui-icon-circlesmall-close{background-position:-32px -208px}.ui-icon-squaresmall-plus{background-position:-48px -208px}.ui-icon-squaresmall-minus{background-position:-64px -208px}.ui-icon-squaresmall-close{background-position:-80px -208px}.ui-icon-grip-dotted-vertical{background-position:0 -224px}.ui-icon-grip-dotted-horizontal{background-position:-16px -224px}.ui-icon-grip-solid-vertical{background-position:-32px -224px}.ui-icon-grip-solid-horizontal{background-position:-48px -224px}.ui-icon-gripsmall-diagonal-se{background-position:-64px -224px}.ui-icon-grip-diagonal-se{background-position:-80px -224px}.ui-corner-all,.ui-corner-left,.ui-corner-tl,.ui-corner-top{border-top-left-radius:3px}.ui-corner-all,.ui-corner-right,.ui-corner-top,.ui-corner-tr{border-top-right-radius:3px}.ui-corner-all,.ui-corner-bl,.ui-corner-bottom,.ui-corner-left{border-bottom-left-radius:3px}.ui-corner-all,.ui-corner-bottom,.ui-corner-br,.ui-corner-right{border-bottom-right-radius:3px}.ui-widget-overlay{background:#aaa;opacity:.3;filter:Alpha(Opacity=30)}.ui-widget-shadow{-webkit-box-shadow:0 0 5px #666;box-shadow:0 0 5px #666}

================
File: css/jquery-ui.min.css
================
/*! jQuery UI - v1.12.1 - 2016-09-14
* http://jqueryui.com
* Includes: core.css, accordion.css, autocomplete.css, menu.css, button.css, controlgroup.css, checkboxradio.css, datepicker.css, dialog.css, draggable.css, resizable.css, progressbar.css, selectable.css, selectmenu.css, slider.css, sortable.css, spinner.css, tabs.css, tooltip.css, theme.css
* To view and modify this theme, visit http://jqueryui.com/themeroller/?ffDefault=Arial%2CHelvetica%2Csans-serif&fsDefault=1em&fwDefault=normal&cornerRadius=3px&bgColorHeader=e9e9e9&bgTextureHeader=flat&borderColorHeader=dddddd&fcHeader=333333&iconColorHeader=444444&bgColorContent=ffffff&bgTextureContent=flat&borderColorContent=dddddd&fcContent=333333&iconColorContent=444444&bgColorDefault=f6f6f6&bgTextureDefault=flat&borderColorDefault=c5c5c5&fcDefault=454545&iconColorDefault=777777&bgColorHover=ededed&bgTextureHover=flat&borderColorHover=cccccc&fcHover=2b2b2b&iconColorHover=555555&bgColorActive=007fff&bgTextureActive=flat&borderColorActive=003eff&fcActive=ffffff&iconColorActive=ffffff&bgColorHighlight=fffa90&bgTextureHighlight=flat&borderColorHighlight=dad55e&fcHighlight=777620&iconColorHighlight=777620&bgColorError=fddfdf&bgTextureError=flat&borderColorError=f1a899&fcError=5f3f3f&iconColorError=cc0000&bgColorOverlay=aaaaaa&bgTextureOverlay=flat&bgImgOpacityOverlay=0&opacityOverlay=30&bgColorShadow=666666&bgTextureShadow=flat&bgImgOpacityShadow=0&opacityShadow=30&thicknessShadow=5px&offsetTopShadow=0px&offsetLeftShadow=0px&cornerRadiusShadow=8px
* Copyright jQuery Foundation and other contributors; Licensed MIT */

/* Layout helpers
----------------------------------*/
.ui-helper-hidden {
	display: none;
}
.ui-helper-hidden-accessible {
	border: 0;
	clip: rect(0 0 0 0);
	height: 1px;
	margin: -1px;
	overflow: hidden;
	padding: 0;
	position: absolute;
	width: 1px;
}
.ui-helper-reset {
	margin: 0;
	padding: 0;
	border: 0;
	outline: 0;
	line-height: 1.3;
	text-decoration: none;
	font-size: 100%;
	list-style: none;
}
.ui-helper-clearfix:before,
.ui-helper-clearfix:after {
	content: "";
	display: table;
	border-collapse: collapse;
}
.ui-helper-clearfix:after {
	clear: both;
}
.ui-helper-zfix {
	width: 100%;
	height: 100%;
	top: 0;
	left: 0;
	position: absolute;
	opacity: 0;
	filter:Alpha(Opacity=0); /* support: IE8 */
}

.ui-front {
	z-index: 100;
}


/* Interaction Cues
----------------------------------*/
.ui-state-disabled {
	cursor: default !important;
	pointer-events: none;
}


/* Icons
----------------------------------*/
.ui-icon {
	display: inline-block;
	vertical-align: middle;
	margin-top: -.25em;
	position: relative;
	text-indent: -99999px;
	overflow: hidden;
	background-repeat: no-repeat;
}

.ui-widget-icon-block {
	left: 50%;
	margin-left: -8px;
	display: block;
}

/* Misc visuals
----------------------------------*/

/* Overlays */
.ui-widget-overlay {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
}
.ui-accordion .ui-accordion-header {
	display: block;
	cursor: pointer;
	position: relative;
	margin: 2px 0 0 0;
	padding: .5em .5em .5em .7em;
	font-size: 100%;
}
.ui-accordion .ui-accordion-content {
	padding: 1em 2.2em;
	border-top: 0;
	overflow: auto;
}
.ui-autocomplete {
	position: absolute;
	top: 0;
	left: 0;
	cursor: default;
}
.ui-menu {
	list-style: none;
	padding: 0;
	margin: 0;
	display: block;
	outline: 0;
}
.ui-menu .ui-menu {
	position: absolute;
}
.ui-menu .ui-menu-item {
	margin: 0;
	cursor: pointer;
	/* support: IE10, see #8844 */
	list-style-image: url("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7");
}
.ui-menu .ui-menu-item-wrapper {
	position: relative;
	padding: 3px 1em 3px .4em;
}
.ui-menu .ui-menu-divider {
	margin: 5px 0;
	height: 0;
	font-size: 0;
	line-height: 0;
	border-width: 1px 0 0 0;
}
.ui-menu .ui-state-focus,
.ui-menu .ui-state-active {
	margin: -1px;
}

/* icon support */
.ui-menu-icons {
	position: relative;
}
.ui-menu-icons .ui-menu-item-wrapper {
	padding-left: 2em;
}

/* left-aligned */
.ui-menu .ui-icon {
	position: absolute;
	top: 0;
	bottom: 0;
	left: .2em;
	margin: auto 0;
}

/* right-aligned */
.ui-menu .ui-menu-icon {
	left: auto;
	right: 0;
}
.ui-button {
	padding: .4em 1em;
	display: inline-block;
	position: relative;
	line-height: normal;
	margin-right: .1em;
	cursor: pointer;
	vertical-align: middle;
	text-align: center;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;

	/* Support: IE <= 11 */
	overflow: visible;
}

.ui-button,
.ui-button:link,
.ui-button:visited,
.ui-button:hover,
.ui-button:active {
	text-decoration: none;
}

/* to make room for the icon, a width needs to be set here */
.ui-button-icon-only {
	width: 2em;
	box-sizing: border-box;
	text-indent: -9999px;
	white-space: nowrap;
}

/* no icon support for input elements */
input.ui-button.ui-button-icon-only {
	text-indent: 0;
}

/* button icon element(s) */
.ui-button-icon-only .ui-icon {
	position: absolute;
	top: 50%;
	left: 50%;
	margin-top: -8px;
	margin-left: -8px;
}

.ui-button.ui-icon-notext .ui-icon {
	padding: 0;
	width: 2.1em;
	height: 2.1em;
	text-indent: -9999px;
	white-space: nowrap;

}

input.ui-button.ui-icon-notext .ui-icon {
	width: auto;
	height: auto;
	text-indent: 0;
	white-space: normal;
	padding: .4em 1em;
}

/* workarounds */
/* Support: Firefox 5 - 40 */
input.ui-button::-moz-focus-inner,
button.ui-button::-moz-focus-inner {
	border: 0;
	padding: 0;
}
.ui-controlgroup {
	vertical-align: middle;
	display: inline-block;
}
.ui-controlgroup > .ui-controlgroup-item {
	float: left;
	margin-left: 0;
	margin-right: 0;
}
.ui-controlgroup > .ui-controlgroup-item:focus,
.ui-controlgroup > .ui-controlgroup-item.ui-visual-focus {
	z-index: 9999;
}
.ui-controlgroup-vertical > .ui-controlgroup-item {
	display: block;
	float: none;
	width: 100%;
	margin-top: 0;
	margin-bottom: 0;
	text-align: left;
}
.ui-controlgroup-vertical .ui-controlgroup-item {
	box-sizing: border-box;
}
.ui-controlgroup .ui-controlgroup-label {
	padding: .4em 1em;
}
.ui-controlgroup .ui-controlgroup-label span {
	font-size: 80%;
}
.ui-controlgroup-horizontal .ui-controlgroup-label + .ui-controlgroup-item {
	border-left: none;
}
.ui-controlgroup-vertical .ui-controlgroup-label + .ui-controlgroup-item {
	border-top: none;
}
.ui-controlgroup-horizontal .ui-controlgroup-label.ui-widget-content {
	border-right: none;
}
.ui-controlgroup-vertical .ui-controlgroup-label.ui-widget-content {
	border-bottom: none;
}

/* Spinner specific style fixes */
.ui-controlgroup-vertical .ui-spinner-input {

	/* Support: IE8 only, Android < 4.4 only */
	width: 75%;
	width: calc( 100% - 2.4em );
}
.ui-controlgroup-vertical .ui-spinner .ui-spinner-up {
	border-top-style: solid;
}

.ui-checkboxradio-label .ui-icon-background {
	box-shadow: inset 1px 1px 1px #ccc;
	border-radius: .12em;
	border: none;
}
.ui-checkboxradio-radio-label .ui-icon-background {
	width: 16px;
	height: 16px;
	border-radius: 1em;
	overflow: visible;
	border: none;
}
.ui-checkboxradio-radio-label.ui-checkboxradio-checked .ui-icon,
.ui-checkboxradio-radio-label.ui-checkboxradio-checked:hover .ui-icon {
	background-image: none;
	width: 8px;
	height: 8px;
	border-width: 4px;
	border-style: solid;
}
.ui-checkboxradio-disabled {
	pointer-events: none;
}
.ui-datepicker {
	width: 17em;
	padding: .2em .2em 0;
	display: none;
}
.ui-datepicker .ui-datepicker-header {
	position: relative;
	padding: .2em 0;
}
.ui-datepicker .ui-datepicker-prev,
.ui-datepicker .ui-datepicker-next {
	position: absolute;
	top: 2px;
	width: 1.8em;
	height: 1.8em;
}
.ui-datepicker .ui-datepicker-prev-hover,
.ui-datepicker .ui-datepicker-next-hover {
	top: 1px;
}
.ui-datepicker .ui-datepicker-prev {
	left: 2px;
}
.ui-datepicker .ui-datepicker-next {
	right: 2px;
}
.ui-datepicker .ui-datepicker-prev-hover {
	left: 1px;
}
.ui-datepicker .ui-datepicker-next-hover {
	right: 1px;
}
.ui-datepicker .ui-datepicker-prev span,
.ui-datepicker .ui-datepicker-next span {
	display: block;
	position: absolute;
	left: 50%;
	margin-left: -8px;
	top: 50%;
	margin-top: -8px;
}
.ui-datepicker .ui-datepicker-title {
	margin: 0 2.3em;
	line-height: 1.8em;
	text-align: center;
}
.ui-datepicker .ui-datepicker-title select {
	font-size: 1em;
	margin: 1px 0;
}
.ui-datepicker select.ui-datepicker-month,
.ui-datepicker select.ui-datepicker-year {
	width: 45%;
}
.ui-datepicker table {
	width: 100%;
	font-size: .9em;
	border-collapse: collapse;
	margin: 0 0 .4em;
}
.ui-datepicker th {
	padding: .7em .3em;
	text-align: center;
	font-weight: bold;
	border: 0;
}
.ui-datepicker td {
	border: 0;
	padding: 1px;
}
.ui-datepicker td span,
.ui-datepicker td a {
	display: block;
	padding: .2em;
	text-align: right;
	text-decoration: none;
}
.ui-datepicker .ui-datepicker-buttonpane {
	background-image: none;
	margin: .7em 0 0 0;
	padding: 0 .2em;
	border-left: 0;
	border-right: 0;
	border-bottom: 0;
}
.ui-datepicker .ui-datepicker-buttonpane button {
	float: right;
	margin: .5em .2em .4em;
	cursor: pointer;
	padding: .2em .6em .3em .6em;
	width: auto;
	overflow: visible;
}
.ui-datepicker .ui-datepicker-buttonpane button.ui-datepicker-current {
	float: left;
}

/* with multiple calendars */
.ui-datepicker.ui-datepicker-multi {
	width: auto;
}
.ui-datepicker-multi .ui-datepicker-group {
	float: left;
}
.ui-datepicker-multi .ui-datepicker-group table {
	width: 95%;
	margin: 0 auto .4em;
}
.ui-datepicker-multi-2 .ui-datepicker-group {
	width: 50%;
}
.ui-datepicker-multi-3 .ui-datepicker-group {
	width: 33.3%;
}
.ui-datepicker-multi-4 .ui-datepicker-group {
	width: 25%;
}
.ui-datepicker-multi .ui-datepicker-group-last .ui-datepicker-header,
.ui-datepicker-multi .ui-datepicker-group-middle .ui-datepicker-header {
	border-left-width: 0;
}
.ui-datepicker-multi .ui-datepicker-buttonpane {
	clear: left;
}
.ui-datepicker-row-break {
	clear: both;
	width: 100%;
	font-size: 0;
}

/* RTL support */
.ui-datepicker-rtl {
	direction: rtl;
}
.ui-datepicker-rtl .ui-datepicker-prev {
	right: 2px;
	left: auto;
}
.ui-datepicker-rtl .ui-datepicker-next {
	left: 2px;
	right: auto;
}
.ui-datepicker-rtl .ui-datepicker-prev:hover {
	right: 1px;
	left: auto;
}
.ui-datepicker-rtl .ui-datepicker-next:hover {
	left: 1px;
	right: auto;
}
.ui-datepicker-rtl .ui-datepicker-buttonpane {
	clear: right;
}
.ui-datepicker-rtl .ui-datepicker-buttonpane button {
	float: left;
}
.ui-datepicker-rtl .ui-datepicker-buttonpane button.ui-datepicker-current,
.ui-datepicker-rtl .ui-datepicker-group {
	float: right;
}
.ui-datepicker-rtl .ui-datepicker-group-last .ui-datepicker-header,
.ui-datepicker-rtl .ui-datepicker-group-middle .ui-datepicker-header {
	border-right-width: 0;
	border-left-width: 1px;
}

/* Icons */
.ui-datepicker .ui-icon {
	display: block;
	text-indent: -99999px;
	overflow: hidden;
	background-repeat: no-repeat;
	left: .5em;
	top: .3em;
}
.ui-dialog {
	position: absolute;
	top: 0;
	left: 0;
	padding: .2em;
	outline: 0;
}
.ui-dialog .ui-dialog-titlebar {
	padding: .4em 1em;
	position: relative;
}
.ui-dialog .ui-dialog-title {
	float: left;
	margin: .1em 0;
	white-space: nowrap;
	width: 90%;
	overflow: hidden;
	text-overflow: ellipsis;
}
.ui-dialog .ui-dialog-titlebar-close {
	position: absolute;
	right: .3em;
	top: 50%;
	width: 20px;
	margin: -10px 0 0 0;
	padding: 1px;
	height: 20px;
}
.ui-dialog .ui-dialog-content {
	position: relative;
	border: 0;
	padding: .5em 1em;
	background: none;
	overflow: auto;
}
.ui-dialog .ui-dialog-buttonpane {
	text-align: left;
	border-width: 1px 0 0 0;
	background-image: none;
	margin-top: .5em;
	padding: .3em 1em .5em .4em;
}
.ui-dialog .ui-dialog-buttonpane .ui-dialog-buttonset {
	float: right;
}
.ui-dialog .ui-dialog-buttonpane button {
	margin: .5em .4em .5em 0;
	cursor: pointer;
}
.ui-dialog .ui-resizable-n {
	height: 2px;
	top: 0;
}
.ui-dialog .ui-resizable-e {
	width: 2px;
	right: 0;
}
.ui-dialog .ui-resizable-s {
	height: 2px;
	bottom: 0;
}
.ui-dialog .ui-resizable-w {
	width: 2px;
	left: 0;
}
.ui-dialog .ui-resizable-se,
.ui-dialog .ui-resizable-sw,
.ui-dialog .ui-resizable-ne,
.ui-dialog .ui-resizable-nw {
	width: 7px;
	height: 7px;
}
.ui-dialog .ui-resizable-se {
	right: 0;
	bottom: 0;
}
.ui-dialog .ui-resizable-sw {
	left: 0;
	bottom: 0;
}
.ui-dialog .ui-resizable-ne {
	right: 0;
	top: 0;
}
.ui-dialog .ui-resizable-nw {
	left: 0;
	top: 0;
}
.ui-draggable .ui-dialog-titlebar {
	cursor: move;
}
.ui-draggable-handle {
	-ms-touch-action: none;
	touch-action: none;
}
.ui-resizable {
	position: relative;
}
.ui-resizable-handle {
	position: absolute;
	font-size: 0.1px;
	display: block;
	-ms-touch-action: none;
	touch-action: none;
}
.ui-resizable-disabled .ui-resizable-handle,
.ui-resizable-autohide .ui-resizable-handle {
	display: none;
}
.ui-resizable-n {
	cursor: n-resize;
	height: 7px;
	width: 100%;
	top: -5px;
	left: 0;
}
.ui-resizable-s {
	cursor: s-resize;
	height: 7px;
	width: 100%;
	bottom: -5px;
	left: 0;
}
.ui-resizable-e {
	cursor: e-resize;
	width: 7px;
	right: -5px;
	top: 0;
	height: 100%;
}
.ui-resizable-w {
	cursor: w-resize;
	width: 7px;
	left: -5px;
	top: 0;
	height: 100%;
}
.ui-resizable-se {
	cursor: se-resize;
	width: 12px;
	height: 12px;
	right: 1px;
	bottom: 1px;
}
.ui-resizable-sw {
	cursor: sw-resize;
	width: 9px;
	height: 9px;
	left: -5px;
	bottom: -5px;
}
.ui-resizable-nw {
	cursor: nw-resize;
	width: 9px;
	height: 9px;
	left: -5px;
	top: -5px;
}
.ui-resizable-ne {
	cursor: ne-resize;
	width: 9px;
	height: 9px;
	right: -5px;
	top: -5px;
}
.ui-progressbar {
	height: 2em;
	text-align: left;
	overflow: hidden;
}
.ui-progressbar .ui-progressbar-value {
	margin: -1px;
	height: 100%;
}
.ui-progressbar .ui-progressbar-overlay {
	background: url("data:image/gif;base64,R0lGODlhKAAoAIABAAAAAP///yH/C05FVFNDQVBFMi4wAwEAAAAh+QQJAQABACwAAAAAKAAoAAACkYwNqXrdC52DS06a7MFZI+4FHBCKoDeWKXqymPqGqxvJrXZbMx7Ttc+w9XgU2FB3lOyQRWET2IFGiU9m1frDVpxZZc6bfHwv4c1YXP6k1Vdy292Fb6UkuvFtXpvWSzA+HycXJHUXiGYIiMg2R6W459gnWGfHNdjIqDWVqemH2ekpObkpOlppWUqZiqr6edqqWQAAIfkECQEAAQAsAAAAACgAKAAAApSMgZnGfaqcg1E2uuzDmmHUBR8Qil95hiPKqWn3aqtLsS18y7G1SzNeowWBENtQd+T1JktP05nzPTdJZlR6vUxNWWjV+vUWhWNkWFwxl9VpZRedYcflIOLafaa28XdsH/ynlcc1uPVDZxQIR0K25+cICCmoqCe5mGhZOfeYSUh5yJcJyrkZWWpaR8doJ2o4NYq62lAAACH5BAkBAAEALAAAAAAoACgAAAKVDI4Yy22ZnINRNqosw0Bv7i1gyHUkFj7oSaWlu3ovC8GxNso5fluz3qLVhBVeT/Lz7ZTHyxL5dDalQWPVOsQWtRnuwXaFTj9jVVh8pma9JjZ4zYSj5ZOyma7uuolffh+IR5aW97cHuBUXKGKXlKjn+DiHWMcYJah4N0lYCMlJOXipGRr5qdgoSTrqWSq6WFl2ypoaUAAAIfkECQEAAQAsAAAAACgAKAAAApaEb6HLgd/iO7FNWtcFWe+ufODGjRfoiJ2akShbueb0wtI50zm02pbvwfWEMWBQ1zKGlLIhskiEPm9R6vRXxV4ZzWT2yHOGpWMyorblKlNp8HmHEb/lCXjcW7bmtXP8Xt229OVWR1fod2eWqNfHuMjXCPkIGNileOiImVmCOEmoSfn3yXlJWmoHGhqp6ilYuWYpmTqKUgAAIfkECQEAAQAsAAAAACgAKAAAApiEH6kb58biQ3FNWtMFWW3eNVcojuFGfqnZqSebuS06w5V80/X02pKe8zFwP6EFWOT1lDFk8rGERh1TTNOocQ61Hm4Xm2VexUHpzjymViHrFbiELsefVrn6XKfnt2Q9G/+Xdie499XHd2g4h7ioOGhXGJboGAnXSBnoBwKYyfioubZJ2Hn0RuRZaflZOil56Zp6iioKSXpUAAAh+QQJAQABACwAAAAAKAAoAAACkoQRqRvnxuI7kU1a1UU5bd5tnSeOZXhmn5lWK3qNTWvRdQxP8qvaC+/yaYQzXO7BMvaUEmJRd3TsiMAgswmNYrSgZdYrTX6tSHGZO73ezuAw2uxuQ+BbeZfMxsexY35+/Qe4J1inV0g4x3WHuMhIl2jXOKT2Q+VU5fgoSUI52VfZyfkJGkha6jmY+aaYdirq+lQAACH5BAkBAAEALAAAAAAoACgAAAKWBIKpYe0L3YNKToqswUlvznigd4wiR4KhZrKt9Upqip61i9E3vMvxRdHlbEFiEXfk9YARYxOZZD6VQ2pUunBmtRXo1Lf8hMVVcNl8JafV38aM2/Fu5V16Bn63r6xt97j09+MXSFi4BniGFae3hzbH9+hYBzkpuUh5aZmHuanZOZgIuvbGiNeomCnaxxap2upaCZsq+1kAACH5BAkBAAEALAAAAAAoACgAAAKXjI8By5zf4kOxTVrXNVlv1X0d8IGZGKLnNpYtm8Lr9cqVeuOSvfOW79D9aDHizNhDJidFZhNydEahOaDH6nomtJjp1tutKoNWkvA6JqfRVLHU/QUfau9l2x7G54d1fl995xcIGAdXqMfBNadoYrhH+Mg2KBlpVpbluCiXmMnZ2Sh4GBqJ+ckIOqqJ6LmKSllZmsoq6wpQAAAh+QQJAQABACwAAAAAKAAoAAAClYx/oLvoxuJDkU1a1YUZbJ59nSd2ZXhWqbRa2/gF8Gu2DY3iqs7yrq+xBYEkYvFSM8aSSObE+ZgRl1BHFZNr7pRCavZ5BW2142hY3AN/zWtsmf12p9XxxFl2lpLn1rseztfXZjdIWIf2s5dItwjYKBgo9yg5pHgzJXTEeGlZuenpyPmpGQoKOWkYmSpaSnqKileI2FAAACH5BAkBAAEALAAAAAAoACgAAAKVjB+gu+jG4kORTVrVhRlsnn2dJ3ZleFaptFrb+CXmO9OozeL5VfP99HvAWhpiUdcwkpBH3825AwYdU8xTqlLGhtCosArKMpvfa1mMRae9VvWZfeB2XfPkeLmm18lUcBj+p5dnN8jXZ3YIGEhYuOUn45aoCDkp16hl5IjYJvjWKcnoGQpqyPlpOhr3aElaqrq56Bq7VAAAOw==");
	height: 100%;
	filter: alpha(opacity=25); /* support: IE8 */
	opacity: 0.25;
}
.ui-progressbar-indeterminate .ui-progressbar-value {
	background-image: none;
}
.ui-selectable {
	-ms-touch-action: none;
	touch-action: none;
}
.ui-selectable-helper {
	position: absolute;
	z-index: 100;
	border: 1px dotted black;
}
.ui-selectmenu-menu {
	padding: 0;
	margin: 0;
	position: absolute;
	top: 0;
	left: 0;
	display: none;
}
.ui-selectmenu-menu .ui-menu {
	overflow: auto;
	overflow-x: hidden;
	padding-bottom: 1px;
}
.ui-selectmenu-menu .ui-menu .ui-selectmenu-optgroup {
	font-size: 1em;
	font-weight: bold;
	line-height: 1.5;
	padding: 2px 0.4em;
	margin: 0.5em 0 0 0;
	height: auto;
	border: 0;
}
.ui-selectmenu-open {
	display: block;
}
.ui-selectmenu-text {
	display: block;
	margin-right: 20px;
	overflow: hidden;
	text-overflow: ellipsis;
}
.ui-selectmenu-button.ui-button {
	text-align: left;
	white-space: nowrap;
	width: 14em;
}
.ui-selectmenu-icon.ui-icon {
	float: right;
	margin-top: 0;
}
.ui-slider {
	position: relative;
	text-align: left;
}
.ui-slider .ui-slider-handle {
	position: absolute;
	z-index: 2;
	width: 1.2em;
	height: 1.2em;
	cursor: default;
	-ms-touch-action: none;
	touch-action: none;
}
.ui-slider .ui-slider-range {
	position: absolute;
	z-index: 1;
	font-size: .7em;
	display: block;
	border: 0;
	background-position: 0 0;
}

/* support: IE8 - See #6727 */
.ui-slider.ui-state-disabled .ui-slider-handle,
.ui-slider.ui-state-disabled .ui-slider-range {
	filter: inherit;
}

.ui-slider-horizontal {
	height: .8em;
}
.ui-slider-horizontal .ui-slider-handle {
	top: -.3em;
	margin-left: -.6em;
}
.ui-slider-horizontal .ui-slider-range {
	top: 0;
	height: 100%;
}
.ui-slider-horizontal .ui-slider-range-min {
	left: 0;
}
.ui-slider-horizontal .ui-slider-range-max {
	right: 0;
}

.ui-slider-vertical {
	width: .8em;
	height: 100px;
}
.ui-slider-vertical .ui-slider-handle {
	left: -.3em;
	margin-left: 0;
	margin-bottom: -.6em;
}
.ui-slider-vertical .ui-slider-range {
	left: 0;
	width: 100%;
}
.ui-slider-vertical .ui-slider-range-min {
	bottom: 0;
}
.ui-slider-vertical .ui-slider-range-max {
	top: 0;
}
.ui-sortable-handle {
	-ms-touch-action: none;
	touch-action: none;
}
.ui-spinner {
	position: relative;
	display: inline-block;
	overflow: hidden;
	padding: 0;
	vertical-align: middle;
}
.ui-spinner-input {
	border: none;
	background: none;
	color: inherit;
	padding: .222em 0;
	margin: .2em 0;
	vertical-align: middle;
	margin-left: .4em;
	margin-right: 2em;
}
.ui-spinner-button {
	width: 1.6em;
	height: 50%;
	font-size: .5em;
	padding: 0;
	margin: 0;
	text-align: center;
	position: absolute;
	cursor: default;
	display: block;
	overflow: hidden;
	right: 0;
}
/* more specificity required here to override default borders */
.ui-spinner a.ui-spinner-button {
	border-top-style: none;
	border-bottom-style: none;
	border-right-style: none;
}
.ui-spinner-up {
	top: 0;
}
.ui-spinner-down {
	bottom: 0;
}
.ui-tabs {
	position: relative;/* position: relative prevents IE scroll bug (element with position: relative inside container with overflow: auto appear as "fixed") */
	padding: .2em;
}
.ui-tabs .ui-tabs-nav {
	margin: 0;
	padding: .2em .2em 0;
}
.ui-tabs .ui-tabs-nav li {
	list-style: none;
	float: left;
	position: relative;
	top: 0;
	margin: 1px .2em 0 0;
	border-bottom-width: 0;
	padding: 0;
	white-space: nowrap;
}
.ui-tabs .ui-tabs-nav .ui-tabs-anchor {
	float: left;
	padding: .5em 1em;
	text-decoration: none;
}
.ui-tabs .ui-tabs-nav li.ui-tabs-active {
	margin-bottom: -1px;
	padding-bottom: 1px;
}
.ui-tabs .ui-tabs-nav li.ui-tabs-active .ui-tabs-anchor,
.ui-tabs .ui-tabs-nav li.ui-state-disabled .ui-tabs-anchor,
.ui-tabs .ui-tabs-nav li.ui-tabs-loading .ui-tabs-anchor {
	cursor: text;
}
.ui-tabs-collapsible .ui-tabs-nav li.ui-tabs-active .ui-tabs-anchor {
	cursor: pointer;
}
.ui-tabs .ui-tabs-panel {
	display: block;
	border-width: 0;
	padding: 1em 1.4em;
	background: none;
}
.ui-tooltip {
	padding: 8px;
	position: absolute;
	z-index: 9999;
	max-width: 300px;
}
body .ui-tooltip {
	border-width: 2px;
}
/* Component containers
----------------------------------*/
.ui-widget {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 1em;
}
.ui-widget .ui-widget {
	font-size: 1em;
}
.ui-widget input,
.ui-widget select,
.ui-widget textarea,
.ui-widget button {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 1em;
}
.ui-widget.ui-widget-content {
	border: 1px solid #c5c5c5;
}
.ui-widget-content {
	border: 1px solid #dddddd;
	background: #ffffff;
	color: #333333;
}
.ui-widget-content a {
	color: #333333;
}
.ui-widget-header {
	border: 1px solid #dddddd;
	background: #e9e9e9;
	color: #333333;
	font-weight: bold;
}
.ui-widget-header a {
	color: #333333;
}

/* Interaction states
----------------------------------*/
.ui-state-default,
.ui-widget-content .ui-state-default,
.ui-widget-header .ui-state-default,
.ui-button,

/* We use html here because we need a greater specificity to make sure disabled
works properly when clicked or hovered */
html .ui-button.ui-state-disabled:hover,
html .ui-button.ui-state-disabled:active {
	border: 1px solid #c5c5c5;
	background: #f6f6f6;
	font-weight: normal;
	color: #454545;
}
.ui-state-default a,
.ui-state-default a:link,
.ui-state-default a:visited,
a.ui-button,
a:link.ui-button,
a:visited.ui-button,
.ui-button {
	color: #454545;
	text-decoration: none;
}
.ui-state-hover,
.ui-widget-content .ui-state-hover,
.ui-widget-header .ui-state-hover,
.ui-state-focus,
.ui-widget-content .ui-state-focus,
.ui-widget-header .ui-state-focus,
.ui-button:hover,
.ui-button:focus {
	border: 1px solid #cccccc;
	background: #ededed;
	font-weight: normal;
	color: #2b2b2b;
}
.ui-state-hover a,
.ui-state-hover a:hover,
.ui-state-hover a:link,
.ui-state-hover a:visited,
.ui-state-focus a,
.ui-state-focus a:hover,
.ui-state-focus a:link,
.ui-state-focus a:visited,
a.ui-button:hover,
a.ui-button:focus {
	color: #2b2b2b;
	text-decoration: none;
}

.ui-visual-focus {
	box-shadow: 0 0 3px 1px rgb(94, 158, 214);
}
.ui-state-active,
.ui-widget-content .ui-state-active,
.ui-widget-header .ui-state-active,
a.ui-button:active,
.ui-button:active,
.ui-button.ui-state-active:hover {
	border: 1px solid #003eff;
	background: #007fff;
	font-weight: normal;
	color: #ffffff;
}
.ui-icon-background,
.ui-state-active .ui-icon-background {
	border: #003eff;
	background-color: #ffffff;
}
.ui-state-active a,
.ui-state-active a:link,
.ui-state-active a:visited {
	color: #ffffff;
	text-decoration: none;
}

/* Interaction Cues
----------------------------------*/
.ui-state-highlight,
.ui-widget-content .ui-state-highlight,
.ui-widget-header .ui-state-highlight {
	border: 1px solid #dad55e;
	background: #fffa90;
	color: #777620;
}
.ui-state-checked {
	border: 1px solid #dad55e;
	background: #fffa90;
}
.ui-state-highlight a,
.ui-widget-content .ui-state-highlight a,
.ui-widget-header .ui-state-highlight a {
	color: #777620;
}
.ui-state-error,
.ui-widget-content .ui-state-error,
.ui-widget-header .ui-state-error {
	border: 1px solid #f1a899;
	background: #fddfdf;
	color: #5f3f3f;
}
.ui-state-error a,
.ui-widget-content .ui-state-error a,
.ui-widget-header .ui-state-error a {
	color: #5f3f3f;
}
.ui-state-error-text,
.ui-widget-content .ui-state-error-text,
.ui-widget-header .ui-state-error-text {
	color: #5f3f3f;
}
.ui-priority-primary,
.ui-widget-content .ui-priority-primary,
.ui-widget-header .ui-priority-primary {
	font-weight: bold;
}
.ui-priority-secondary,
.ui-widget-content .ui-priority-secondary,
.ui-widget-header .ui-priority-secondary {
	opacity: .7;
	filter:Alpha(Opacity=70); /* support: IE8 */
	font-weight: normal;
}
.ui-state-disabled,
.ui-widget-content .ui-state-disabled,
.ui-widget-header .ui-state-disabled {
	opacity: .35;
	filter:Alpha(Opacity=35); /* support: IE8 */
	background-image: none;
}
.ui-state-disabled .ui-icon {
	filter:Alpha(Opacity=35); /* support: IE8 - See #6059 */
}

/* Icons
----------------------------------*/

/* states and images */
.ui-icon {
	width: 16px;
	height: 16px;
}
.ui-icon,
.ui-widget-content .ui-icon {
	background-image: url("images/ui-icons_444444_256x240.png");
}
.ui-widget-header .ui-icon {
	background-image: url("images/ui-icons_444444_256x240.png");
}
.ui-state-hover .ui-icon,
.ui-state-focus .ui-icon,
.ui-button:hover .ui-icon,
.ui-button:focus .ui-icon {
	background-image: url("images/ui-icons_555555_256x240.png");
}
.ui-state-active .ui-icon,
.ui-button:active .ui-icon {
	background-image: url("images/ui-icons_ffffff_256x240.png");
}
.ui-state-highlight .ui-icon,
.ui-button .ui-state-highlight.ui-icon {
	background-image: url("images/ui-icons_777620_256x240.png");
}
.ui-state-error .ui-icon,
.ui-state-error-text .ui-icon {
	background-image: url("images/ui-icons_cc0000_256x240.png");
}
.ui-button .ui-icon {
	background-image: url("images/ui-icons_777777_256x240.png");
}

/* positioning */
.ui-icon-blank { background-position: 16px 16px; }
.ui-icon-caret-1-n { background-position: 0 0; }
.ui-icon-caret-1-ne { background-position: -16px 0; }
.ui-icon-caret-1-e { background-position: -32px 0; }
.ui-icon-caret-1-se { background-position: -48px 0; }
.ui-icon-caret-1-s { background-position: -65px 0; }
.ui-icon-caret-1-sw { background-position: -80px 0; }
.ui-icon-caret-1-w { background-position: -96px 0; }
.ui-icon-caret-1-nw { background-position: -112px 0; }
.ui-icon-caret-2-n-s { background-position: -128px 0; }
.ui-icon-caret-2-e-w { background-position: -144px 0; }
.ui-icon-triangle-1-n { background-position: 0 -16px; }
.ui-icon-triangle-1-ne { background-position: -16px -16px; }
.ui-icon-triangle-1-e { background-position: -32px -16px; }
.ui-icon-triangle-1-se { background-position: -48px -16px; }
.ui-icon-triangle-1-s { background-position: -65px -16px; }
.ui-icon-triangle-1-sw { background-position: -80px -16px; }
.ui-icon-triangle-1-w { background-position: -96px -16px; }
.ui-icon-triangle-1-nw { background-position: -112px -16px; }
.ui-icon-triangle-2-n-s { background-position: -128px -16px; }
.ui-icon-triangle-2-e-w { background-position: -144px -16px; }
.ui-icon-arrow-1-n { background-position: 0 -32px; }
.ui-icon-arrow-1-ne { background-position: -16px -32px; }
.ui-icon-arrow-1-e { background-position: -32px -32px; }
.ui-icon-arrow-1-se { background-position: -48px -32px; }
.ui-icon-arrow-1-s { background-position: -65px -32px; }
.ui-icon-arrow-1-sw { background-position: -80px -32px; }
.ui-icon-arrow-1-w { background-position: -96px -32px; }
.ui-icon-arrow-1-nw { background-position: -112px -32px; }
.ui-icon-arrow-2-n-s { background-position: -128px -32px; }
.ui-icon-arrow-2-ne-sw { background-position: -144px -32px; }
.ui-icon-arrow-2-e-w { background-position: -160px -32px; }
.ui-icon-arrow-2-se-nw { background-position: -176px -32px; }
.ui-icon-arrowstop-1-n { background-position: -192px -32px; }
.ui-icon-arrowstop-1-e { background-position: -208px -32px; }
.ui-icon-arrowstop-1-s { background-position: -224px -32px; }
.ui-icon-arrowstop-1-w { background-position: -240px -32px; }
.ui-icon-arrowthick-1-n { background-position: 1px -48px; }
.ui-icon-arrowthick-1-ne { background-position: -16px -48px; }
.ui-icon-arrowthick-1-e { background-position: -32px -48px; }
.ui-icon-arrowthick-1-se { background-position: -48px -48px; }
.ui-icon-arrowthick-1-s { background-position: -64px -48px; }
.ui-icon-arrowthick-1-sw { background-position: -80px -48px; }
.ui-icon-arrowthick-1-w { background-position: -96px -48px; }
.ui-icon-arrowthick-1-nw { background-position: -112px -48px; }
.ui-icon-arrowthick-2-n-s { background-position: -128px -48px; }
.ui-icon-arrowthick-2-ne-sw { background-position: -144px -48px; }
.ui-icon-arrowthick-2-e-w { background-position: -160px -48px; }
.ui-icon-arrowthick-2-se-nw { background-position: -176px -48px; }
.ui-icon-arrowthickstop-1-n { background-position: -192px -48px; }
.ui-icon-arrowthickstop-1-e { background-position: -208px -48px; }
.ui-icon-arrowthickstop-1-s { background-position: -224px -48px; }
.ui-icon-arrowthickstop-1-w { background-position: -240px -48px; }
.ui-icon-arrowreturnthick-1-w { background-position: 0 -64px; }
.ui-icon-arrowreturnthick-1-n { background-position: -16px -64px; }
.ui-icon-arrowreturnthick-1-e { background-position: -32px -64px; }
.ui-icon-arrowreturnthick-1-s { background-position: -48px -64px; }
.ui-icon-arrowreturn-1-w { background-position: -64px -64px; }
.ui-icon-arrowreturn-1-n { background-position: -80px -64px; }
.ui-icon-arrowreturn-1-e { background-position: -96px -64px; }
.ui-icon-arrowreturn-1-s { background-position: -112px -64px; }
.ui-icon-arrowrefresh-1-w { background-position: -128px -64px; }
.ui-icon-arrowrefresh-1-n { background-position: -144px -64px; }
.ui-icon-arrowrefresh-1-e { background-position: -160px -64px; }
.ui-icon-arrowrefresh-1-s { background-position: -176px -64px; }
.ui-icon-arrow-4 { background-position: 0 -80px; }
.ui-icon-arrow-4-diag { background-position: -16px -80px; }
.ui-icon-extlink { background-position: -32px -80px; }
.ui-icon-newwin { background-position: -48px -80px; }
.ui-icon-refresh { background-position: -64px -80px; }
.ui-icon-shuffle { background-position: -80px -80px; }
.ui-icon-transfer-e-w { background-position: -96px -80px; }
.ui-icon-transferthick-e-w { background-position: -112px -80px; }
.ui-icon-folder-collapsed { background-position: 0 -96px; }
.ui-icon-folder-open { background-position: -16px -96px; }
.ui-icon-document { background-position: -32px -96px; }
.ui-icon-document-b { background-position: -48px -96px; }
.ui-icon-note { background-position: -64px -96px; }
.ui-icon-mail-closed { background-position: -80px -96px; }
.ui-icon-mail-open { background-position: -96px -96px; }
.ui-icon-suitcase { background-position: -112px -96px; }
.ui-icon-comment { background-position: -128px -96px; }
.ui-icon-person { background-position: -144px -96px; }
.ui-icon-print { background-position: -160px -96px; }
.ui-icon-trash { background-position: -176px -96px; }
.ui-icon-locked { background-position: -192px -96px; }
.ui-icon-unlocked { background-position: -208px -96px; }
.ui-icon-bookmark { background-position: -224px -96px; }
.ui-icon-tag { background-position: -240px -96px; }
.ui-icon-home { background-position: 0 -112px; }
.ui-icon-flag { background-position: -16px -112px; }
.ui-icon-calendar { background-position: -32px -112px; }
.ui-icon-cart { background-position: -48px -112px; }
.ui-icon-pencil { background-position: -64px -112px; }
.ui-icon-clock { background-position: -80px -112px; }
.ui-icon-disk { background-position: -96px -112px; }
.ui-icon-calculator { background-position: -112px -112px; }
.ui-icon-zoomin { background-position: -128px -112px; }
.ui-icon-zoomout { background-position: -144px -112px; }
.ui-icon-search { background-position: -160px -112px; }
.ui-icon-wrench { background-position: -176px -112px; }
.ui-icon-gear { background-position: -192px -112px; }
.ui-icon-heart { background-position: -208px -112px; }
.ui-icon-star { background-position: -224px -112px; }
.ui-icon-link { background-position: -240px -112px; }
.ui-icon-cancel { background-position: 0 -128px; }
.ui-icon-plus { background-position: -16px -128px; }
.ui-icon-plusthick { background-position: -32px -128px; }
.ui-icon-minus { background-position: -48px -128px; }
.ui-icon-minusthick { background-position: -64px -128px; }
.ui-icon-close { background-position: -80px -128px; }
.ui-icon-closethick { background-position: -96px -128px; }
.ui-icon-key { background-position: -112px -128px; }
.ui-icon-lightbulb { background-position: -128px -128px; }
.ui-icon-scissors { background-position: -144px -128px; }
.ui-icon-clipboard { background-position: -160px -128px; }
.ui-icon-copy { background-position: -176px -128px; }
.ui-icon-contact { background-position: -192px -128px; }
.ui-icon-image { background-position: -208px -128px; }
.ui-icon-video { background-position: -224px -128px; }
.ui-icon-script { background-position: -240px -128px; }
.ui-icon-alert { background-position: 0 -144px; }
.ui-icon-info { background-position: -16px -144px; }
.ui-icon-notice { background-position: -32px -144px; }
.ui-icon-help { background-position: -48px -144px; }
.ui-icon-check { background-position: -64px -144px; }
.ui-icon-bullet { background-position: -80px -144px; }
.ui-icon-radio-on { background-position: -96px -144px; }
.ui-icon-radio-off { background-position: -112px -144px; }
.ui-icon-pin-w { background-position: -128px -144px; }
.ui-icon-pin-s { background-position: -144px -144px; }
.ui-icon-play { background-position: 0 -160px; }
.ui-icon-pause { background-position: -16px -160px; }
.ui-icon-seek-next { background-position: -32px -160px; }
.ui-icon-seek-prev { background-position: -48px -160px; }
.ui-icon-seek-end { background-position: -64px -160px; }
.ui-icon-seek-start { background-position: -80px -160px; }
/* ui-icon-seek-first is deprecated, use ui-icon-seek-start instead */
.ui-icon-seek-first { background-position: -80px -160px; }
.ui-icon-stop { background-position: -96px -160px; }
.ui-icon-eject { background-position: -112px -160px; }
.ui-icon-volume-off { background-position: -128px -160px; }
.ui-icon-volume-on { background-position: -144px -160px; }
.ui-icon-power { background-position: 0 -176px; }
.ui-icon-signal-diag { background-position: -16px -176px; }
.ui-icon-signal { background-position: -32px -176px; }
.ui-icon-battery-0 { background-position: -48px -176px; }
.ui-icon-battery-1 { background-position: -64px -176px; }
.ui-icon-battery-2 { background-position: -80px -176px; }
.ui-icon-battery-3 { background-position: -96px -176px; }
.ui-icon-circle-plus { background-position: 0 -192px; }
.ui-icon-circle-minus { background-position: -16px -192px; }
.ui-icon-circle-close { background-position: -32px -192px; }
.ui-icon-circle-triangle-e { background-position: -48px -192px; }
.ui-icon-circle-triangle-s { background-position: -64px -192px; }
.ui-icon-circle-triangle-w { background-position: -80px -192px; }
.ui-icon-circle-triangle-n { background-position: -96px -192px; }
.ui-icon-circle-arrow-e { background-position: -112px -192px; }
.ui-icon-circle-arrow-s { background-position: -128px -192px; }
.ui-icon-circle-arrow-w { background-position: -144px -192px; }
.ui-icon-circle-arrow-n { background-position: -160px -192px; }
.ui-icon-circle-zoomin { background-position: -176px -192px; }
.ui-icon-circle-zoomout { background-position: -192px -192px; }
.ui-icon-circle-check { background-position: -208px -192px; }
.ui-icon-circlesmall-plus { background-position: 0 -208px; }
.ui-icon-circlesmall-minus { background-position: -16px -208px; }
.ui-icon-circlesmall-close { background-position: -32px -208px; }
.ui-icon-squaresmall-plus { background-position: -48px -208px; }
.ui-icon-squaresmall-minus { background-position: -64px -208px; }
.ui-icon-squaresmall-close { background-position: -80px -208px; }
.ui-icon-grip-dotted-vertical { background-position: 0 -224px; }
.ui-icon-grip-dotted-horizontal { background-position: -16px -224px; }
.ui-icon-grip-solid-vertical { background-position: -32px -224px; }
.ui-icon-grip-solid-horizontal { background-position: -48px -224px; }
.ui-icon-gripsmall-diagonal-se { background-position: -64px -224px; }
.ui-icon-grip-diagonal-se { background-position: -80px -224px; }


/* Misc visuals
----------------------------------*/

/* Corner radius */
.ui-corner-all,
.ui-corner-top,
.ui-corner-left,
.ui-corner-tl {
	border-top-left-radius: 3px;
}
.ui-corner-all,
.ui-corner-top,
.ui-corner-right,
.ui-corner-tr {
	border-top-right-radius: 3px;
}
.ui-corner-all,
.ui-corner-bottom,
.ui-corner-left,
.ui-corner-bl {
	border-bottom-left-radius: 3px;
}
.ui-corner-all,
.ui-corner-bottom,
.ui-corner-right,
.ui-corner-br {
	border-bottom-right-radius: 3px;
}

/* Overlays */
.ui-widget-overlay {
	background: #aaaaaa;
	opacity: .3;
	filter: Alpha(Opacity=30); /* support: IE8 */
}
.ui-widget-shadow {
	-webkit-box-shadow: 0px 0px 5px #666666;
	box-shadow: 0px 0px 5px #666666;
}

================
File: LICENSE
================
GNU GENERAL PUBLIC LICENSE
                       Version 3, 29 June 2007

 Copyright (C) 2007 Free Software Foundation, Inc. <https://fsf.org/>
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.

                            Preamble

  The GNU General Public License is a free, copyleft license for
software and other kinds of works.

  The licenses for most software and other practical works are designed
to take away your freedom to share and change the works.  By contrast,
the GNU General Public License is intended to guarantee your freedom to
share and change all versions of a program--to make sure it remains free
software for all its users.  We, the Free Software Foundation, use the
GNU General Public License for most of our software; it applies also to
any other work released this way by its authors.  You can apply it to
your programs, too.

  When we speak of free software, we are referring to freedom, not
price.  Our General Public Licenses are designed to make sure that you
have the freedom to distribute copies of free software (and charge for
them if you wish), that you receive source code or can get it if you
want it, that you can change the software or use pieces of it in new
free programs, and that you know you can do these things.

  To protect your rights, we need to prevent others from denying you
these rights or asking you to surrender the rights.  Therefore, you have
certain responsibilities if you distribute copies of the software, or if
you modify it: responsibilities to respect the freedom of others.

  For example, if you distribute copies of such a program, whether
gratis or for a fee, you must pass on to the recipients the same
freedoms that you received.  You must make sure that they, too, receive
or can get the source code.  And you must show them these terms so they
know their rights.

  Developers that use the GNU GPL protect your rights with two steps:
(1) assert copyright on the software, and (2) offer you this License
giving you legal permission to copy, distribute and/or modify it.

  For the developers' and authors' protection, the GPL clearly explains
that there is no warranty for this free software.  For both users' and
authors' sake, the GPL requires that modified versions be marked as
changed, so that their problems will not be attributed erroneously to
authors of previous versions.

  Some devices are designed to deny users access to install or run
modified versions of the software inside them, although the manufacturer
can do so.  This is fundamentally incompatible with the aim of
protecting users' freedom to change the software.  The systematic
pattern of such abuse occurs in the area of products for individuals to
use, which is precisely where it is most unacceptable.  Therefore, we
have designed this version of the GPL to prohibit the practice for those
products.  If such problems arise substantially in other domains, we
stand ready to extend this provision to those domains in future versions
of the GPL, as needed to protect the freedom of users.

  Finally, every program is threatened constantly by software patents.
States should not allow patents to restrict development and use of
software on general-purpose computers, but in those that do, we wish to
avoid the special danger that patents applied to a free program could
make it effectively proprietary.  To prevent this, the GPL assures that
patents cannot be used to render the program non-free.

  The precise terms and conditions for copying, distribution and
modification follow.

                       TERMS AND CONDITIONS

  0. Definitions.

  "This License" refers to version 3 of the GNU General Public License.

  "Copyright" also means copyright-like laws that apply to other kinds of
works, such as semiconductor masks.

  "The Program" refers to any copyrightable work licensed under this
License.  Each licensee is addressed as "you".  "Licensees" and
"recipients" may be individuals or organizations.

  To "modify" a work means to copy from or adapt all or part of the work
in a fashion requiring copyright permission, other than the making of an
exact copy.  The resulting work is called a "modified version" of the
earlier work or a work "based on" the earlier work.

  A "covered work" means either the unmodified Program or a work based
on the Program.

  To "propagate" a work means to do anything with it that, without
permission, would make you directly or secondarily liable for
infringement under applicable copyright law, except executing it on a
computer or modifying a private copy.  Propagation includes copying,
distribution (with or without modification), making available to the
public, and in some countries other activities as well.

  To "convey" a work means any kind of propagation that enables other
parties to make or receive copies.  Mere interaction with a user through
a computer network, with no transfer of a copy, is not conveying.

  An interactive user interface displays "Appropriate Legal Notices"
to the extent that it includes a convenient and prominently visible
feature that (1) displays an appropriate copyright notice, and (2)
tells the user that there is no warranty for the work (except to the
extent that warranties are provided), that licensees may convey the
work under this License, and how to view a copy of this License.  If
the interface presents a list of user commands or options, such as a
menu, a prominent item in the list meets this criterion.

  1. Source Code.

  The "source code" for a work means the preferred form of the work
for making modifications to it.  "Object code" means any non-source
form of a work.

  A "Standard Interface" means an interface that either is an official
standard defined by a recognized standards body, or, in the case of
interfaces specified for a particular programming language, one that
is widely used among developers working in that language.

  The "System Libraries" of an executable work include anything, other
than the work as a whole, that (a) is included in the normal form of
packaging a Major Component, but which is not part of that Major
Component, and (b) serves only to enable use of the work with that
Major Component, or to implement a Standard Interface for which an
implementation is available to the public in source code form.  A
"Major Component", in this context, means a major essential component
(kernel, window system, and so on) of the specific operating system
(if any) on which the executable work runs, or a compiler used to
produce the work, or an object code interpreter used to run it.

  The "Corresponding Source" for a work in object code form means all
the source code needed to generate, install, and (for an executable
work) run the object code and to modify the work, including scripts to
control those activities.  However, it does not include the work's
System Libraries, or general-purpose tools or generally available free
programs which are used unmodified in performing those activities but
which are not part of the work.  For example, Corresponding Source
includes interface definition files associated with source files for
the work, and the source code for shared libraries and dynamically
linked subprograms that the work is specifically designed to require,
such as by intimate data communication or control flow between those
subprograms and other parts of the work.

  The Corresponding Source need not include anything that users
can regenerate automatically from other parts of the Corresponding
Source.

  The Corresponding Source for a work in source code form is that
same work.

  2. Basic Permissions.

  All rights granted under this License are granted for the term of
copyright on the Program, and are irrevocable provided the stated
conditions are met.  This License explicitly affirms your unlimited
permission to run the unmodified Program.  The output from running a
covered work is covered by this License only if the output, given its
content, constitutes a covered work.  This License acknowledges your
rights of fair use or other equivalent, as provided by copyright law.

  You may make, run and propagate covered works that you do not
convey, without conditions so long as your license otherwise remains
in force.  You may convey covered works to others for the sole purpose
of having them make modifications exclusively for you, or provide you
with facilities for running those works, provided that you comply with
the terms of this License in conveying all material for which you do
not control copyright.  Those thus making or running the covered works
for you must do so exclusively on your behalf, under your direction
and control, on terms that prohibit them from making any copies of
your copyrighted material outside their relationship with you.

  Conveying under any other circumstances is permitted solely under
the conditions stated below.  Sublicensing is not allowed; section 10
makes it unnecessary.

  3. Protecting Users' Legal Rights From Anti-Circumvention Law.

  No covered work shall be deemed part of an effective technological
measure under any applicable law fulfilling obligations under article
11 of the WIPO copyright treaty adopted on 20 December 1996, or
similar laws prohibiting or restricting circumvention of such
measures.

  When you convey a covered work, you waive any legal power to forbid
circumvention of technological measures to the extent such circumvention
is effected by exercising rights under this License with respect to
the covered work, and you disclaim any intention to limit operation or
modification of the work as a means of enforcing, against the work's
users, your or third parties' legal rights to forbid circumvention of
technological measures.

  4. Conveying Verbatim Copies.

  You may convey verbatim copies of the Program's source code as you
receive it, in any medium, provided that you conspicuously and
appropriately publish on each copy an appropriate copyright notice;
keep intact all notices stating that this License and any
non-permissive terms added in accord with section 7 apply to the code;
keep intact all notices of the absence of any warranty; and give all
recipients a copy of this License along with the Program.

  You may charge any price or no price for each copy that you convey,
and you may offer support or warranty protection for a fee.

  5. Conveying Modified Source Versions.

  You may convey a work based on the Program, or the modifications to
produce it from the Program, in the form of source code under the
terms of section 4, provided that you also meet all of these conditions:

    a) The work must carry prominent notices stating that you modified
    it, and giving a relevant date.

    b) The work must carry prominent notices stating that it is
    released under this License and any conditions added under section
    7.  This requirement modifies the requirement in section 4 to
    "keep intact all notices".

    c) You must license the entire work, as a whole, under this
    License to anyone who comes into possession of a copy.  This
    License will therefore apply, along with any applicable section 7
    additional terms, to the whole of the work, and all its parts,
    regardless of how they are packaged.  This License gives no
    permission to license the work in any other way, but it does not
    invalidate such permission if you have separately received it.

    d) If the work has interactive user interfaces, each must display
    Appropriate Legal Notices; however, if the Program has interactive
    interfaces that do not display Appropriate Legal Notices, your
    work need not make them do so.

  A compilation of a covered work with other separate and independent
works, which are not by their nature extensions of the covered work,
and which are not combined with it such as to form a larger program,
in or on a volume of a storage or distribution medium, is called an
"aggregate" if the compilation and its resulting copyright are not
used to limit the access or legal rights of the compilation's users
beyond what the individual works permit.  Inclusion of a covered work
in an aggregate does not cause this License to apply to the other
parts of the aggregate.

  6. Conveying Non-Source Forms.

  You may convey a covered work in object code form under the terms
of sections 4 and 5, provided that you also convey the
machine-readable Corresponding Source under the terms of this License,
in one of these ways:

    a) Convey the object code in, or embodied in, a physical product
    (including a physical distribution medium), accompanied by the
    Corresponding Source fixed on a durable physical medium
    customarily used for software interchange.

    b) Convey the object code in, or embodied in, a physical product
    (including a physical distribution medium), accompanied by a
    written offer, valid for at least three years and valid for as
    long as you offer spare parts or customer support for that product
    model, to give anyone who possesses the object code either (1) a
    copy of the Corresponding Source for all the software in the
    product that is covered by this License, on a durable physical
    medium customarily used for software interchange, for a price no
    more than your reasonable cost of physically performing this
    conveying of source, or (2) access to copy the
    Corresponding Source from a network server at no charge.

    c) Convey individual copies of the object code with a copy of the
    written offer to provide the Corresponding Source.  This
    alternative is allowed only occasionally and noncommercially, and
    only if you received the object code with such an offer, in accord
    with subsection 6b.

    d) Convey the object code by offering access from a designated
    place (gratis or for a charge), and offer equivalent access to the
    Corresponding Source in the same way through the same place at no
    further charge.  You need not require recipients to copy the
    Corresponding Source along with the object code.  If the place to
    copy the object code is a network server, the Corresponding Source
    may be on a different server (operated by you or a third party)
    that supports equivalent copying facilities, provided you maintain
    clear directions next to the object code saying where to find the
    Corresponding Source.  Regardless of what server hosts the
    Corresponding Source, you remain obligated to ensure that it is
    available for as long as needed to satisfy these requirements.

    e) Convey the object code using peer-to-peer transmission, provided
    you inform other peers where the object code and Corresponding
    Source of the work are being offered to the general public at no
    charge under subsection 6d.

  A separable portion of the object code, whose source code is excluded
from the Corresponding Source as a System Library, need not be
included in conveying the object code work.

  A "User Product" is either (1) a "consumer product", which means any
tangible personal property which is normally used for personal, family,
or household purposes, or (2) anything designed or sold for incorporation
into a dwelling.  In determining whether a product is a consumer product,
doubtful cases shall be resolved in favor of coverage.  For a particular
product received by a particular user, "normally used" refers to a
typical or common use of that class of product, regardless of the status
of the particular user or of the way in which the particular user
actually uses, or expects or is expected to use, the product.  A product
is a consumer product regardless of whether the product has substantial
commercial, industrial or non-consumer uses, unless such uses represent
the only significant mode of use of the product.

  "Installation Information" for a User Product means any methods,
procedures, authorization keys, or other information required to install
and execute modified versions of a covered work in that User Product from
a modified version of its Corresponding Source.  The information must
suffice to ensure that the continued functioning of the modified object
code is in no case prevented or interfered with solely because
modification has been made.

  If you convey an object code work under this section in, or with, or
specifically for use in, a User Product, and the conveying occurs as
part of a transaction in which the right of possession and use of the
User Product is transferred to the recipient in perpetuity or for a
fixed term (regardless of how the transaction is characterized), the
Corresponding Source conveyed under this section must be accompanied
by the Installation Information.  But this requirement does not apply
if neither you nor any third party retains the ability to install
modified object code on the User Product (for example, the work has
been installed in ROM).

  The requirement to provide Installation Information does not include a
requirement to continue to provide support service, warranty, or updates
for a work that has been modified or installed by the recipient, or for
the User Product in which it has been modified or installed.  Access to a
network may be denied when the modification itself materially and
adversely affects the operation of the network or violates the rules and
protocols for communication across the network.

  Corresponding Source conveyed, and Installation Information provided,
in accord with this section must be in a format that is publicly
documented (and with an implementation available to the public in
source code form), and must require no special password or key for
unpacking, reading or copying.

  7. Additional Terms.

  "Additional permissions" are terms that supplement the terms of this
License by making exceptions from one or more of its conditions.
Additional permissions that are applicable to the entire Program shall
be treated as though they were included in this License, to the extent
that they are valid under applicable law.  If additional permissions
apply only to part of the Program, that part may be used separately
under those permissions, but the entire Program remains governed by
this License without regard to the additional permissions.

  When you convey a copy of a covered work, you may at your option
remove any additional permissions from that copy, or from any part of
it.  (Additional permissions may be written to require their own
removal in certain cases when you modify the work.)  You may place
additional permissions on material, added by you to a covered work,
for which you have or can give appropriate copyright permission.

  Notwithstanding any other provision of this License, for material you
add to a covered work, you may (if authorized by the copyright holders of
that material) supplement the terms of this License with terms:

    a) Disclaiming warranty or limiting liability differently from the
    terms of sections 15 and 16 of this License; or

    b) Requiring preservation of specified reasonable legal notices or
    author attributions in that material or in the Appropriate Legal
    Notices displayed by works containing it; or

    c) Prohibiting misrepresentation of the origin of that material, or
    requiring that modified versions of such material be marked in
    reasonable ways as different from the original version; or

    d) Limiting the use for publicity purposes of names of licensors or
    authors of the material; or

    e) Declining to grant rights under trademark law for use of some
    trade names, trademarks, or service marks; or

    f) Requiring indemnification of licensors and authors of that
    material by anyone who conveys the material (or modified versions of
    it) with contractual assumptions of liability to the recipient, for
    any liability that these contractual assumptions directly impose on
    those licensors and authors.

  All other non-permissive additional terms are considered "further
restrictions" within the meaning of section 10.  If the Program as you
received it, or any part of it, contains a notice stating that it is
governed by this License along with a term that is a further
restriction, you may remove that term.  If a license document contains
a further restriction but permits relicensing or conveying under this
License, you may add to a covered work material governed by the terms
of that license document, provided that the further restriction does
not survive such relicensing or conveying.

  If you add terms to a covered work in accord with this section, you
must place, in the relevant source files, a statement of the
additional terms that apply to those files, or a notice indicating
where to find the applicable terms.

  Additional terms, permissive or non-permissive, may be stated in the
form of a separately written license, or stated as exceptions;
the above requirements apply either way.

  8. Termination.

  You may not propagate or modify a covered work except as expressly
provided under this License.  Any attempt otherwise to propagate or
modify it is void, and will automatically terminate your rights under
this License (including any patent licenses granted under the third
paragraph of section 11).

  However, if you cease all violation of this License, then your
license from a particular copyright holder is reinstated (a)
provisionally, unless and until the copyright holder explicitly and
finally terminates your license, and (b) permanently, if the copyright
holder fails to notify you of the violation by some reasonable means
prior to 60 days after the cessation.

  Moreover, your license from a particular copyright holder is
reinstated permanently if the copyright holder notifies you of the
violation by some reasonable means, this is the first time you have
received notice of violation of this License (for any work) from that
copyright holder, and you cure the violation prior to 30 days after
your receipt of the notice.

  Termination of your rights under this section does not terminate the
licenses of parties who have received copies or rights from you under
this License.  If your rights have been terminated and not permanently
reinstated, you do not qualify to receive new licenses for the same
material under section 10.

  9. Acceptance Not Required for Having Copies.

  You are not required to accept this License in order to receive or
run a copy of the Program.  Ancillary propagation of a covered work
occurring solely as a consequence of using peer-to-peer transmission
to receive a copy likewise does not require acceptance.  However,
nothing other than this License grants you permission to propagate or
modify any covered work.  These actions infringe copyright if you do
not accept this License.  Therefore, by modifying or propagating a
covered work, you indicate your acceptance of this License to do so.

  10. Automatic Licensing of Downstream Recipients.

  Each time you convey a covered work, the recipient automatically
receives a license from the original licensors, to run, modify and
propagate that work, subject to this License.  You are not responsible
for enforcing compliance by third parties with this License.

  An "entity transaction" is a transaction transferring control of an
organization, or substantially all assets of one, or subdividing an
organization, or merging organizations.  If propagation of a covered
work results from an entity transaction, each party to that
transaction who receives a copy of the work also receives whatever
licenses to the work the party's predecessor in interest had or could
give under the previous paragraph, plus a right to possession of the
Corresponding Source of the work from the predecessor in interest, if
the predecessor has it or can get it with reasonable efforts.

  You may not impose any further restrictions on the exercise of the
rights granted or affirmed under this License.  For example, you may
not impose a license fee, royalty, or other charge for exercise of
rights granted under this License, and you may not initiate litigation
(including a cross-claim or counterclaim in a lawsuit) alleging that
any patent claim is infringed by making, using, selling, offering for
sale, or importing the Program or any portion of it.

  11. Patents.

  A "contributor" is a copyright holder who authorizes use under this
License of the Program or a work on which the Program is based.  The
work thus licensed is called the contributor's "contributor version".

  A contributor's "essential patent claims" are all patent claims
owned or controlled by the contributor, whether already acquired or
hereafter acquired, that would be infringed by some manner, permitted
by this License, of making, using, or selling its contributor version,
but do not include claims that would be infringed only as a
consequence of further modification of the contributor version.  For
purposes of this definition, "control" includes the right to grant
patent sublicenses in a manner consistent with the requirements of
this License.

  Each contributor grants you a non-exclusive, worldwide, royalty-free
patent license under the contributor's essential patent claims, to
make, use, sell, offer for sale, import and otherwise run, modify and
propagate the contents of its contributor version.

  In the following three paragraphs, a "patent license" is any express
agreement or commitment, however denominated, not to enforce a patent
(such as an express permission to practice a patent or covenant not to
sue for patent infringement).  To "grant" such a patent license to a
party means to make such an agreement or commitment not to enforce a
patent against the party.

  If you convey a covered work, knowingly relying on a patent license,
and the Corresponding Source of the work is not available for anyone
to copy, free of charge and under the terms of this License, through a
publicly available network server or other readily accessible means,
then you must either (1) cause the Corresponding Source to be so
available, or (2) arrange to deprive yourself of the benefit of the
patent license for this particular work, or (3) arrange, in a manner
consistent with the requirements of this License, to extend the patent
license to downstream recipients.  "Knowingly relying" means you have
actual knowledge that, but for the patent license, your conveying the
covered work in a country, or your recipient's use of the covered work
in a country, would infringe one or more identifiable patents in that
country that you have reason to believe are valid.

  If, pursuant to or in connection with a single transaction or
arrangement, you convey, or propagate by procuring conveyance of, a
covered work, and grant a patent license to some of the parties
receiving the covered work authorizing them to use, propagate, modify
or convey a specific copy of the covered work, then the patent license
you grant is automatically extended to all recipients of the covered
work and works based on it.

  A patent license is "discriminatory" if it does not include within
the scope of its coverage, prohibits the exercise of, or is
conditioned on the non-exercise of one or more of the rights that are
specifically granted under this License.  You may not convey a covered
work if you are a party to an arrangement with a third party that is
in the business of distributing software, under which you make payment
to the third party based on the extent of your activity of conveying
the work, and under which the third party grants, to any of the
parties who would receive the covered work from you, a discriminatory
patent license (a) in connection with copies of the covered work
conveyed by you (or copies made from those copies), or (b) primarily
for and in connection with specific products or compilations that
contain the covered work, unless you entered into that arrangement,
or that patent license was granted, prior to 28 March 2007.

  Nothing in this License shall be construed as excluding or limiting
any implied license or other defenses to infringement that may
otherwise be available to you under applicable patent law.

  12. No Surrender of Others' Freedom.

  If conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License.  If you cannot convey a
covered work so as to satisfy simultaneously your obligations under this
License and any other pertinent obligations, then as a consequence you may
not convey it at all.  For example, if you agree to terms that obligate you
to collect a royalty for further conveying from those to whom you convey
the Program, the only way you could satisfy both those terms and this
License would be to refrain entirely from conveying the Program.

  13. Use with the GNU Affero General Public License.

  Notwithstanding any other provision of this License, you have
permission to link or combine any covered work with a work licensed
under version 3 of the GNU Affero General Public License into a single
combined work, and to convey the resulting work.  The terms of this
License will continue to apply to the part which is the covered work,
but the special requirements of the GNU Affero General Public License,
section 13, concerning interaction through a network will apply to the
combination as such.

  14. Revised Versions of this License.

  The Free Software Foundation may publish revised and/or new versions of
the GNU General Public License from time to time.  Such new versions will
be similar in spirit to the present version, but may differ in detail to
address new problems or concerns.

  Each version is given a distinguishing version number.  If the
Program specifies that a certain numbered version of the GNU General
Public License "or any later version" applies to it, you have the
option of following the terms and conditions either of that numbered
version or of any later version published by the Free Software
Foundation.  If the Program does not specify a version number of the
GNU General Public License, you may choose any version ever published
by the Free Software Foundation.

  If the Program specifies that a proxy can decide which future
versions of the GNU General Public License can be used, that proxy's
public statement of acceptance of a version permanently authorizes you
to choose that version for the Program.

  Later license versions may give you additional or different
permissions.  However, no additional obligations are imposed on any
author or copyright holder as a result of your choosing to follow a
later version.

  15. Disclaimer of Warranty.

  THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY
OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM
IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
ALL NECESSARY SERVICING, REPAIR OR CORRECTION.

  16. Limitation of Liability.

  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS
THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY
GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE
USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF
DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD
PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS),
EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF
SUCH DAMAGES.

  17. Interpretation of Sections 15 and 16.

  If the disclaimer of warranty and limitation of liability provided
above cannot be given local legal effect according to their terms,
reviewing courts shall apply local law that most closely approximates
an absolute waiver of all civil liability in connection with the
Program, unless a warranty or assumption of liability accompanies a
copy of the Program in return for a fee.

                     END OF TERMS AND CONDITIONS

            How to Apply These Terms to Your New Programs

  If you develop a new program, and you want it to be of the greatest
possible use to the public, the best way to achieve this is to make it
free software which everyone can redistribute and change under these terms.

  To do so, attach the following notices to the program.  It is safest
to attach them to the start of each source file to most effectively
state the exclusion of warranty; and each file should have at least
the "copyright" line and a pointer to where the full notice is found.

    <one line to give the program's name and a brief idea of what it does.>
    Copyright (C) <year>  <name of author>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

Also add information on how to contact you by electronic and paper mail.

  If the program does terminal interaction, make it output a short
notice like this when it starts in an interactive mode:

    <program>  Copyright (C) <year>  <name of author>
    This program comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
    This is free software, and you are welcome to redistribute it
    under certain conditions; type `show c' for details.

The hypothetical commands `show w' and `show c' should show the appropriate
parts of the General Public License.  Of course, your program's commands
might be different; for a GUI interface, you would use an "about box".

  You should also get your employer (if you work as a programmer) or school,
if any, to sign a "copyright disclaimer" for the program, if necessary.
For more information on this, and how to apply and follow the GNU GPL, see
<https://www.gnu.org/licenses/>.

  The GNU General Public License does not permit incorporating your program
into proprietary programs.  If your program is a subroutine library, you
may consider it more useful to permit linking proprietary applications with
the library.  If this is what you want to do, use the GNU Lesser General
Public License instead of this License.  But first, please read
<https://www.gnu.org/licenses/why-not-lgpl.html>.

================
File: css/admin.css
================
/**
* Letterboxd Connect Settings
* Admin Settings Screen
**/

/* A little table styling */
#letterboxd-settings-form .form-table { margin: 2rem 0; }
#letterboxd-settings-form .form-table tr { display: flex; align-items: center; margin: 2rem 0; }
#letterboxd-settings-form .form-table tr:first-of-type { margin-top: 0; }
#letterboxd-settings-form .form-table th,
#letterboxd-settings-form .form-table td { display: inline-flex; margin: 0; padding: 0; line-height: 1; }
#letterboxd-settings-form .form-table span.description { font-size: 0.875rem; }
#letterboxd-settings-form .form-table .letterboxd-status-wrap p.time-wrap { margin: 0; }
.import-after-save { margin: 1.5rem 0; padding: 1rem; background: #f8f8f8; border: 1px solid #ddd; border-radius: 0.25rem; }

/* Input fields */
#letterboxd-settings-form .form-table input { margin-right: 0.5rem; }
input[type="text"] { width: 10rem; }
input[type="date"] { width: 8rem; }
input[type="text"]#tmdb_api_key { width: 20rem; }

#advanced-settings .form-table td { gap: 0.5rem; }
.tmdb-bulk-update-section a.button { display: inline-flex; align-items: center; gap: 0.25rem; }
.tmdb-bulk-update-section a.button span.spinner { margin: 0; }

/* Messages */
#username-validation-message,
#settings-update-message { display: none; margin: 0.5rem 0; padding: 0.5rem 1rem; }

.notice-success { color: #46b450; }
.notice-error { color: #dc3232; }

@media screen and (max-width: 782px) {
	.form-table th { width: 100%; display: block; }	
	.form-table td { padding-left: 0; }
}

================
File: css/movie-block-editor.css
================
:root {
	--grid-gap: 0.5rem;
}
/* Editor-specific styles */
.movie-item h3.movie-title { overflow-wrap: normal; }
.wp-block-letterboxd-connect-movie-grid { padding: 1rem; }
.movie-grid-preview.is-loading { opacity: 0.6; }
.wp-block-letterboxd-connect-movie-grid .components-placeholder { min-height: 8rem; padding: 1.5rem; background: #f8f9f9; }
.wp-block-letterboxd-connect-movie-grid .components-panel__body { border-top: 1px solid #e2e4e7; }
.wp-block-letterboxd-connect-movie-grid .components-base-control { margin-bottom: 1.5rem; }
.wp-block-letterboxd-connect-movie-grid .components-range-control { width: 100%; }
.wp-block-letterboxd-connect-movie-grid .components-select-control { width: 100%; }
.components-panel__body.is-opened > .components-panel__body-title { margin-bottom: 1rem; }
.editor-styles-wrapper .wp-block-letterboxd-connect-movie-grid .editor-preview .movie-grid.columns-1,
.editor-styles-wrapper .wp-block-letterboxd-connect-movie-grid .editor-preview .movie-grid.columns-2 { gap: var(--grid-gap-l); }
.editor-styles-wrapper .wp-block-letterboxd-connect-movie-grid .movie-grid-preview .movie-grid,
.editor-styles-wrapper .wp-block-letterboxd-connect-movie-grid .movie-grid-preview .movie-grid,
.editor-styles-wrapper .wp-block-letterboxd-connect-movie-grid .movie-grid-preview .movie-grid,
.editor-styles-wrapper .wp-block-letterboxd-connect-movie-grid .editor-preview .movie-grid { gap: var(--grid-gap); }

================
File: includes/templates/settings-page.php
================
<div class="wrap">
	<h1><?php echo esc_html(get_admin_page_title()); ?></h1>
	
	<h2 class="nav-tab-wrapper">
		<a href="?page=<?php echo esc_attr(self::MENU_SLUG); ?>&tab=general" class="nav-tab <?php echo esc_attr($active_tab === "general" ? "nav-tab-active" : ""); ?>">
			<?php esc_html_e(
				"General Settings",
				"letterboxd-connect"
			); ?>
		</a>
		<a href="?page=<?php echo esc_attr(self::MENU_SLUG); ?>&tab=advanced" class="nav-tab <?php echo esc_attr($active_tab === "advanced" ? "nav-tab-active" : ""); ?>">
			<?php esc_html_e(
				"Advanced Settings",
				"letterboxd-connect"
			); ?>
		</a>
	</h2>
	
	<div id="letterboxd-settings-container">
		<form id="letterboxd-settings-form" action="options.php" method="post">
			<?php wp_nonce_field(
				self::NONCE_ACTION,
				self::NONCE_NAME
			); ?>
			
			<div id="tab-content-container">
				
				<?php if ($active_tab === "general"): ?>

					<!-- General Settings Tab -->
					<div id="general-settings" class="tab-content active">
						<?php
						settings_fields(self::OPTION_GROUP);
						do_settings_sections(self::MENU_SLUG);
						?>
					</div>

				<?php else: ?>

					<!-- Advanced Settings Tab -->
					<div id="advanced-settings" class="tab-content active">
					    <?php
					    settings_fields(self::OPTION_GROUP);
					    do_settings_sections(
					        self::MENU_SLUG . "_advanced"
					    );
					    ?>
					    
					    <input type="hidden" name="letterboxd_wordpress_options[username]" value="<?php echo esc_attr($this->options["username"]); ?>">
					    <input type="hidden" name="letterboxd_wordpress_options[start_date]" value="<?php echo esc_attr($this->options["start_date"]); ?>">
					    <input type="hidden" name="letterboxd_wordpress_options[draft_status]" value="<?php echo esc_attr($this->options["draft_status"] ? "1" : "0"); ?>">
					</div>

				<?php endif; ?><!-- end advanced settings tab -->

				<!-- Move the TMDB disconnect section OUTSIDE the main form -->
				<?php if ($active_tab === "advanced"): ?>
				    <?php $this->advanced_options = get_option(self::ADVANCED_OPTION_NAME, []); ?>
				    
				    <?php if (empty($this->advanced_options['tmdb_session_id'])) : ?>
				    <div class="tmdb-auth-section">
				        <h3><?php esc_html_e('TMDB Authorization', 'letterboxd-connect'); ?></h3>
				        <p><?php esc_html_e('Authorize this plugin to access your TMDB account for enhanced functionality.', 'letterboxd-connect'); ?></p>
				        
				        <button type="button" id="tmdb-authorize-button" class="button button-secondary">
				            <?php esc_html_e('Authorize with TMDB', 'letterboxd-connect'); ?>
				        </button>
				        <div id="tmdb-auth-status"></div>
				    </div>
				    <?php else: ?>
				    <div class="tmdb-auth-section">
				        <h3><?php esc_html_e('TMDB Authentication', 'letterboxd-connect'); ?></h3>
				        <div class="notice notice-success inline">
				            <p><?php esc_html_e('Successfully authenticated with TMDB', 'letterboxd-connect'); ?></p>
				        </div>
				        
				        <?php if (!empty($_GET['tmdb_disconnected']) && $_GET['tmdb_disconnected'] === 'true') : ?>
				            <div class="notice notice-success is-dismissible">
				                <p><?php esc_html_e('TMDB has been disconnected.', 'letterboxd-connect'); ?></p>
				            </div>
				        <?php endif; ?>
				        
				        <!-- This form is now OUTSIDE the main settings form -->
				        <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" id="tmdb-disconnect-form">
				            <?php wp_nonce_field('letterboxd_disconnect_tmdb'); ?>
				            <input type="hidden" name="action" value="letterboxd_disconnect_tmdb">
				            <button type="submit" class="button button-secondary">
				                <?php esc_html_e('Disconnect TMDB', 'letterboxd-connect'); ?>
				            </button>
				        </form>
				    </div>
				    <?php endif; ?>
				<?php endif; ?>


			</div>
			
			<div id="username-validation-message" class="notice hidden"></div>
			<div id="settings-update-message" class="notice hidden"></div>
			
			<?php if ($active_tab === "advanced"): ?>
				<div class="tmdb-bulk-update-section">
					<h3><?php esc_html_e(
						"Update TMDB Data",
						"letterboxd-connect"
					); ?></h3>
					<p><?php esc_html_e(
						"Update movie metadata from TMDB for all your existing movies.",
						"letterboxd-connect"
					); ?></p>
					<?php $this->render_update_tmdb_button(); ?>
				</div>
			<?php endif; ?>
			
			<?php if ($active_tab === "general"): ?>
			<div class="import-after-save">
				<label for="letterboxd_run_import_trigger">
					<input type="checkbox" id="letterboxd_run_import_trigger" name="letterboxd_run_import_trigger" value="1">
					<span class="description"><?php esc_html_e(
						"Run an import after save",
						"letterboxd-connect"
					); ?></span>
				</label>
			</div>
			<?php endif; ?>
			
			<?php submit_button(
				__("Save Settings", "letterboxd-connect"),
				"primary",
				"save-settings"
			); ?>
		</form>
	</div>
</div>

================
File: js/movie-block.js
================
const { registerBlockType } = wp.blocks;
const { useBlockProps, InspectorControls } = wp.blockEditor;
const { 
    PanelBody, 
    SelectControl, 
    RangeControl, 
    RadioControl,
    ToggleControl 
} = wp.components;
const { __ } = wp.i18n;
const { useState, Fragment, createElement } = wp.element;
const ServerSideRender = wp.serverSideRender;

// Block configuration
const BLOCK_NAME = 'letterboxd-connect/movie-grid';
const DEFAULT_ATTRIBUTES = {
    number: 12,
    showAll: false,
    perPage: 12,
    orderby: 'date',
    order: 'DESC',
    columns: 3,
    displayMode: 'cards',
    showDirector: true,
    showRating: true,
    showStreamingLink: true,
    showExternalLinks: true
};

// Editor control options
const orderOptions = [
    { label: __('Descending', 'letterboxd-connect'), value: 'DESC' },
    { label: __('Ascending', 'letterboxd-connect'), value: 'ASC' }
];

const orderByOptions = [
    { label: __('Watch Date', 'letterboxd-connect'), value: 'watch_date' },
    { label: __('Movie Title', 'letterboxd-connect'), value: 'title' },
    { label: __('Release Year', 'letterboxd-connect'), value: 'release_year' }
];

const displayModeOptions = [
    { label: __('Cards', 'letterboxd-connect'), value: 'cards' },
    { label: __('List', 'letterboxd-connect'), value: 'list' }
];


const EditMovieGrid = ({ attributes, setAttributes }) => {
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);
    const blockProps = useBlockProps({
        className: `display-${attributes.displayMode} columns-${attributes.columns}`
    });
    
    // Apply styles based on columns and display mode
    React.useEffect(() => {
        const styleId = 'letterboxd-movie-grid-editor-styles';
        let styleElement = document.getElementById(styleId);
        
        if (!styleElement) {
            styleElement = document.createElement('style');
            styleElement.id = styleId;
            document.head.appendChild(styleElement);
        }
    
        // Apply grid styles conditionally based on display mode
        if (attributes.displayMode === 'cards') {
            styleElement.textContent = `
                .editor-styles-wrapper .movie-grid-preview .movie-grid,
                .editor-styles-wrapper .editor-preview .movie-grid {
                    display: grid;
                    grid-template-columns: repeat(${attributes.columns}, 1fr);
                    gap: 1.5rem;
                }
            `;
        } else {
            // List display mode - always single column
            styleElement.textContent = `
                .editor-styles-wrapper .movie-grid-preview .movie-grid,
                .editor-styles-wrapper .editor-preview .movie-grid {
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                }
            `;
        }
    }, [attributes.columns, attributes.displayMode]);

    // Build inspector controls using createElement
    const inspectorControls = createElement(
        InspectorControls,
        null,
        createElement(
            PanelBody,
            { title: __('Movie Grid Settings', 'letterboxd-connect') },
            createElement(RadioControl, {
                label: __('Display Mode', 'letterboxd-connect'),
                selected: attributes.displayMode,
                options: displayModeOptions,
                onChange: (value) => setAttributes({ displayMode: value }),
                help: __('Choose how to display your movies', 'letterboxd-connect')
            }),
            // Only show columns option for cards display mode
            attributes.displayMode === 'cards' && createElement(RangeControl, {
                label: __('Columns', 'letterboxd-connect'),
                value: attributes.columns,
                onChange: (value) => setAttributes({ columns: value }),
                min: 1,
                max: 6,
                help: [
                    __('Select number of columns in the grid,', 'letterboxd-connect'),
                    createElement('br', { key: 'break' }),
                    __('max of two columns show on mobile', 'letterboxd-connect')
                ]
            }),
            createElement(ToggleControl, {
                label: __('Show All Movies', 'letterboxd-connect'),
                checked: attributes.showAll,
                onChange: (value) => setAttributes({ showAll: value }),
                help: __('Enable pagination and show all movies', 'letterboxd-connect')
            }),
            !attributes.showAll && createElement(RangeControl, {
                label: __('Number of Movies', 'letterboxd-connect'),
                value: attributes.number,
                onChange: (value) => setAttributes({ number: value }),
                min: 1,
                max: 24,
                help: __('Select how many movies to display', 'letterboxd-connect')
            }),
            attributes.showAll && createElement(RangeControl, {
                label: __('Movies Per Page', 'letterboxd-connect'),
                value: attributes.perPage,
                onChange: (value) => setAttributes({ perPage: value }),
                min: 6,
                max: 20,
                help: __('Select how many movies to display per page', 'letterboxd-connect')
            }),
            createElement(SelectControl, {
                label: __('Order By', 'letterboxd-connect'),
                value: attributes.orderby,
                options: orderByOptions,
                onChange: (value) => setAttributes({ orderby: value })
            }),
            createElement(SelectControl, {
                label: __('Order', 'letterboxd-connect'),
                value: attributes.order,
                options: orderOptions,
                onChange: (value) => setAttributes({ order: value })
            })
        ),
        createElement(
            PanelBody,
            { 
                title: __('Display Options', 'letterboxd-connect'),
                initialOpen: true
            },
            createElement(ToggleControl, {
                label: __('Show Director', 'letterboxd-connect'),
                checked: attributes.showDirector,
                onChange: (value) => setAttributes({ showDirector: value })
            }),
            createElement(ToggleControl, {
                label: __('Show Rating', 'letterboxd-connect'),
                checked: attributes.showRating,
                onChange: (value) => setAttributes({ showRating: value })
            }),
            createElement(ToggleControl, {
                label: __('Show Streaming Link', 'letterboxd-connect'),
                checked: attributes.showStreamingLink,
                onChange: (value) => setAttributes({ showStreamingLink: value })
            }),
            createElement(ToggleControl, {
                label: __('Show External Links', 'letterboxd-connect'),
                checked: attributes.showExternalLinks,
                onChange: (value) => setAttributes({ showExternalLinks: value })
            })
        )
    );

    // Build block content with error handling
    let blockContent;
    if (error) {
        blockContent = createElement(
            'div',
            { className: 'components-placeholder is-error' },
            createElement(
                'div',
                { className: 'components-placeholder__error' },
                error
            )
        );
    } else {
        blockContent = createElement(
            'div', 
            { 
                className: `movie-grid-preview ${isLoading ? 'is-loading' : ''}`,
                'data-columns': attributes.columns,
                'data-display-mode': attributes.displayMode
            },
            createElement(ServerSideRender, {
                block: BLOCK_NAME,
                attributes: attributes,
                onError: (err) => {
                    console.error('Movie Grid Error:', err);
                    setError(err.message || __('Error loading movies', 'letterboxd-connect'));
                },
                onBeforeChange: () => {
                    setIsLoading(true);
                    setError(null);
                },
                onAfterChange: () => {
                    setIsLoading(false);
                }
            })
        );
    }

    // Return final element using Fragment and createElement
    return createElement(
        Fragment,
        null,
        inspectorControls,
        createElement(
            'div',
            blockProps,
            blockContent
        )
    );
};

// Register the block
registerBlockType(BLOCK_NAME, {
    title: __('Movie Grid', 'letterboxd-connect'),
    icon: 'video-alt2',
    category: 'letterboxd-blocks',
    keywords: [
        __('movies', 'letterboxd-connect'),
        __('letterboxd', 'letterboxd-connect'),
        __('grid', 'letterboxd-connect')
    ],
    supports: {
        align: ['wide', 'full'],
        html: false
    },
    attributes: {
        number: {
            type: 'number',
            default: DEFAULT_ATTRIBUTES.number
        },
        showAll: {
            type: 'boolean',
            default: DEFAULT_ATTRIBUTES.showAll
        },
        perPage: {
            type: 'number',
            default: DEFAULT_ATTRIBUTES.perPage
        },
        orderby: {
            type: 'string',
            default: DEFAULT_ATTRIBUTES.orderby
        },
        order: {
            type: 'string',
            default: DEFAULT_ATTRIBUTES.order
        },
        columns: {
            type: 'number',
            default: DEFAULT_ATTRIBUTES.columns
        },
        displayMode: {
            type: 'string',
            default: DEFAULT_ATTRIBUTES.displayMode
        },
        // display options
        showDirector: {
            type: 'boolean',
            default: DEFAULT_ATTRIBUTES.showDirector
        },
        showRating: {
            type: 'boolean',
            default: DEFAULT_ATTRIBUTES.showRating
        },
        showStreamingLink: {
            type: 'boolean',
            default: DEFAULT_ATTRIBUTES.showStreamingLink
        },
        showExternalLinks: {
            type: 'boolean',
            default: DEFAULT_ATTRIBUTES.showExternalLinks
        }
    },
    edit: EditMovieGrid,
    save: () => null // Server-side rendered
});


// Cleanup handler
document.addEventListener('DOMContentLoaded', () => {
    const observer = new MutationObserver((mutations) => {
        const hasRemovedGrid = mutations.some(mutation =>
            Array.from(mutation.removedNodes).some(
                (node) => node.classList && node.classList.contains('wp-block-letterboxd-connect-movie-grid')
            )
        );

        if (hasRemovedGrid) {
            const styleElement = document.getElementById('letterboxd-movie-grid-editor-styles');
            if (styleElement && !document.querySelector('.wp-block-letterboxd-connect-movie-grid')) {
                styleElement.remove();
            }
        }
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    // Cleanup observer on page unload
    window.addEventListener('unload', () => observer.disconnect());
});

================
File: css/movie-grid.css
================
:root {
    --line-height: 1.2;
    --white: #fff;
    --movie-shadow-color: rgba(0, 0, 0, 0.1);
    --movie-shadow-hover: rgba(0, 0, 0, 0.15);
    --shadow-small: 0 0.125rem 0.25rem var(--movie-shadow-color);
    --shadow-large: 0 0.25rem 0.5rem var(--movie-shadow-hover);
    --light-grey: #f5f5f5;
    --text-muted: #666;
    --font-size-sm: 0.75rem;
    --opacity: 0.7;
    --grid-gap: 0.5rem;
    --grid-gap-l: 1.5rem;
    --common-gap: 1rem;
    --card-padding: 1rem;
    --list-padding: 0.75rem 1rem;
    --common-padding: 0.25rem 0.5rem;
    --border-radius: 0.5rem;
    --transform-distance: -0.25rem;
    --thumbnail-width: 8rem;
    --poster-aspect-ratio: 2/3;
    --imdb-color: #f5c518;
    --rt-color: #fa320a;
}

.movie-item { background: var(--white); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-small); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
.movie-item:hover { transform: translateY(var(--transform-distance)); box-shadow: var(--shadow-large); }
.movie-item .movie-poster { position: relative; aspect-ratio: var(--poster-aspect-ratio); width: 100%; overflow: hidden; }
.movie-item .movie-poster img { object-fit: cover; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
.movie-item .movie-details { padding: var(--card-padding); gap: var(--grid-gap); }
.movie-item .movie-details h3.movie-title { font-size: 1rem; font-weight: 700; margin: 0; overflow: hidden; text-overflow: ellipsis; line-height: var(--line-height); }
.movie-item .movie-details p { line-height: var(--line-height); font-size: var(--font-size-sm); margin: 0; }
.movie-item .movie-details .movie-meta { font-size: 0.875rem; margin-bottom: 1.5rem; }
.movie-item .movie-details .movie-meta .movie-director:before { content: 'Dir: '; opacity: var(--opacity); }
.movie-item .movie-details .movie-meta .watch-date:before { content: 'Watched: '; opacity: var(--opacity); }
.movie-item .movie-details .movie-links { margin-top: auto; }
.movie-item .movie-details .movie-links p.watch-link a { text-decoration: none; }
.movie-item .movie-details .movie-links p.watch-link a:hover { text-decoration: underline; }
.movie-item .movie-details .movie-links  { line-height: 1; }
.movie-item .movie-details .movie-links .external-link { display: inline-block; padding: var(--common-padding); border-radius: var(--border-radius); font-size: var(--font-size-sm); font-weight: 700; text-decoration: none; color: var(--white); line-height: 1; transition: opacity 0.2s ease-in-out; }
.movie-item .movie-details .movie-links .external-link:hover { opacity: var(--opacity); }
.movie-item .movie-details .movie-links .watch-link { background-color: var(--light-grey); color: #000; }
.movie-item .movie-details .movie-links .imdb-link { background-color: var(--imdb-color); color: #000; }
.movie-item .movie-details .movie-links .rt-link { background-color: var(--rt-color); }

/* List Specific */
.movie-list-item { display: flex; }
.movie-list-item .movie-poster { flex: 0 0 auto; width: var(--thumbnail-width); }
.movie-list-item .movie-details { flex: 1; padding: var(--list-padding); display: flex; flex-direction: column; }

/* Card Specific */
.movie-card { display: flex; flex-direction: column; will-change: transform; }
.movie-card .movie-details { display: flex; flex-direction: column; flex-grow: 1; }

/* Grid-Specific Layout */
.wp-block-letterboxd-connect-movie-grid { margin: var(--grid-gap) 0; }
.wp-block-letterboxd-connect-movie-grid .movie-grid { display: grid; gap: var(--grid-gap); grid-template-columns: repeat(2, 1fr); }
.wp-block-letterboxd-connect-movie-grid[data-columns="1"] .movie-grid { grid-template-columns: repeat(1, 1fr); gap: var(--grid-gap-l); }

/* List-Specific Layout */
.wp-block-letterboxd-connect-movie-grid[data-display-mode="list"] .movie-list,
.editor-styles-wrapper .editor-preview[data-display-mode="list"] .movie-list,
.editor-styles-wrapper .movie-grid-preview[data-display-mode="list"] .movie-list { display: flex; flex-direction: column; gap: var(--common-gap); }

/* Pagination */
.movie-grid-pagination { margin-top: 2rem; width: 100%; text-align: center; }
.movie-grid-pagination .page-numbers { display: flex; flex-wrap: wrap; justify-content: center; list-style: none; padding: 0; margin: 0; gap: 0.25rem; }
.movie-grid-pagination .page-numbers li { margin: 0; padding: 0; }
.movie-grid-pagination .page-numbers a,
.movie-grid-pagination .page-numbers span { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 0.75rem; text-align: center; text-decoration: none; border-radius: var(--border-radius); background-color: var(--white); box-shadow: var(--shadow-small); transition: all 0.2s ease; font-size: 0.825rem; }
.movie-grid-pagination .page-numbers a:hover,
.movie-grid-pagination .page-numbers a:focus { background-color: var(--light-grey); box-shadow: var(--shadow-large); transform: translateY(-2px); }
.movie-grid-pagination .page-numbers .current { background-color: var(--light-grey); }
.movie-grid-pagination .page-numbers .prev,
.movie-grid-pagination .page-numbers .next { padding: 0.5rem 0.75rem; }
.editor-preview .pagination-note { margin-top: 2rem; font-size: 0.825rem; padding: 0.5rem; background-color: var(--light-grey); border-radius: var(--border-radius); text-align: center; }


@media (min-width: 768px) { 
  :root { --thumbnail-width: 12rem; }
  
  /* Grid-Specific Layout */
  .wp-block-letterboxd-connect-movie-grid .movie-grid { grid-template-columns: repeat(auto-fill, minmax(10rem, 1fr)); }
  .wp-block-letterboxd-connect-movie-grid[data-columns="2"] .movie-grid { grid-template-columns: repeat(2, 1fr); gap: var(--grid-gap-l); }
  .wp-block-letterboxd-connect-movie-grid[data-columns="3"] .movie-grid { grid-template-columns: repeat(3, 1fr); }
  .wp-block-letterboxd-connect-movie-grid[data-columns="4"] .movie-grid { grid-template-columns: repeat(4, 1fr); }
  .wp-block-letterboxd-connect-movie-grid[data-columns="5"] .movie-grid { grid-template-columns: repeat(5, 1fr); }
  .wp-block-letterboxd-connect-movie-grid[data-columns="6"] .movie-grid { grid-template-columns: repeat(6, 1fr); }
  
  .movie-item .movie-meta { display: flex; flex-direction: column; gap: var(--grid-gap); }
  .external-links-list { margin-top: 0; }
}



@supports not (aspect-ratio: 2/3) { .movie-item .movie-poster { position: relative; width: 100%; padding-top: 150%; width: var(--thumbnail-width); height: calc(var(--thumbnail-width) * 1.5); } }

================
File: includes/interfaces/interface-letterboxd-api-service.php
================
<?php
/**
 * Interface for Letterboxd API service
 * 
 * @package letterboxd-connect
 * @since 1.1.0
 */
interface LetterboxdApiServiceInterface {
	// In interface-letterboxd-api-service.php
	/**
	 * Validates a date format
	 * 
	 * @param string $date Date string to validate
	 * @return bool Whether the date is valid
	 */
	public function validateDate(string $date): bool;
	
	/**
	 * Validates a Letterboxd username
	 * 
	 * @param string $username The username to validate
	 * @return bool|WP_Error True if valid, WP_Error if invalid
	 */
	public function validateUsername(string $username): bool|WP_Error;
	
	/**
	 * Checks if a TMDB API key is valid
	 * 
	 * @param string $api_key The API key to validate
	 * @return bool|WP_Error True if valid, WP_Error if invalid
	 */
	public function checkTmdbApiKey(string $api_key): bool|WP_Error;
	
	/**
	 * Creates a TMDB request token
	 * 
	 * @param string $api_key TMDB API key
	 * @return array|WP_Error Response data or error
	 */
	public function createTmdbRequestToken(string $api_key): array|WP_Error;
	
	/**
	 * Creates a TMDB session with an authorized request token
	 * 
	 * @param string $api_key TMDB API key
	 * @param string $request_token Authorized request token
	 * @return array|WP_Error Response data or error
	 */
	public function createTmdbSession(string $api_key, string $request_token): array|WP_Error;
}

================
File: includes/services/class-letterboxd-api-service.php
================
<?php
/**
 * Letterboxd API Service implementation
 *
 * @package letterboxd-connect
 * @since 1.1.0
 */
class LetterboxdApiService implements LetterboxdApiServiceInterface {
	/**
	 * Validate date format and range
	 *
	 * @param string $date Date string to validate
	 * @return bool Whether the date is valid
	 */
	public function validateDate(string $date): bool {
		if (empty($date)) {
			return true;
		}

		$timestamp = strtotime($date);
		return $timestamp !== false &&
			$timestamp <= time() &&
			preg_match('/^\d{4}-\d{2}-\d{2}$/', $date);
	}

	/**
	 * Username constraints
	 */
	public const USERNAME_MIN_LENGTH = 2;
	public const USERNAME_MAX_LENGTH = 15;
	public const USERNAME_PATTERN = '/^[a-z0-9][a-z0-9-]*[a-z0-9]$/';

	/**
	 * Validates a Letterboxd username
	 *
	 * @param string $username The username to validate
	 * @return bool|WP_Error True if valid, WP_Error if invalid
	 */
	public function validateUsername(string $username): bool|WP_Error {
		$username = trim($username);

		if (empty($username)) {
			return new WP_Error(
				"empty_username",
				__("Username cannot be empty.", "letterboxd-connect")
			);
		}

		if (
			strlen($username) < self::USERNAME_MIN_LENGTH ||
			strlen($username) > self::USERNAME_MAX_LENGTH
		) {
			return new WP_Error(
				"invalid_length",
				sprintf(
					/* translators: 1: Minimum username length, 2: Maximum username length */
					__(
						"Username must be between %1\$d and %2\$d characters.",
						"letterboxd-connect"
					),
					self::USERNAME_MIN_LENGTH,
					self::USERNAME_MAX_LENGTH
				)
			);
		}

		if (!preg_match(self::USERNAME_PATTERN, $username)) {
			return new WP_Error(
				"invalid_format",
				__(
					"Username can only contain lowercase letters, numbers, and hyphens. It cannot start or end with a hyphen.",
					"letterboxd-connect"
				)
			);
		}

		return true;
	}

	/**
	 * Checks if a TMDB API key is valid
	 *
	 * @param string $api_key The API key to validate
	 * @return bool|WP_Error True if valid, WP_Error if invalid
	 */
	public function checkTmdbApiKey(string $api_key): bool|WP_Error {
		if (empty($api_key)) {
			return new WP_Error(
				"empty_api_key",
				__("API key cannot be empty.", "letterboxd-connect")
			);
		}

		$response = wp_remote_get(
			"https://api.themoviedb.org/3/configuration?api_key=" . $api_key,
			[
				"timeout" => 15,
				"sslverify" => true,
			]
		);

		if (is_wp_error($response)) {
			return $response;
		}

		$response_code = wp_remote_retrieve_response_code($response);

		if ($response_code !== 200) {
			$body = wp_remote_retrieve_body($response);
			$data = json_decode($body, true);
			$error_message = isset($data["status_message"])
				? $data["status_message"]
				: "Unknown error";

			return new WP_Error(
				"tmdb_api_error",
				sprintf(
					/* translators: 1: Response code, 2: Error message */
					__("API error (%1\$d): %2\$s", "letterboxd-connect"),
					$response_code,
					$error_message
				)
			);
		}

		return true;
	}

	/**
	 * Creates a TMDB request token
	 *
	 * @param string $api_key TMDB API key
	 * @return array|WP_Error Response data or error
	 */
	public function createTmdbRequestToken(string $api_key): array|WP_Error {
		if (empty($api_key)) {
			return new WP_Error(
				"empty_api_key",
				__("API key is not configured.", "letterboxd-connect")
			);
		}

		$response = wp_remote_get(
			"https://api.themoviedb.org/3/authentication/token/new?api_key={$api_key}",
			["timeout" => 15]
		);

		if (is_wp_error($response)) {
			return $response;
		}

		$body = json_decode(wp_remote_retrieve_body($response), true);

		if (empty($body["success"]) || empty($body["request_token"])) {
			return new WP_Error(
				"tmdb_token_error",
				$body["status_message"] ??
					__(
						"Failed to create request token.",
						"letterboxd-connect"
					)
			);
		}

		return [
			"success" => true,
			"request_token" => $body["request_token"],
		];
	}

	/**
	 * Creates a TMDB session with an authorized request token
	 *
	 * @param string $api_key TMDB API key
	 * @param string $request_token Authorized request token
	 * @return array|WP_Error Response data or error
	 */
	public function createTmdbSession(
		string $api_key,
		string $request_token
	): array|WP_Error {
		if (empty($api_key)) {
			return new WP_Error(
				"empty_api_key",
				__("API key is not configured.", "letterboxd-connect")
			);
		}

		$response = wp_remote_post(
			"https://api.themoviedb.org/3/authentication/session/new?api_key={$api_key}",
			[
				"body" => json_encode(["request_token" => $request_token]),
				"headers" => ["Content-Type" => "application/json"],
				"timeout" => 15,
			]
		);

		if (is_wp_error($response)) {
			return $response;
		}

		$body = json_decode(wp_remote_retrieve_body($response), true);

		if (empty($body["success"]) || empty($body["session_id"])) {
			return new WP_Error(
				"tmdb_session_error",
				$body["status_message"] ??
					__("Failed to create session.", "letterboxd-connect")
			);
		}

		return [
			"success" => true,
			"session_id" => $body["session_id"],
		];
	}
}

================
File: includes/traits/trait-letterboxd-error-handling.php
================
<?php
/**
 * Error handling functionality for Letterboxd plugin
 *
 * @package letterboxd-connect
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

trait LetterboxdErrorHandling {
    
    /**
     * @var array Stores errors that occur during processing
     */
    private $errors = [];

    /**
     * Enhanced error logging with severity levels
     */
    private function log_error($message, $severity = self::SEVERITY_ERROR, $context = []): void {
        $error = [
            'timestamp' => current_time('mysql'),
            'severity' => $severity,
            'message' => $message,
            'context' => $context
        ];
        
        if (defined('WP_DEBUG') && WP_DEBUG) {
            $error['debug'] = [
                'memory_usage' => memory_get_usage(true),
                'backtrace' => debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 3)
            ];
        }
        
        $this->errors[] = $error;
        
        // Keep only last 50 errors
        if (count($this->errors) > 50) {
            array_shift($this->errors);
        }
        
        update_option('letterboxd_error_log', $this->errors);
    }

    /**
     * Get all errors that occurred during processing
     * 
     * @return array Array of errors
     */
    public function get_errors() {
        return $this->errors;
    }

    /**
     * Clear all stored errors
     */
    public function clear_errors() {
        $this->errors = [];
        delete_option('letterboxd_error_log');
    }

    /**
     * Display admin notices for errors
     */
    public function display_admin_notices() {
        if (!current_user_can('manage_options')) {
            return;
        }

        $screen = get_current_screen();
        if ($screen->id !== 'settings_page_letterboxd-connect') {
            return;
        }

        $errors = $this->get_errors();
        foreach ($errors as $error) {
            $class = 'notice notice-' . ($error['severity'] === 'error' ? 'error' : 'warning');
            printf(
                '<div class="%1$s"><p>%2$s</p></div>',
                esc_attr($class),
                esc_html($error['message'])
            );
        }
    }
}

================
File: includes/traits/trait-letterboxd-security.php
================
<?php
/**
 * Security measures for Letterboxd plugin
 *
 * @package letterboxd-connect
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

trait LetterboxdSecurity {
    /**
     * Verify nonce and user capabilities with additional security checks
     */
    private function verify_request($nonce_name, $action) {

        // rate limiting
        if ($this->is_rate_limited()) {
            return new WP_Error(
                'rate_limit_exceeded',
                __('Too many requests. Please try again later.', 'letterboxd-connect')
            );
        }

        // Check user capabilities first
        if (!current_user_can('manage_options')) {
            return new WP_Error(
                'insufficient_permissions',
                __('You do not have permission to perform this action.', 'letterboxd-connect')
            );
        }

        // Verify request method
        if (!isset($_SERVER['REQUEST_METHOD']) || 
            !in_array($_SERVER['REQUEST_METHOD'], ['GET', 'POST'])) {
            return new WP_Error(
                'invalid_request_method',
                __('Invalid request method.', 'letterboxd-connect')
            );
        }

        // Check referer
        if (!check_admin_referer($action, $nonce_name)) {
            return new WP_Error(
                'invalid_nonce',
                __('Security check failed. Please refresh the page and try again.', 'letterboxd-connect')
            );
        }

        return true;
    }

    /**
     * Verify AJAX nonce
     *
     * @throws Exception If nonce verification fails
     */
    private function verify_ajax_nonce(): void {
        if (!check_ajax_referer('letterboxd_ajax_action', 'nonce', false)) {
            throw new Exception(
            esc_html__('Invalid security token. Please refresh the page.', 'letterboxd-connect')
            );
        }

        // Additional AJAX security checks
        if (!wp_doing_ajax()) {
            throw new Exception(
            esc_html__('Invalid request method.', 'letterboxd-connect')
            );
        }
    }

    /**
     * Enhanced sanitization and validation of options
     */
    private function sanitize_options($options) {
        $sanitized = [];

        // Username
        if (isset($options['username'])) {
            $username = sanitize_text_field($options['username']);
            $validation = $this->validate_letterboxd_username($username);
            if (!is_wp_error($validation)) {
                $sanitized['username'] = $username;
            }
        }

        // Start date
        if (isset($options['start_date'])) {
            $date = sanitize_text_field($options['start_date']);
            $validation = $this->validate_date($date);
            if (!is_wp_error($validation)) {
                $sanitized['start_date'] = $date;
            }
        }

        // Draft status
        $sanitized['draft_status'] = isset($options['draft_status']);

        // Import limit
        if (isset($options['import_limit'])) {
            $limit = absint($options['import_limit']);
            $validation = $this->validate_import_limit($limit);
            if (!is_wp_error($validation)) {
                $sanitized['import_limit'] = $limit;
            }
        }
        
        if (isset($options['email'])) {
            $sanitized['email'] = sanitize_email($options['email']);
        }

        if (isset($options['url'])) {
            $sanitized['url'] = esc_url_raw($options['url']);
        }

        // Validate and sanitize arrays
        if (isset($options['settings']) && is_array($options['settings'])) {
            $sanitized['settings'] = array_map('sanitize_text_field', $options['settings']);
        }

        return $sanitized;
    }
    
    /**
     * Check if request is rate limited
     */
    private function is_rate_limited(): bool {
        // Skip rate limiting in debugging environment
        if (defined('WP_DEBUG') && WP_DEBUG) {
            return false;
        }
        
        $rate_key = 'letterboxd_rate_limit';
        $rate_window = 60; // 1 minute window
        $max_requests = 10; // Max requests per window
        
        $current_requests = (int) get_transient($rate_key);
        
        if ($current_requests >= $max_requests) {
            return true;
        }
        
        if ($current_requests === 0) {
            set_transient($rate_key, 1, $rate_window);
        } else {
            set_transient($rate_key, $current_requests + 1, $rate_window);
        }
        
        return false;
    }
    
}

================
File: includes/traits/trait-letterboxd-validation.php
================
<?php
/**
 * Validation functionality for Letterboxd plugin
 *
 * @package letterboxd-connect
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

trait LetterboxdValidation {
    /**
     * Enhanced username validation
     * 
     * @param string $username The username to validate
     * @return bool|WP_Error Returns true if valid, WP_Error if invalid
     */
    private function validate_letterboxd_username($username) {
        // Remove any whitespace
        $username = trim($username);

        // Basic checks
        if (empty($username)) {
            return new WP_Error(
                'invalid_username',
                __('Username cannot be empty.', 'letterboxd-connect')
            );
        }

        // Letterboxd username rules:
        // - Must be between 2 and 15 characters
        // - Can only contain letters, numbers, hyphens
        // - Cannot start or end with a hyphen
        if (strlen($username) < 2 || strlen($username) > 15) {
            return new WP_Error(
                'invalid_username_length',
                __('Username must be between 2 and 15 characters.', 'letterboxd-connect')
            );
        }

        if (!preg_match('/^[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$/', $username)) {
            return new WP_Error(
                'invalid_username_format',
                __('Username can only contain letters, numbers, and hyphens, and cannot start or end with a hyphen.', 'letterboxd-connect')
            );
        }

        // Additional checks for username
        if (preg_match('/--/', $username)) {
            return new WP_Error(
                'invalid_username_format',
                __('Username cannot contain consecutive hyphens.', 'letterboxd-connect')
            );
        }

        if (preg_match('/[A-Z]/', $username)) {
            return new WP_Error(
                'invalid_username_case',
                __('Username must be lowercase.', 'letterboxd-connect')
            );
        }

        return true;
    }

    /**
     * Enhanced date validation
     * 
     * @param string $date The date to validate
     * @return bool|WP_Error Returns true if valid, WP_Error if invalid
     */
    private function validate_date($date) {
        if (empty($date)) {
            return true;
        }

        // Check format
        if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $date)) {
            return new WP_Error(
                'invalid_date_format',
                __('Date must be in YYYY-MM-DD format.', 'letterboxd-connect')
            );
        }

        // Validate date components
        $parts = explode('-', $date);
        if (!checkdate($parts[1], $parts[2], $parts[0])) {
            return new WP_Error(
                'invalid_date',
                __('The provided date is not valid.', 'letterboxd-connect')
            );
        }

        // Check if date is not in future
        if (strtotime($date) > time()) {
            return new WP_Error(
                'future_date',
                __('The date cannot be in the future.', 'letterboxd-connect')
            );
        }

        return true;
    }

    /**
     * Validate import limit
     * 
     * @param int $limit The limit to validate
     * @return bool|WP_Error Returns true if valid, WP_Error if invalid
     */
    private function validate_import_limit($limit) {
        $limit = intval($limit);
        if ($limit < 1 || $limit > 100) {
            return new WP_Error(
                'invalid_import_limit',
                __('Import limit must be between 1 and 100.', 'letterboxd-connect')
            );
        }

        return true;
    }
}

================
File: includes/class-letterboxd-importer.php
================
<?php
/**
 * Handles the import of movies from Letterboxd
 *
 * @package letterboxd-connect
 * @since 1.0.0
 */

declare(strict_types=1);

// Prevent direct access
if (!defined("ABSPATH")) {
    exit();
}

class Letterboxd_Importer {
    use LetterboxdValidation;
    use LetterboxdErrorHandling;
    use LetterboxdSecurity;

    private function debug_log($message) {
        letterboxd_debug_log($message, "Importer");
    }

    /**
     * Cache and import constants
     */
    private const CACHE_GROUP = "letterboxd_to_wp_import";
    private const FEED_CACHE_DURATION = 3600; // 1 hour
    private const IMPORT_LOCK_DURATION = 300; // 5 minutes
    private const MAX_FEED_SIZE = 10485760; // 10MB
    private const REQUEST_TIMEOUT = 30; // 30 seconds

    /**
     * Feed URL format
     */
    private const FEED_URL_FORMAT = "https://letterboxd.com/%s/rss/";

    /**
     * Import response structure
     */
    private const IMPORT_RESPONSE = [
        "imported" => 0,
        "status" => "",
        "message" => ""
    ];

    /**
     * @var Letterboxd_Movie_Post_Type
     */
    private Letterboxd_Movie_Post_Type $post_type;

    /**
     * @var Letterboxd_TMDB_Handler
     */
    private ?Letterboxd_TMDB_Handler $tmdb_handler = null;

    /**
     * Class constructor
     *
     * @param Letterboxd_Movie_Post_Type $post_type Movie post type handler
     */
    public function __construct(Letterboxd_Movie_Post_Type $post_type) {
        $this->post_type = $post_type;
        $this->tmdb_handler = new Letterboxd_TMDB_Handler();
    }

    /**
     * Import movies from Letterboxd feed
     *
     * @param array $options Import options
     * @return array Import results
     */
    /**
     * Import movies from Letterboxd feed
     */
    public function import_movies(
        array $options,
        bool $automated = true
    ): array {
        try {
            if (!$this->can_import()) {
                throw new Exception(
                    __(
                        "Another import is currently running.",
                        "letterboxd-connect"
                    )
                );
            }

            // Only validate request if not automated
            if (!$automated) {
                $this->validate_import_request($options);
            }

            $this->set_import_lock();

            $username =
                $options["username"] ??
                (get_option("letterboxd_wordpress_options")["username"] ?? "");
            if (empty($username)) {
                throw new Exception(
                    __(
                        "No Letterboxd username configured.",
                        "letterboxd-connect"
                    )
                );
            }

            $feed_items = $this->fetch_feed($username);
            letterboxd_debug_log(
                "Fetched " . count($feed_items) . " items from feed"
            );

            $result = $this->process_feed_items($feed_items, $options);

            update_option("letterboxd_last_import", time());

            $this->clear_import_lock();
            return $result;
        } catch (Exception $e) {
            letterboxd_debug_log("Import error: " . $e->getMessage());
            $this->handle_import_error($e, $options);
            return $this->get_error_response($e->getMessage());
        }
    }

    /**
     * Set import lock
     */
    private function set_import_lock(): void {
        wp_cache_set(
            "import_lock",
            time(),
            self::CACHE_GROUP,
            self::IMPORT_LOCK_DURATION
        );
    }

    /**
     * Check if import can run
     */
    private function can_import(): bool {
        $lock_time = wp_cache_get("import_lock", self::CACHE_GROUP);
        if (!$lock_time) {
            return true;
        }
        // Clear stale lock after 5 minutes
        if (time() - $lock_time > 300) {
            wp_cache_delete("import_lock", self::CACHE_GROUP);
            return true;
        }
        return false;
    }

    /**
     * Clear import lock
     */
    private function clear_import_lock(): void {
        wp_cache_delete("import_lock", self::CACHE_GROUP);
    }

    /**
     * Validate import request and options
     */
    private function validate_import_request(array $options): void {
        if (
            !$this->verify_request(
                "letterboxd_import_nonce",
                "letterboxd_import_action"
            )
        ) {
            throw new Exception(
                esc_html__("Security check failed", "letterboxd-connect")
            );
        }

        $username_validation = $this->validate_letterboxd_username(
            $options["username"]
        );
        if (is_wp_error($username_validation)) {
            throw new Exception(esc_html($username_validation->get_error_message()));
        }

        if (!empty($options["start_date"])) {
            $date_validation = $this->validate_date($options["start_date"]);
            if (is_wp_error($date_validation)) {
                throw new Exception(esc_html($date_validation->get_error_message()));
            }
        }
    }

    /**
     * Fetch and parse Letterboxd RSS feed based on username
     */
    private function fetch_feed(string $username): array {
        $cache_key = "feed_" . md5($username);
        $feed_items = wp_cache_get($cache_key, self::CACHE_GROUP);

        if ($feed_items === false) {
            $feed_url = sprintf(self::FEED_URL_FORMAT, urlencode($username));
            $response = $this->fetch_feed_content($feed_url);
            $feed_items = $this->parse_feed_content($response);

            wp_cache_set(
                $cache_key,
                $feed_items,
                self::CACHE_GROUP,
                self::FEED_CACHE_DURATION
            );
        }

        return $feed_items;
    }

    /**
     * Fetch feed content of user's Letterboxd feed with error handling
     */
    private function fetch_feed_content(string $url): string {
        letterboxd_debug_log("Attempting to fetch feed from: " . $url);
        $response = wp_remote_get($url, [
            "timeout" => self::REQUEST_TIMEOUT,
            "user-agent" => "WordPress/Letterboxd-Importer-Plugin",
            "headers" => ["Accept" => "application/rss+xml"],
            "sslverify" => true
        ]);

        if (is_wp_error($response)) {
            throw new Exception(
                sprintf(
                    // translators: %s: Error message
                    esc_html__(
                        "Failed to fetch Letterboxd feed: %s",
                        "letterboxd-connect"
                    ),
                    esc_html($response->get_error_message())
                )
            );
        }

        $status_code = wp_remote_retrieve_response_code($response);
        if ($status_code !== 200) {
            throw new Exception(
                sprintf(
                    // translators: %d: HTTP status code
                    esc_html__(
                        "Failed to fetch Letterboxd feed: HTTP %d",
                        "letterboxd-connect"
                    ),
                    intval($status_code)
                )
            );
        }

        $content = wp_remote_retrieve_body($response);

        letterboxd_debug_log(
            "Fetched feed content: " . substr($content, 0, 500)
        );

        if (empty($content)) {
            throw new Exception(
                esc_html__("Empty feed content received", "letterboxd-connect")
            );
        }

        if (strlen($content) > self::MAX_FEED_SIZE) {
            throw new Exception(
                esc_html__(
                    "Feed content exceeds maximum size limit",
                    "letterboxd-connect"
                )
            );
        }

        return $content;
    }

    /**
     * Parse feed content using XMLReader for memory efficiency
     */
    private function parse_feed_content(string $content): array {
        $debug = defined("WP_DEBUG") && WP_DEBUG;
        if ($debug) {
            letterboxd_debug_log("Starting feed parse");
        }
        $reader = new XMLReader();
        try {
            if (
                !$reader->XML(
                    $content,
                    "UTF-8",
                    LIBXML_NOERROR | LIBXML_NOWARNING
                )
            ) {
                if ($debug) {
                    letterboxd_debug_log("Failed to parse XML content");
                }
                throw new Exception("Failed to parse feed content");
            }
            $items = [];
            $current_item = null;
            $current_tag = "";

            while ($reader->read()) {
                if ($reader->nodeType === XMLReader::ELEMENT) {
                    if ($reader->name === "item") {
                        letterboxd_debug_log("Found new item element");
                        $current_item = [
                            "title" => "",
                            "link" => "",
                            "pubDate" => "",
                            "description" => "",
                            "filmYear" => "",
                            "poster_url" => ""
                        ];
                    } elseif ($current_item !== null) {
                        $current_tag = $reader->name;
                        if ($current_tag === "letterboxd:filmYear") {
                            $current_item["filmYear"] = $reader->readString();
                            continue;
                        } elseif ($current_tag === "tmdb:movieId") {
                            //check feed for a movieID to ensure that we're only pulling over movies and not lists
                            $current_item[
                                "tmdb_movieId"
                            ] = $reader->readString();
                            continue;
                        }
                    }
                } elseif (
                    ($reader->nodeType === XMLReader::TEXT ||
                        $reader->nodeType === XMLReader::CDATA) &&
                    $current_item !== null
                ) {
                    $this->update_current_item(
                        $current_item,
                        $current_tag,
                        $reader->value
                    );
                } elseif (
                    $reader->nodeType === XMLReader::END_ELEMENT &&
                    $reader->name === "item"
                ) {
                    letterboxd_debug_log(
                        "Completed item: " .
                            ($current_item["title"] ?? "unknown")
                    );

                    // Extract poster URL from description
                    if (!empty($current_item["description"])) {
                        letterboxd_debug_log(
                            "Description content: " .
                                $current_item["description"]
                        );

                        // Updated regex pattern to match Letterboxd's image structure
                        if (
                            preg_match(
                                '/<img[^>]+src=[\'"]([^\'"]+\.(?:jpg|jpeg|png|gif)(?:\?[^\'"]*)?)[\'"][^>]*>/i',
                                $current_item["description"],
                                $matches
                            )
                        ) {
                            $current_item["poster_url"] = $matches[1];
                            letterboxd_debug_log(
                                "Found poster URL: " .
                                    $current_item["poster_url"]
                            );
                        } else {
                            letterboxd_debug_log(
                                "No poster URL found with pattern match"
                            );
                            letterboxd_debug_log(
                                "Description content: " .
                                    $current_item["description"]
                            );
                        }
                    }

                    //letterboxd_debug_log('Completed item: ' . print_r($current_item, true));

                    // Exclude items that do not have a <tmdb:movieId>
                    if (empty($current_item["tmdb_movieId"])) {
                        letterboxd_debug_log(
                            "Excluding item (Missing tmdb:movieId): " .
                                $current_item["title"]
                        );
                        $current_item = null;
                        continue;
                    }

                    $items[] = $current_item;
                    $current_item = null;
                }
            }
            return $items;
        } catch (Exception $e) {
            letterboxd_debug_log("Feed parsing error: " . $e->getMessage());
            throw $e;
        } finally {
            $reader->close();
        }
    }

    /**
     * Update current item data
     */
    private function update_current_item(
        array &$item,
        string $tag,
        string $value
    ): void {
        // Create a static property for allowed tags
        static $allowed_tags = [
            "title" => true,
            "link" => true,
            "pubDate" => true,
            "description" => true,
            "letterboxd:filmYear" => true
        ];
        if (isset($allowed_tags[$tag])) {
            $value = trim($value);
            if (substr($value, 0, 9) === "<![CDATA[") {
                $value = substr($value, 9, -3);
            }
            if ($tag === "letterboxd:filmYear") {
                $item["filmYear"] = $value;
            } else {
                $item[$tag] = isset($item[$tag])
                    ? $item[$tag] . $value
                    : $value;
            }
        }
    }

    /**
     * Process feed items
     */
    private function process_feed_items(
        array $feed_items,
        array $options
    ): array {
        $start_date = !empty($options["start_date"])
            ? strtotime($options["start_date"])
            : 0;
        $imported = 0;

        foreach ($feed_items as $item) {
            $pub_date = strtotime($item["pubDate"]);
            if ($start_date && $pub_date < $start_date) {
                continue;
            }

            if ($this->import_movie($item, $options)) {
                $imported++;
            }
        }

        return [
            "imported" => $imported,
            "status" => "success",
            "message" => sprintf(
                /* translators: %d: Number of imported movies */
                __(
                    "Successfully imported %d new movies.",
                    "letterboxd-connect"
                ),
                $imported
            )
        ];
    }

    /**
     * Import individual movie.
     */
    private function import_movie(array $item, array $options): bool {
        if ($this->post_type->movie_exists($item["link"])) {
            return false;
        }

        $movie_data = $this->prepare_movie_data($item, $options);
        $post_id = wp_insert_post($movie_data);

        if (!is_wp_error($post_id) && $post_id > 0) {
            // Ensure the $item array contains the parsed rating for consistency.
            $parsed = $this->parse_movie_title_and_rating($item["title"]);
            $item["rating"] = $parsed["rating"];

            $this->set_movie_meta($post_id, $item);
            $this->set_movie_terms($post_id, $item);

            // Add TMDB data enrichment here
            if (!empty($item["tmdb_movieId"])) {
                $this->enrich_with_tmdb_data($post_id, $item["tmdb_movieId"]);
            }

            return true;
        }

        return false;
    }

    /**
     * Parse the movie title string into its components using named capture groups.
     * Optimized for better performance and reliability.
     *
     * @param string $title The raw title string from the feed.
     * @return array{title: string, year: string, rating: string} Structured movie data
     */
    private function parse_movie_title_and_rating(string $title): array {
        // Use named capture groups and a stricter year pattern
        $pattern =
            '/^(?P<title>.*),\s*(?P<year>\d{4})(?:\s*-\s*(?P<rating>.*))?$/u';

        if (preg_match($pattern, $title, $matches)) {
            // Use array_filter to remove empty matches while preserving keys
            $matches = array_filter(
                $matches,
                "is_string",
                ARRAY_FILTER_USE_KEY
            );

            return [
                "title" => trim($matches["title"] ?? ""),
                "year" => trim($matches["year"] ?? ""),
                "rating" => isset($matches["rating"])
                    ? trim($matches["rating"])
                    : ""
            ];
        }

        // Log parsing failure for monitoring
        letterboxd_debug_log(sprintf("Movie title parsing failed: %s", $title));

        return [
            "title" => $title,
            "year" => "",
            "rating" => ""
        ];
    }

    /**
     * Extracted images from the feed content.
     *
     * @var array
     */
    private array $extracted_images = [];

    /**
     * Convert movie description to Gutenberg paragraph blocks and extract images.
     *
     * @param string $content Raw HTML content from Letterboxd.
     * @return string Content formatted as Gutenberg paragraph blocks.
     */
    private function convert_to_blocks(string $content): string {
        $blocks = [];
        // Clear any previously extracted images.
        $this->extracted_images = [];

        // Use regex to extract all <p>...</p> blocks.
        if (preg_match_all("/<p\b[^>]*>.*?<\/p>/is", $content, $matches)) {
            foreach ($matches[0] as $pBlock) {
                // Check if the <p> block contains an <img> tag.
                if (strpos($pBlock, "<img") !== false) {
                    // Extract all image URLs from this paragraph.
                    if (
                        preg_match_all(
                            '/<img[^>]+src=[\'"]([^\'"]+)[\'"][^>]*>/i',
                            $pBlock,
                            $imgMatches
                        )
                    ) {
                        foreach ($imgMatches[1] as $imgUrl) {
                            $this->extracted_images[] = esc_url($imgUrl);
                        }
                    }
                    // Skip this paragraph entirely.
                    continue;
                }

                // Otherwise, preserve the paragraph as is.
                $blocks[] = "<!-- wp:paragraph -->";
                $blocks[] = $pBlock;
                $blocks[] = "<!-- /wp:paragraph -->";
            }
        } else {
            // If no <p> tags are found, fall back to a simple wrap.
            $blocks[] = "<!-- wp:paragraph -->";
            $blocks[] = "<p>" . wp_kses_post($content) . "</p>";
            $blocks[] = "<!-- /wp:paragraph -->";
        }

        return implode("\n", $blocks);
    }

    /**
     * Prepare movie post data with Gutenberg block support
     *
     * @param array $item Raw movie data
     * @param array $options Processing options
     * @return array Prepared post data
     */
    private function prepare_movie_data(array $item, array $options): array {
        // Early validation of required fields
        if (empty($item["title"]) || empty($item["description"])) {
            throw new Exception(
                esc_html__("Missing required movie data fields", "letterboxd-connect")
            );
        }

        // Parse title components once and cache result
        $parsed = $this->parse_movie_title_and_rating($item["title"]);

        // Convert description to blocks
        $block_content = $this->convert_to_blocks($item["description"]);

        // Prepare all meta data
        $meta_input = [
            "letterboxd_url" => $item["link"] ?? "",
            "watch_date" => !empty($item["pubDate"])
                ? gmdate("Y-m-d", strtotime($item["pubDate"]))
                : "",
            "poster_url" => $item["poster_url"] ?? "",
            "movie_rating" => $parsed["rating"],
            "movie_year" => $parsed["year"],
            "tmdb_movie_id" => $item["tmdb_movieId"] ?? ""
        ];

        // Return complete post data including meta_input
        return [
            "post_title" => sanitize_text_field($parsed["title"]),
            "post_content" => $block_content,
            "post_status" => !empty($options["draft_status"])
                ? "draft"
                : "publish",
            "post_type" => "movie",
            "meta_input" => array_filter($meta_input) // Remove empty values
        ];
    }

    /**
     * Set movie meta data using optimized bulk operations.
     *
     * @param int $post_id Post ID.
     * @param array $item Movie data.
     */
    private function set_movie_meta(int $post_id, array $item): void {
        try {
            // Validate post exists.
            if (!get_post($post_id)) {
                throw new Exception(sprintf("Invalid post ID: %d", $post_id));
            }

            $poster_url = $item["poster_url"] ?? "";

            // Use wp_update_post for bulk meta update.
            $update_result = wp_update_post(
                [
                    "ID" => $post_id,
                    "meta_input" => [
                        "letterboxd_url" => $item["link"] ?? "",
                        "watch_date" => !empty($item["pubDate"])
                            ? gmdate("Y-m-d", strtotime($item["pubDate"]))
                            : "",
                        "poster_url" => $poster_url,
                        "movie_rating" => $item["rating"] ?? "",
                        "tmdb_movie_id" => $item["tmdb_movieId"] ?? "" // Added TMDB movie ID
                    ]
                ],
                true
            ); // Return WP_Error on failure.

            if (is_wp_error($update_result)) {
                throw new Exception($update_result->get_error_message());
            }

            // Handle poster import if URL exists and no featured image is set.
            if (!empty($poster_url) && !has_post_thumbnail($post_id)) {
                $this->handle_poster_import($post_id, $poster_url);
            }
        } catch (Exception $e) {
            letterboxd_debug_log(
                sprintf(
                    "Error setting movie meta for post %d: %s",
                    $post_id,
                    $e->getMessage()
                )
            );
            // Let the calling function handle the error based on context.
            throw $e;
        }
    }

    /**
     * Handling image import and featured image setting using media_handle_sideload()
     */
    private function handle_poster_import(
        int $post_id,
        string $poster_url
    ): void {
        // Check if the post exists
        if (!get_post($post_id)) {
            letterboxd_debug_log(
                "Cannot import poster: Invalid post ID " . $post_id
            );
            return;
        }

        // Include required WordPress files for media handling.
        require_once ABSPATH . "wp-admin/includes/file.php";
        require_once ABSPATH . "wp-admin/includes/media.php";
        require_once ABSPATH . "wp-admin/includes/image.php";

        // Download the remote image to a temporary file.
        $tmp_file = download_url($poster_url, 30); // 30 seconds timeout.
        if (is_wp_error($tmp_file)) {
            letterboxd_debug_log(
                "Failed to download poster: " . $tmp_file->get_error_message()
            );
            return;
        }

        // Prepare a file array similar to a $_FILES entry.
        $file_array = [];
        // Extract a filename from the URL. Fallback to a default if needed.
        $parsed_url = wp_parse_url($poster_url, PHP_URL_PATH);
        $file_array["name"] = basename($parsed_url);
        if (empty($file_array["name"])) {
            $file_array["name"] = "poster.jpg";
        }
        $file_array["tmp_name"] = $tmp_file;

        // Get movie title and watch date for metadata.
        $movie_title = get_the_title($post_id);
        $watch_date = get_post_meta($post_id, "watch_date", true);

        // Sideload the image and attach it to the post.
        $attach_id = media_handle_sideload($file_array, $post_id, $movie_title);
        if (is_wp_error($attach_id)) {
            letterboxd_debug_log(
                "Failed to sideload image: " . $attach_id->get_error_message()
            );
            // Cleanup temporary file if needed.
            global $wp_filesystem;
            if (empty($wp_filesystem)) {
                require_once(ABSPATH . '/wp-admin/includes/file.php');
                WP_Filesystem();
            }
            $wp_filesystem->delete($file_array["tmp_name"]);
            return;
        }

        // Build an appropriate alt text.
        if (!empty($watch_date) && strtotime($watch_date)) {
            $formatted_date = date_i18n(
                get_option("date_format"),
                strtotime($watch_date)
            );
            $alt_text = sprintf(
                "I watched %s on %s",
                $movie_title,
                $formatted_date
            );
        } else {
            $alt_text = sprintf("I watched %s", $movie_title);
        }
        update_post_meta($attach_id, "_wp_attachment_image_alt", $alt_text);

        // Generate and update attachment metadata.
        $file_path = get_attached_file($attach_id);
        $attach_data = wp_generate_attachment_metadata($attach_id, $file_path);
        if (is_wp_error($attach_data)) {
            letterboxd_debug_log(
                "Failed to generate attachment metadata: " .
                    $attach_data->get_error_message()
            );
            return;
        }

        $update_result = wp_update_attachment_metadata(
            $attach_id,
            $attach_data
        );
        if (is_wp_error($update_result)) {
            letterboxd_debug_log(
                "Failed to update attachment metadata: " .
                    $update_result->get_error_message()
            );
        }

        // Set the sideloaded image as the featured image.
        if (!set_post_thumbnail($post_id, $attach_id)) {
            letterboxd_debug_log(
                "Failed to set featured image for post ID: " . $post_id
            );
        }
    }

    /**
     * Set movie terms
     */
    private function set_movie_terms(int $post_id, array $item): void {
        if (!empty($item["filmYear"])) {
            $year = sanitize_text_field($item["filmYear"]);
            $result = wp_set_object_terms($post_id, $year, "movie_year");
        }
    }

    private function enrich_with_tmdb_data(
        int $post_id,
        string $tmdb_movie_id
    ): void {
        // Skip if TMDB API is not configured
        if (!$this->tmdb_handler->is_api_key_configured()) {
            letterboxd_debug_log(
                "TMDB enrichment skipped: API key not configured."
            );
            return;
        }

        // Skip if movie ID is missing or invalid
        if (empty($tmdb_movie_id) || !is_numeric($tmdb_movie_id)) {
            letterboxd_debug_log(
                "TMDB enrichment skipped: Invalid movie ID: " . $tmdb_movie_id
            );
            return;
        }

        $movie_id = intval($tmdb_movie_id);

        // Check if we already have complete TMDB data for this post
        $has_tmdb_data = get_post_meta($post_id, "director", true);
        if (!empty($has_tmdb_data)) {
            letterboxd_debug_log(
                "TMDB enrichment skipped: Movie already has TMDB data"
            );
            return;
        }

        try {
            // Fetch movie details from TMDB
            $movie_data = $this->tmdb_handler->get_movie_details($movie_id);

            if (is_wp_error($movie_data)) {
                letterboxd_debug_log(
                    "TMDB API error: " . $movie_data->get_error_message()
                );
                return;
            }

            // Extract and save metadata
            $metadata = $this->tmdb_handler->extract_movie_metadata(
                $movie_data
            );

            foreach ($metadata as $meta_key => $meta_value) {
                if (!empty($meta_value)) {
                    update_post_meta($post_id, $meta_key, $meta_value);
                }
            }

            letterboxd_debug_log(
                "TMDB enrichment complete for movie: " . get_the_title($post_id)
            );
        } catch (Exception $e) {
            letterboxd_debug_log("TMDB enrichment error: " . $e->getMessage());
        }
    }

    /**
     * Handle import error
     */
    private function handle_import_error(Exception $e, array $options): void {
        $this->clear_import_lock();
        $this->log_error("Import failed: " . $e->getMessage(), "error", [
            "username" => $options["username"] ?? "",
            "exception" => $e->getMessage()
        ]);
    }

    /**
     * Get error response
     */
    private function get_error_response(string $message): array {
        return array_merge(self::IMPORT_RESPONSE, [
            "status" => "error",
            "message" => $message
        ]);
    }
}

================
File: includes/class-movie-post-type.php
================
<?php
/**
 * Handles the Movie custom post type registration and management
 *
 * @package letterboxd-connect
 * @since 1.0.0
 */

declare(strict_types=1);

// Prevent direct access
if (!defined("ABSPATH")) {
    exit();
}

/**
 * Movie post type handler class
 */
class Letterboxd_Movie_Post_Type {
    private function debug_log($message) {
        letterboxd_debug_log($message, "Movie_Post_Type");
    }

    /**
     * Post type and taxonomy constants
     */
    private const POST_TYPE = "movie";
    private const YEAR_TAXONOMY = "movie_year";
    private const CACHE_GROUP = "letterboxd_movies";

    /**
     * Cached capabilities
     */
    private array $capabilities;

    /**
     * Meta fields configuration
     */
    private const META_FIELDS = [
        "letterboxd_url" => [
            "type" => "string",
            "description" => "Letterboxd movie URL",
            "sanitize_callback" => "esc_url_raw",
        ],
        "poster_url" => [
            "type" => "string",
            "description" => "Movie poster URL",
            "sanitize_callback" => "esc_url_raw",
        ],
        "director" => [
            "type" => "string",
            "description" => "Movie director(s)",
            "sanitize_callback" => "sanitize_text_field",
        ],
    ];

    /**
     * Initialize the class and set its properties
     */
    public function __construct() {
        $this->setup_hooks();
        $this->setup_capabilities();
        $this->map_post_type_capabilities();
    }

    /**
     * Set up WordPress hooks
     */
    private function setup_hooks(): void {
        // Registration hooks
        add_action("init", [$this, "register_post_type"]);
        add_action("init", [$this, "register_taxonomies"]);
        add_action("init", [$this, "register_meta_fields"]);

        // Admin customization
        add_action("admin_head", [$this, "add_admin_styles"]);
        add_filter("enter_title_here", [$this, "modify_title_placeholder"]);
        add_filter("post_updated_messages", [
            $this,
            "customize_updated_messages",
        ]);

        // Query modifications
        add_action("pre_get_posts", [$this, "modify_archive_query"]);

        // REST API customization
        add_action("rest_api_init", [$this, "register_rest_fields"]);

        // Flush rewrite rules only once after activation
        add_action("after_switch_theme", "flush_rewrite_rules");
    }

    /**
     * Set up custom capabilities
     */
    private function setup_capabilities(): void {
        $this->capabilities = [
            "edit_post" => "edit_movie",
            "edit_posts" => "edit_movies",
            "edit_others_posts" => "edit_others_movies",
            "publish_posts" => "publish_movies",
            "read_post" => "read_movie",
            "read_private_posts" => "read_private_movies",
            "delete_post" => "delete_movie",
        ];
    }

    /**
     * Register the Movie post type
     */
    public function register_post_type(): void {
        $args = [
            "public" => true,
            "label" => __("Movies", "letterboxd-connect"),
            "labels" => $this->get_labels(),
            "supports" => [
                "title",
                "editor",
                "thumbnail",
                "excerpt",
                "custom-fields",
                "revisions",
            ],
            "menu_icon" => "dashicons-video-alt2",
            "has_archive" => true,
            "rewrite" => [
                "slug" => "movies",
                "with_front" => true,
                "feeds" => true,
            ],
            "show_in_rest" => true,
            "template" => [
                [
                    "core/paragraph",
                    [
                        "placeholder" => __(
                            "Add movie description...",
                            "letterboxd-connect"
                        ),
                    ],
                ],
            ],
            "capability_type" => "movie",
            "capabilities" => $this->capabilities,
            "map_meta_cap" => true,
            "hierarchical" => false,
            "menu_position" => 5,
            "taxonomies" => [self::YEAR_TAXONOMY],
            "show_in_nav_menus" => true,
            "show_in_admin_bar" => true,
            "query_var" => true,
        ];

        register_post_type(self::POST_TYPE, $args);
    }

    /**
     * Get the labels for the post type
     */
    private function get_labels(): array {
        return [
            "name" => _x(
                "Movies",
                "Post type general name",
                "letterboxd-connect"
            ),
            "singular_name" => _x(
                "Movie",
                "Post type singular name",
                "letterboxd-connect"
            ),
            "menu_name" => _x(
                "Movies",
                "Admin Menu text",
                "letterboxd-connect"
            ),
            "name_admin_bar" => _x(
                "Movie",
                "Add New on Toolbar",
                "letterboxd-connect"
            ),
            "add_new" => _x("Add New", "movie", "letterboxd-connect"),
            "add_new_item" => __("Add New Movie", "letterboxd-connect"),
            "edit_item" => __("Edit Movie", "letterboxd-connect"),
            "new_item" => __("New Movie", "letterboxd-connect"),
            "view_item" => __("View Movie", "letterboxd-connect"),
            "view_items" => __("View Movies", "letterboxd-connect"),
            "search_items" => __("Search Movies", "letterboxd-connect"),
            "not_found" => __("No movies found", "letterboxd-connect"),
            "not_found_in_trash" => __(
                "No movies found in Trash",
                "letterboxd-connect"
            ),
            "parent_item_colon" => __("Parent Movie:", "letterboxd-connect"),
            "all_items" => __("All Movies", "letterboxd-connect"),
            "archives" => __("Movie Archives", "letterboxd-connect"),
            "attributes" => __("Movie Attributes", "letterboxd-connect"),
            "insert_into_item" => __(
                "Insert into movie",
                "letterboxd-connect"
            ),
            "uploaded_to_this_item" => __(
                "Uploaded to this movie",
                "letterboxd-connect"
            ),
            "featured_image" => __("Movie Poster", "letterboxd-connect"),
            "set_featured_image" => __(
                "Set movie poster",
                "letterboxd-connect"
            ),
            "remove_featured_image" => __(
                "Remove movie poster",
                "letterboxd-connect"
            ),
            "use_featured_image" => __(
                "Use as movie poster",
                "letterboxd-connect"
            ),
            "filter_items_list" => __(
                "Filter movies list",
                "letterboxd-connect"
            ),
            "items_list_navigation" => __(
                "Movies list navigation",
                "letterboxd-connect"
            ),
            "items_list" => __("Movies list", "letterboxd-connect"),
        ];
    }

    /**
     * Map movie capabilities to appropriate roles
     */
    private function map_post_type_capabilities(): void {
        // Get the administrator role
        $admin = get_role("administrator");
        if (!$admin) {
            return;
        }

        // Core post type capabilities
        $capabilities = [
            "edit_movie",
            "edit_movies",
            "edit_others_movies",
            "publish_movies",
            "read_movie",
            "read_private_movies",
            "delete_movie",
            "delete_movies",
            "delete_others_movies",
            "delete_published_movies",
            "delete_private_movies",
            "edit_published_movies",
            "edit_private_movies",
        ];

        // Add each capability to the administrator role
        foreach ($capabilities as $cap) {
            $admin->add_cap($cap);
        }

        // Editor role should also have these capabilities
        $editor = get_role("editor");
        if ($editor) {
            foreach ($capabilities as $cap) {
                $editor->add_cap($cap);
            }
        }
    }

    /**
     * Remove capabilities on deactivation
     */
    private function remove_post_type_capabilities(): void {
        $roles = ["administrator", "editor"];
        $capabilities = [
            "edit_movie",
            "edit_movies",
            "edit_others_movies",
            "publish_movies",
            "read_movie",
            "read_private_movies",
            "delete_movie",
            "delete_movies",
            "delete_others_movies",
            "delete_published_movies",
            "delete_private_movies",
            "edit_published_movies",
            "edit_private_movies",
        ];

        foreach ($roles as $role_name) {
            $role = get_role($role_name);
            if ($role) {
                foreach ($capabilities as $cap) {
                    $role->remove_cap($cap);
                }
            }
        }
    }

    /**
     * Register taxonomies for the Movie post type with proper capability mapping
     */
    public function register_taxonomies(): void {
        register_taxonomy(self::YEAR_TAXONOMY, self::POST_TYPE, [
            "label" => __("Years", "letterboxd-connect"),
            "labels" => $this->get_year_labels(),
            "hierarchical" => false,
            "show_in_rest" => true,
            "show_admin_column" => true,
            "query_var" => true,
            "rewrite" => ["slug" => "movie-year"],
            "show_in_nav_menus" => true,
            "public" => true,
            "capabilities" => [
                "manage_terms" => "manage_movie_years",
                "edit_terms" => "edit_movie_years",
                "delete_terms" => "delete_movie_years",
                "assign_terms" => "assign_movie_years",
            ],
            "meta_box_cb" => "post_tags_meta_box",
        ]);

        $this->map_taxonomy_capabilities();
    }

    /**
     * Map taxonomy capabilities to appropriate roles
     */
    private function map_taxonomy_capabilities(): void {
        $admin = get_role("administrator");
        $editor = get_role("editor");

        if ($admin) {
            $admin->add_cap("manage_movie_years");
            $admin->add_cap("edit_movie_years");
            $admin->add_cap("delete_movie_years");
            $admin->add_cap("assign_movie_years");
        }

        if ($editor) {
            //if we wanted to assign different caps for editors
        }
    }

    /**
     * Remove taxonomy capabilities on plugin deactivation
     */
    public function remove_taxonomy_capabilities(): void {
        $roles = ["administrator", "editor"];
        $capabilities = [
            "manage_movie_years",
            "edit_movie_years",
            "delete_movie_years",
            "assign_movie_years",
        ];

        foreach ($roles as $role_name) {
            $role = get_role($role_name);
            if ($role) {
                foreach ($capabilities as $cap) {
                    $role->remove_cap($cap);
                }
            }
        }
    }

    public function cleanup_taxonomy_terms(): void {
        $terms = get_terms([
            "taxonomy" => self::YEAR_TAXONOMY,
            "hide_empty" => false,
            "fields" => "ids",
        ]);

        if (!is_wp_error($terms) && !empty($terms)) {
            foreach ($terms as $term_id) {
                $count = get_objects_in_term($term_id, self::YEAR_TAXONOMY);
                if (empty($count) || is_wp_error($count)) {
                    wp_delete_term($term_id, self::YEAR_TAXONOMY);
                }
            }
        }
    }

    /**
     * Check if user can manage movie taxonomies
     *
     * @param string $taxonomy_name The taxonomy to check
     * @return bool Whether the user can manage the taxonomy
     */
    public function can_manage_taxonomy(string $taxonomy_name): bool {
        $taxonomy = get_taxonomy($taxonomy_name);
        if (!$taxonomy) {
            return false;
        }

        return current_user_can($taxonomy->cap->manage_terms);
    }

    /**
     * Check if user can assign taxonomy terms
     *
     * @param string $taxonomy_name The taxonomy to check
     * @return bool Whether the user can assign terms
     */
    public function can_assign_taxonomy(string $taxonomy_name): bool {
        $taxonomy = get_taxonomy($taxonomy_name);
        if (!$taxonomy) {
            return false;
        }

        return current_user_can($taxonomy->cap->assign_terms);
    }

    /**
     * Get year taxonomy labels
     */
    private function get_year_labels(): array {
        return [
            "name" => _x(
                "Years",
                "taxonomy general name",
                "letterboxd-connect"
            ),
            "singular_name" => _x(
                "Year",
                "taxonomy singular name",
                "letterboxd-connect"
            ),
            "search_items" => __("Search Years", "letterboxd-connect"),
            "all_items" => __("All Years", "letterboxd-connect"),
            "edit_item" => __("Edit Year", "letterboxd-connect"),
            "update_item" => __("Update Year", "letterboxd-connect"),
            "add_new_item" => __("Add New Year", "letterboxd-connect"),
            "new_item_name" => __("New Year", "letterboxd-connect"),
            "menu_name" => __("Years", "letterboxd-connect"),
        ];
    }

    /**
     * Example of secure taxonomy term assignment
     */
    public function set_movie_terms(
        int $post_id,
        array $terms,
        string $taxonomy
    ): bool {
        // Check if user can assign terms
        if (!$this->can_assign_taxonomy($taxonomy)) {
            return false;
        }

        // Sanitize and validate terms
        $sanitized_terms = array_map("absint", $terms);

        // Set terms
        $result = wp_set_object_terms($post_id, $sanitized_terms, $taxonomy);

        return !is_wp_error($result);
    }

    /**
     * Example of secure taxonomy term creation
     */
    public function create_movie_term(
        string $name,
        string $taxonomy,
        array $args = []
    ): int|WP_Error {
        // Check if user can manage taxonomy
        if (!$this->can_manage_taxonomy($taxonomy)) {
            return new WP_Error(
                "insufficient_permissions",
                __(
                    "You do not have permission to create terms",
                    "letterboxd-connect"
                )
            );
        }

        // Sanitize term name
        $name = sanitize_text_field($name);

        // Create term
        $result = wp_insert_term($name, $taxonomy, $args);

        return is_wp_error($result) ? $result : $result["term_id"];
    }

    /**
     * Example of secure taxonomy term deletion
     */
    public function delete_movie_term(int $term_id, string $taxonomy): bool {
        // Check if user can manage taxonomy
        if (!$this->can_manage_taxonomy($taxonomy)) {
            return false;
        }

        // Delete term
        $result = wp_delete_term($term_id, $taxonomy);

        return !is_wp_error($result) && $result !== false;
    }

    /**
     * Example of secure taxonomy term update
     */
    public function update_movie_term(
        int $term_id,
        string $taxonomy,
        array $args
    ): bool {
        // Check if user can manage taxonomy
        if (!$this->can_manage_taxonomy($taxonomy)) {
            return false;
        }

        // Update term
        $result = wp_update_term($term_id, $taxonomy, $args);

        return !is_wp_error($result);
    }

    /**
     * Example of secure taxonomy term retrieval
     */
    public function get_movie_terms(int $post_id, string $taxonomy): array {
        $terms = wp_get_object_terms($post_id, $taxonomy, [
            "fields" => "all",
        ]);

        return is_wp_error($terms) ? [] : $terms;
    }

    /**
     * Register meta fields for the Movie post type
     */
    public function register_meta_fields(): void {
        foreach (self::META_FIELDS as $field => $config) {
            register_post_meta(self::POST_TYPE, $field, [
                "type" => $config["type"],
                "description" => $config["description"],
                "single" => true,
                "show_in_rest" => true,
                "sanitize_callback" => $config["sanitize_callback"],
                "auth_callback" => [$this, "meta_auth_callback"],
            ]);
        }
    }

    /**
     * Authorization callback for meta fields
     */
    public function meta_auth_callback(): bool {
        return current_user_can("edit_posts");
    }

    /**
     * Add custom admin styles
     */
    public function add_admin_styles(): void {
        global $post_type;
        if ($post_type === self::POST_TYPE) {
            echo '<style>
                .wp-admin.post-type-movie .page-title-action { margin-left: 0.5rem; }
                .wp-admin.post-type-movie #postcustom .inside { max-height: 25rem; overflow-y: auto; }
            </style>';
        }
    }

    /**
     * Modify the title placeholder
     */
    public function modify_title_placeholder(string $title): string {
        global $post_type;
        if ($post_type === self::POST_TYPE) {
            return __("Enter movie title", "letterboxd-connect");
        }
        return $title;
    }

    /**
     * Customize updated messages
     */
    public function customize_updated_messages(array $messages): array {
        global $post;

        $messages[self::POST_TYPE] = [
            0 => "", // Unused. Messages start at index 1.
            1 => __("Movie updated.", "letterboxd-connect"),
            2 => __("Custom field updated.", "letterboxd-connect"),
            3 => __("Custom field deleted.", "letterboxd-connect"),
            4 => __("Movie updated.", "letterboxd-connect"),
            5 => isset($_GET["revision"])
                ? sprintf(
                    /* translators: %s: revision title */
                    __(
                        "Movie restored to revision from %s",
                        "letterboxd-connect"
                    ),
                    wp_post_revision_title((int) $_GET["revision"], false)
                )
                : false,
            6 => __("Movie published.", "letterboxd-connect"),
            7 => __("Movie saved.", "letterboxd-connect"),
            8 => __("Movie submitted.", "letterboxd-connect"),
            9 => sprintf(
                /* translators: %s: scheduled movie post time */
                __("Movie scheduled for: %s.", "letterboxd-connect"),
                date_i18n(
                    __("M j, Y @ G:i", "letterboxd-connect"),
                    strtotime($post->post_date)
                )
            ),
            10 => __("Movie draft updated.", "letterboxd-connect"),
        ];

        return $messages;
    }

    /**
     * Modify archive query
     *
     * @param WP_Query $query The WordPress query object
     */
    public function modify_archive_query(WP_Query $query): void {
        if (is_admin() || !$query->is_main_query()) {
            return;
        }

        if ($query->is_post_type_archive(self::POST_TYPE)) {
            $query->set("posts_per_page", 24);
            $query->set("orderby", "date");
            $query->set("order", "DESC");
        }
    }

    /**
     * Register REST API fields
     */
    public function register_rest_fields(): void {
        register_rest_field(self::POST_TYPE, "movie_meta", [
            "get_callback" => [$this, "get_movie_meta"],
            "update_callback" => [$this, "update_movie_meta"],
            "schema" => [
                "description" => __("Movie metadata", "letterboxd-connect"),
                "type" => "object",
                "properties" => $this->get_meta_schema_properties(),
            ],
        ]);
    }

    /**
     * Get meta schema properties
     */
    private function get_meta_schema_properties(): array {
        $properties = [];

        foreach (self::META_FIELDS as $field => $config) {
            $properties[$field] = [
                "type" => $config["type"],
                "description" => $config["description"],
                "context" => ["view", "edit"],
                "arg_options" => [
                    "sanitize_callback" => $config["sanitize_callback"],
                ],
            ];
        }

        return $properties;
    }

    /**
     * Get movie meta for REST API
     *
     * @param array $post Array of post data
     * @return array Movie meta data
     */
    public function get_movie_meta(array $post): array {
        $meta = [];

        foreach (array_keys(self::META_FIELDS) as $field) {
            $meta[$field] = get_post_meta($post["id"], $field, true);
        }

        return $meta;
    }

    /**
     * Update movie meta via REST API
     *
     * @param array $meta Array of meta values to update
     * @param WP_Post $post Post object
     * @return bool|WP_Error True on success, WP_Error on failure
     */
    public function update_movie_meta(array $meta, WP_Post $post) {
        if (!current_user_can("edit_post", $post->ID)) {
            return new WP_Error(
                "rest_cannot_update",
                __(
                    "Sorry, you are not allowed to update this post.",
                    "letterboxd-connect"
                ),
                ["status" => rest_authorization_required_code()]
            );
        }

        $updated = true;
        foreach ($meta as $key => $value) {
            if (isset(self::META_FIELDS[$key])) {
                $sanitize_callback =
                    self::META_FIELDS[$key]["sanitize_callback"];
                $sanitized_value = is_array($sanitize_callback)
                    ? call_user_func($sanitize_callback, $value)
                    : call_user_func($sanitize_callback, $value);

                $updated =
                    $updated &&
                    update_post_meta($post->ID, $key, $sanitized_value);
            }
        }

        return $updated;
    }

    /**
     * Find and attach the movie poster to the post
     */
    public function set_movie_poster(int $post_id, string $url): bool {
        if (!current_user_can("edit_post", $post_id)) {
            return false;
        }

        $upload_dir = wp_upload_dir();
        $filename = basename($url);
        $file = wp_remote_get($url);

        if (is_wp_error($file)) {
            letterboxd_debug_log(
                "Failed to fetch poster: " . $file->get_error_message()
            );
            return false;
        }

        $image_data = wp_remote_retrieve_body($file);
        $filepath = $upload_dir["path"] . "/" . $filename;

        file_put_contents($filepath, $image_data);

        $wp_filetype = wp_check_filetype($filename, null);
        $attachment = [
            "post_mime_type" => $wp_filetype["type"],
            "post_title" => sanitize_file_name($filename),
            "post_content" => "",
            "post_status" => "inherit",
        ];

        $attach_id = wp_insert_attachment($attachment, $filepath, $post_id);
        if ($attach_id === 0) {
            letterboxd_debug_log("Failed to create attachment for poster");
            return false;
        }

        require_once ABSPATH . "wp-admin/includes/image.php";
        $attach_data = wp_generate_attachment_metadata($attach_id, $filepath);
        wp_update_attachment_metadata($attach_id, $attach_data);
        set_post_thumbnail($post_id, $attach_id);

        return true;
    }

    /**
     * Get movie by Letterboxd URL
     *
     * @param string $url Letterboxd URL
     * @return WP_Post|null Post object if found, null otherwise
     */
    public function get_movie_by_letterboxd_url(string $url): ?WP_Post {
        $posts = get_posts([
            "post_type" => self::POST_TYPE,
            "meta_key" => "letterboxd_url",
            "meta_value" => esc_url_raw($url),
            "posts_per_page" => 1,
            "post_status" => "any",
        ]);

        return !empty($posts) ? $posts[0] : null;
    }

    /**
     * Check if a movie exists by its Letterboxd URL
     *
     * @param string $url Letterboxd URL
     * @return bool Whether the movie exists
     */
    public function movie_exists(string $url): bool {
        return $this->get_movie_by_letterboxd_url($url) !== null;
    }

    /**
     * Get movies by year
     *
     * @param int $year Year to filter by
     * @param array $args Additional query arguments
     * @return array Array of WP_Post objects
     */
    public function get_movies_by_year(int $year, array $args = []): array {
        $default_args = [
            "post_type" => self::POST_TYPE,
            "posts_per_page" => -1,
            "tax_query" => [
                [
                    "taxonomy" => self::YEAR_TAXONOMY,
                    "field" => "slug",
                    "terms" => (string) $year,
                ],
            ],
        ];

        $query_args = wp_parse_args($args, $default_args);
        return get_posts($query_args);
    }

    /**
     * Get latest movie
     *
     * @return WP_Post|null Latest movie post or null if none exists
     */
    private function get_latest_movie(): ?WP_Post {
        $latest = get_posts([
            "post_type" => self::POST_TYPE,
            "posts_per_page" => 1,
            "orderby" => "date",
            "order" => "DESC",
        ]);

        return !empty($latest) ? $latest[0] : null;
    }

    /**
     * Update the activation method to include capability mapping
     */
    public function activate(): void {
        $this->map_post_type_capabilities();
        $this->map_taxonomy_capabilities();
    }

    /**
     * Update the deactivation method to remove capabilities
     */
    public function deactivate(): void {
        $this->remove_post_type_capabilities();
        $this->remove_taxonomy_capabilities();
    }
}

================
File: includes/class-settings-manager.php
================
<?php
/**
 * Handles all plugin settings and admin interface functionality
 *
 * @since 1.0.0
 */

// Prevent direct access
if (!defined("ABSPATH")) {
    exit();
}

class Letterboxd_Settings_Manager {
    use LetterboxdSecurity;

    /**
     * Class instance for singleton pattern
     *
     * @var Letterboxd_Settings_Manager
     */
    private static $instance = null;

    private function debug_log($message) {
        letterboxd_debug_log($message, "Settings_Manager");
    }

    /**
     * Plugin settings and constants
     */
    private const OPTION_NAME = "letterboxd_wordpress_options";
    private const OPTION_GROUP = "letterboxd_wordpress_options_group";
    private const MENU_SLUG = "letterboxd-connect";
    private const NONCE_ACTION = "letterboxd_settings_action";
    private const NONCE_NAME = "letterboxd_settings_nonce";
    private const AJAX_ACTION = "letterboxd_ajax_action";
    private const REST_NAMESPACE = "letterboxd-connect/v1";
    private const ADVANCED_OPTION_NAME = "letterboxd_wordpress_advanced_options";

    /**
     * Letterboxd username constraints
     */
    private const USERNAME_MIN_LENGTH = 2;
    private const USERNAME_MAX_LENGTH = 15;
    private const USERNAME_PATTERN = '/^[a-z0-9][a-z0-9-]*[a-z0-9]$/';

    private const SETTINGS_FIELDS = [
        "username" => [
            "label" => "Letterboxd Username",
            "callback" => "render_username_field",
        ],
        "start_date" => [
            "label" => "Start Date",
            "callback" => "render_start_date_field",
        ],
        "draft_status" => [
            "label" => "Import as Draft",
            "callback" => "render_draft_status_field",
        ],
    ];

    /**
     * Advanced settings fields
     */
    private const ADVANCED_SETTINGS_FIELDS = [
        "tmdb_api_key" => [
            "label" => "TMDB API Key",
            "callback" => "render_tmdb_api_key_field",
        ],
    ];

    /**
     * Default settings values
     */
    private const DEFAULT_OPTIONS = [
        "username" => "",
        "start_date" => "",
        "draft_status" => false,
    ];

    /**
     * Default advanced settings values
     */
    private const DEFAULT_ADVANCED_OPTIONS = [
        "tmdb_api_key" => "",
        "tmdb_session_id" => "",
    ];

    /**
     * Stored plugin options
     *
     * @var array
     */
    private array $options;

    /**
     * API Service for external operations
     *
     * @var LetterboxdApiServiceInterface
     */
    private LetterboxdApiServiceInterface $api_service;

    /**
     * Stored advanced plugin options
     *
     * @var array
     */
    private array $advanced_options;

    /**
     * Sanitize and validate all options
     *
     * @param array $options Options to sanitize
     * @return array Sanitized options
     */
    private array $validation_errors = [];
    private array $validated_data = [];

    /**
     * Track if hooks have been setup
     *
     * @var bool
     */
    private static $hooks_setup = false;

    /**
     * Track if REST routes have been registered
     *
     * @var bool
     */
    private static $rest_routes_registered = false;

    /**
     * Initialize the settings manager
     *
     * @param LetterboxdApiServiceInterface $api_service API service for external operations
     */
    public function __construct(LetterboxdApiServiceInterface $api_service) {
        $this->api_service = $api_service;
        // Check if we're on the settings page with a disconnect flag
        if (is_admin() && isset($_GET['page']) && $_GET['page'] === self::MENU_SLUG) {
            if (isset($_GET['tmdb_disconnected'])) {
                wp_cache_delete(self::ADVANCED_OPTION_NAME, 'options');
            }
        }
        $this->load_options();
        $this->setup_hooks();
    }

    /**
     * Get class instance (singleton pattern)
     *
     * @param LetterboxdApiServiceInterface $api_service API service for external operations
     * @return Letterboxd_Settings_Manager
     */
    public static function get_instance(
        LetterboxdApiServiceInterface $api_service
    ) {
        if (null === self::$instance) {
            self::$instance = new self($api_service);
        }
        return self::$instance;
    }

    /**
     * Handle TMDB Disconnections from the API
     * 
     */
    public function handle_tmdb_disconnect(): void {
        // Verify nonce
        if (
            !isset($_POST['_wpnonce']) ||
            !wp_verify_nonce($_POST['_wpnonce'], 'letterboxd_disconnect_tmdb')
        ) {
            wp_die(__('Security check failed.', 'letterboxd-connect'));
        }

        // Verify permissions
        if (!current_user_can('manage_options')) {
            wp_die(__('You do not have permission to do this.', 'letterboxd-connect'));
        }

        // Get current options directly from database (not cached)
        $options = get_option(self::ADVANCED_OPTION_NAME, []);
        
        // Remove the session ID
        unset($options['tmdb_session_id']);
        
        // Update the database - use false for autoload to ensure it's saved
        delete_option(self::ADVANCED_OPTION_NAME); // First delete to ensure clean save
        add_option(self::ADVANCED_OPTION_NAME, $options, '', 'no'); // Then add fresh
        
        // Clear any WordPress object cache
        wp_cache_delete(self::ADVANCED_OPTION_NAME, 'options');
        
        // Redirect with success parameter
        wp_redirect(admin_url('options-general.php?page=letterboxd-connect&tab=advanced&tmdb_disconnected=true'));
        exit;
    }


    /**
     * Set up WordPress hooks
     */
    private function setup_hooks(): void {
        // Only set up hooks once to prevent duplicates
        if (self::$hooks_setup) {
            return;
        }
        self::$hooks_setup = true;

        // Admin menu and settings
        add_action("admin_menu", [$this, "add_settings_page"]);
        add_action("admin_init", [$this, "register_settings"]);
        add_action("admin_enqueue_scripts", [$this, "enqueue_admin_assets"]);
        add_action("rest_api_init", [$this, "register_rest_routes"]);

        // Add plugin action links
        add_filter(
            "plugin_action_links_" . plugin_basename(LETTERBOXD_PLUGIN_FILE),
            [$this, "add_plugin_action_links"]
        );

        // Add custom column hooks for the 'movie' post type
        add_filter("manage_movie_posts_columns", [$this, "add_movie_columns"]);
        add_action(
            "manage_movie_posts_custom_column",
            [$this, "display_movie_columns"],
            10,
            2
        );

        add_action("admin_post_update_tmdb_data", [
            $this,
            "handle_tmdb_data_update",
        ]);
        add_action("admin_init", [$this, "handle_tmdb_auth_callback"]);
        
        add_action('admin_post_letterboxd_disconnect_tmdb', [$this, 'handle_tmdb_disconnect']);
    }

    /**
     * Register a new REST route
     *
     * @param string $route Route to register
     * @param array $args Route arguments
     */
    private function register_route(string $route, array $args): void {
        register_rest_route(self::REST_NAMESPACE, $route, $args);
    }

    /**
     * Register REST API routes
     */
    public function register_rest_routes(): void {
        // Only register routes once
        if (self::$rest_routes_registered) {
            return;
        }

        self::$rest_routes_registered = true;

        // Only log if API service is missing - an actual issue
        if (!isset($this->api_service)) {
            letterboxd_debug_log(
                "ERROR: API Service not available when registering REST routes"
            );
            return;
        }

        $this->register_route("/settings", [
            "methods" => "POST",
            "callback" => [$this, "update_settings"],
            "permission_callback" => fn() => current_user_can("manage_options"),
            "args" => [
                "username" => [
                    "required" => true,
                    "sanitize_callback" => "sanitize_text_field",
                ],
                "start_date" => [
                    "sanitize_callback" => "sanitize_text_field",
                ],
                "draft_status" => [
                    "sanitize_callback" => "rest_sanitize_boolean",
                ],
                "run_import_trigger" => [
                    "sanitize_callback" => "sanitize_text_field",
                    "default" => "0",
                ],
                "tmdb_api_key" => [
                    "sanitize_callback" => "sanitize_text_field",
                ],
            ],
        ]);

        $this->register_route("/tmdb-create-request-token", [
            "methods" => "GET",
            "callback" => [$this, "create_tmdb_request_token"],
            "permission_callback" => fn() => current_user_can("manage_options"),
        ]);

        $this->register_route("/tmdb-create-session", [
            "methods" => "POST",
            "callback" => [$this, "create_tmdb_session"],
            "permission_callback" => fn() => current_user_can("manage_options"),
            "args" => [
                "request_token" => [
                    "required" => true,
                    "sanitize_callback" => "sanitize_text_field",
                ],
            ],
        ]);

        $this->register_route("/validate-username", [
            "methods" => "GET",
            "callback" => [$this, "validate_username"],
            "permission_callback" => fn() => current_user_can("manage_options"),
            "args" => [
                "username" => [
                    "required" => true,
                    "sanitize_callback" => "sanitize_text_field",
                ],
            ],
        ]);

        $this->register_route("/validate-tmdb-api", [
            "methods" => "GET",
            "callback" => [$this, "validate_tmdb_api"],
            "permission_callback" => fn() => current_user_can("manage_options"),
            "args" => [
                "api_key" => [
                    "required" => true,
                    "sanitize_callback" => "sanitize_text_field",
                ],
            ],
        ]);

        $this->register_route("/import-status", [
            "methods" => "GET",
            "callback" => [$this, "get_import_status"],
            "permission_callback" => fn() => current_user_can("manage_options"),
        ]);
    }

    /**
     * Validate TMDB API key
     *
     * @param WP_REST_Request $request
     * @return WP_REST_Response
     */
    public function validate_tmdb_api(
        WP_REST_Request $request
    ): WP_REST_Response {
        $api_key = $request->get_param("api_key");
        $validation_result = $this->api_service->checkTmdbApiKey($api_key);

        if (is_wp_error($validation_result)) {
            return new WP_REST_Response(
                [
                    "success" => false,
                    "message" => $validation_result->get_error_message(),
                ],
                400
            );
        }

        return new WP_REST_Response(
            [
                "success" => true,
                "message" => __("API key is valid.", "letterboxd-connect"),
            ],
            200
        );
    }

    /**
     * Check if TMDB authentication is complete
     *
     * @return bool True if authenticated
     */
    private function is_tmdb_authenticated(): bool {
        return !empty($this->advanced_options["tmdb_api_key"]) &&
            !empty($this->advanced_options["tmdb_session_id"]);
    }

    /**
     * Handle the authorization callback from TMDB
     */
    public function handle_tmdb_auth_callback(): void {
        // Store flag for script enqueuing
        if (isset($_GET["tmdb_auth"]) && $_GET["tmdb_auth"] === "callback") {
            $request_token = get_transient("letterboxd_tmdb_request_token");
            if (!empty($request_token)) {
                // Store for later use in enqueue_admin_assets
                set_transient(
                    "letterboxd_tmdb_auth_callback",
                    $request_token,
                    HOUR_IN_SECONDS
                );
            } else {
                add_settings_error(
                    "letterboxd_messages",
                    "tmdb_auth_error",
                    __(
                        "Authentication session expired. Please try again.",
                        "letterboxd-connect"
                    )
                );
            }
        }
    }

    /**
     * Update settings via REST API
     *
     * @param WP_REST_Request $request
     * @return WP_REST_Response
     */
    public function update_settings(
        WP_REST_Request $request
    ): WP_REST_Response {
        if (!current_user_can("manage_options")) {
            return new WP_REST_Response(
                [
                    "success" => false,
                    "message" => __(
                        "Insufficient permissions",
                        "letterboxd-connect"
                    ),
                ],
                403
            );
        }

        $posted_data = $request->get_params();
        //letterboxd_debug_log('update_settings POST data: ' . print_r($posted_data, true));

        // First, make sure any old flag is cleared to prevent accidental imports
        delete_option("letterboxd_run_import_flag");

        // Save main settings
        $main_settings = $this->sanitize_options([
            "username" => $posted_data["username"] ?? "",
            "start_date" => $posted_data["start_date"] ?? "",
            "draft_status" => !empty($posted_data["draft_status"]),
        ]);
        update_option(self::OPTION_NAME, $main_settings);

        // Save advanced settings if present
        if (isset($posted_data["tmdb_api_key"])) {
            // Get existing options to preserve tmdb_session_id
            $advanced_settings = get_option(self::ADVANCED_OPTION_NAME, []);
            $advanced_settings["tmdb_api_key"] = sanitize_text_field(
                $posted_data["tmdb_api_key"]
            );
            update_option(self::ADVANCED_OPTION_NAME, $advanced_settings);
        }

        // Save auto-import settings
        if (isset($posted_data["letterboxd_auto_import_options"])) {
            $auto_import_settings = [
                "frequency" => isset(
                    $posted_data["letterboxd_auto_import_options"]["frequency"]
                )
                    ? sanitize_text_field(
                        $posted_data["letterboxd_auto_import_options"][
                            "frequency"
                        ]
                    )
                    : "daily",
                "notifications" => !empty(
                    $posted_data["letterboxd_auto_import_options"][
                        "notifications"
                    ]
                ),
            ];

            // First, verify we're not recreating the same value
            $existing = get_option("letterboxd_auto_import_options", []);
            if ($existing != $auto_import_settings) {
                // Use true for autoload parameter
                $update_result = update_option(
                    "letterboxd_auto_import_options",
                    $auto_import_settings,
                    true
                );

                // Also update the import interval option for compatibility
                update_option(
                    "letterboxd_import_interval",
                    $auto_import_settings["frequency"],
                    true
                );

                set_transient("letterboxd_settings_just_updated", true, 60); // 60 seconds

                // Only update the schedule if the settings were successfully saved
                if ($update_result) {
                    $auto_import = new Letterboxd_Auto_Import(
                        Letterboxd_To_WordPress::get_instance()
                    );
                    $auto_import->update_import_schedule(
                        $auto_import_settings["frequency"]
                    );
                }
            }
        }

        // IMPORTANT: Check the explicit value - use strict === comparison
        $run_import =
            isset($posted_data["run_import_trigger"]) &&
            $posted_data["run_import_trigger"] === "1";

        // Only run an import if explicitly requested
        if ($run_import) {
            letterboxd_debug_log(
                "Manual import explicitly requested - running now"
            );

            // Use a do_action with a priority to ensure it runs after all settings are saved
            add_action(
                "shutdown",
                function () {
                    letterboxd_debug_log("Running import on shutdown hook");
                    do_action("letterboxd_check_and_import");
                },
                999
            );
        }

        return new WP_REST_Response(
            [
                "success" => true,
                "message" => __(
                    "Settings saved successfully.",
                    "letterboxd-connect"
                ),
            ],
            200
        );
    }

    /**
     * Validate Letterboxd username
     *
     * @param WP_REST_Request $request
     * @return WP_REST_Response
     */
    public function validate_username(
        WP_REST_Request $request
    ): WP_REST_Response {
        $username = $request->get_param("username");
        $validation_result = $this->validate_letterboxd_username($username);

        if (is_wp_error($validation_result)) {
            return new WP_REST_Response(
                [
                    "success" => false,
                    "message" => $validation_result->get_error_message(),
                ],
                400
            );
        }

        return new WP_REST_Response(
            [
                "success" => true,
                "message" => __("Username is valid.", "letterboxd-connect"),
            ],
            200
        );
    }

    /**
     * Get import status for REST API
     *
     * @return WP_REST_Response
     */
    public function get_import_status(): WP_REST_Response {
        $interval = get_option("letterboxd_import_interval", "hourly");
        $last_import = get_option("letterboxd_last_import", 0);

        $schedules = wp_get_schedules();
        $interval_seconds = isset($schedules[$interval])
            ? $schedules[$interval]["interval"]
            : 3600;

        $next_check = $last_import + $interval_seconds;

        return new WP_REST_Response(
            [
                "success" => true,
                "last_import" => $last_import,
                "next_check" => $next_check,
                "imported_count" => get_option("letterboxd_imported_count", 0),
            ],
            200
        );
    }

    /**
     * Load and cache plugin options
     */
    private function load_options(): void {
        // Force refresh if we just disconnected
        $force_refresh = isset($_GET['tmdb_disconnected']) && $_GET['tmdb_disconnected'] === 'true';
        
        if ($force_refresh) {
            // Clear any cached values
            wp_cache_delete(self::OPTION_NAME, 'options');
            wp_cache_delete(self::ADVANCED_OPTION_NAME, 'options');
        }
        
        $saved_options = get_option(self::OPTION_NAME, []);
        $this->options = wp_parse_args($saved_options, self::DEFAULT_OPTIONS);

        $saved_advanced_options = get_option(self::ADVANCED_OPTION_NAME, []);
        $this->advanced_options = wp_parse_args(
            $saved_advanced_options,
            self::DEFAULT_ADVANCED_OPTIONS
        );
    }

    /**
     * Add settings page to WordPress admin
     */
    public function add_settings_page(): void {
        add_options_page(
            __("Letterboxd Connect Settings", "letterboxd-connect"),
            __("Letterboxd Connect", "letterboxd-connect"),
            "manage_options",
            self::MENU_SLUG,
            [$this, "render_settings_page"]
        );
    }

    /**
     * Register settings fields for a section
     *
     * @param string $section Section ID
     * @param array $fields Fields to register
     * @param string $page Page slug
     */
    private function register_settings_field(
        string $section,
        array $fields,
        string $page
    ): void {
        foreach ($fields as $field => $data) {
            add_settings_field(
                $field,
                $data["label"],
                [$this, $data["callback"]],
                $page,
                $section,
                ['label_for' => $field]
            );
        }
    }

    /**
     * Register plugin settings
     */
    public function register_settings(): void {
        // Register settings
        register_setting(self::OPTION_GROUP, self::OPTION_NAME, [
            "type" => "object",
            "default" => self::DEFAULT_OPTIONS,
            "sanitize_callback" => [$this, "sanitize_options"],
        ]);

        // Register advanced settings
        register_setting(self::OPTION_GROUP, self::ADVANCED_OPTION_NAME, [
            "type" => "object",
            "default" => self::DEFAULT_ADVANCED_OPTIONS,
            "sanitize_callback" => [$this, "sanitize_advanced_options"],
        ]);

        add_settings_section(
            "letterboxd_wordpress_main",
            __("Main Settings", "letterboxd-connect"),
            [$this, "render_settings_description"],
            self::MENU_SLUG
        );

        add_settings_section(
            "letterboxd_wordpress_advanced",
            __("Advanced Settings", "letterboxd-connect"),
            [$this, "render_advanced_settings_description"],
            self::MENU_SLUG . "_advanced"
        );

        // Register fields
        $this->register_settings_field(
            "letterboxd_wordpress_main",
            self::SETTINGS_FIELDS,
            self::MENU_SLUG
        );
        $this->register_settings_field(
            "letterboxd_wordpress_advanced",
            self::ADVANCED_SETTINGS_FIELDS,
            self::MENU_SLUG . "_advanced"
        );
    }

    /**
     * Render settings page content with tabs
     */
    public function render_settings_page(): void {
        if (!current_user_can("manage_options")) {
            return;
        }

        // Refresh options from database so the session removal is reflected
        $this->advanced_options = get_option(self::ADVANCED_OPTION_NAME, []);
        $this->options = get_option(self::OPTION_NAME, []);

        $active_tab = isset($_GET["tab"]) ? sanitize_key($_GET["tab"]) : "general";

        include_once plugin_dir_path(__FILE__) . 'templates/settings-page.php';
    }


    /**
     * Render advanced settings description
     */
    public function render_advanced_settings_description(): void {
        ?>
        <p>
            <?php esc_html_e(
                "Configure advanced settings for enhancing your Letterboxd imports with additional data sources.",
                "letterboxd-connect"
            ); ?>
        </p>
        <?php
    }

    /**
     * Render TMDB API key field
     */
    public function render_tmdb_api_key_field(): void {
        printf(
            '<div class="api-key-wrapper">
                <div class="key-button">
                    <input type="text" name="%s[tmdb_api_key]" id="tmdb_api_key" value="%s" class="regular-text">
                    <button type="button" id="validate-tmdb-api" class="button button-secondary">%s</button>
                </div>
                <div class="helper-description">
                    <p class="description">%s <a href="%s" target="_blank">%s</a></p>
                </div>
            </div>
            <span id="tmdb-api-validation-result"></span>',
            esc_attr(self::ADVANCED_OPTION_NAME),
            esc_attr($this->advanced_options["tmdb_api_key"]),
            esc_html__("Test Connection", "letterboxd-connect"),
            esc_html__(
                "Your API key from The Movie Database:",
                "letterboxd-connect"
            ),
            esc_url("https://developer.themoviedb.org/docs/getting-started"),
            esc_html__("Get one here", "letterboxd-connect")
        );
    }

    /**
     * Render the TMDB update button with progress tracking
     */
    public function render_update_tmdb_button(): void {
        $url = wp_nonce_url(
            admin_url("admin-post.php?action=update_tmdb_data"),
            "update_tmdb_data"
        );

        echo '<div class="tmdb-update-section">';
        printf(
            '<a href="%s" class="button button-secondary tmdb-update-button">%s</a>',
            esc_url($url),
            esc_html__(
                "Update TMDB Data for All Movies",
                "letterboxd-connect"
            )
        );

        echo '<p class="description">' .
            esc_html__(
                "Fetch and update TMDB data for all existing movies. This process runs in batches to prevent timeouts.",
                "letterboxd-connect"
            ) .
            "</p>";

        // Add progress bar container
        echo '<div id="tmdb-update-progress" class="tmdb-update-progress" style="display:none; margin-top: 10px;">';
        echo '<div class="tmdb-progress-bar"><div class="tmdb-progress-inner"></div></div>';
        echo '<p class="tmdb-progress-status">' .
            esc_html__("Processing...", "letterboxd-connect") .
            ' <span class="tmdb-progress-count">0</span>%</p>';
        echo "</div>";

        echo "</div>";

        // Add inline styles for progress bar
        echo '<style>
            .tmdb-progress-bar {
                height: 20px;
                background-color: #f0f0f0;
                border-radius: 4px;
                overflow: hidden;
                margin-bottom: 10px;
            }
            .tmdb-progress-inner {
                height: 100%;
                background-color: #0073aa;
                width: 0%;
                transition: width 0.3s ease;
            }
            .tmdb-progress-status {
                font-size: 14px;
                color: #555;
            }
            .tmdb-update-button.processing {
                pointer-events: none;
                opacity: 0.7;
            }
        </style>';
        // Add inline JavaScript for progress tracking
        ?>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const updateButton = document.querySelector('.tmdb-update-button');
            const progressDiv = document.getElementById('tmdb-update-progress');
            const progressBar = document.querySelector('.tmdb-progress-inner');
            const progressCount = document.querySelector('.tmdb-progress-count');
            
            if (updateButton && progressDiv) {
                updateButton.addEventListener('click', function(e) {
                    if (confirm('<?php echo esc_js(
                        __(
                            "This process may take several minutes depending on your number of movies. Continue?",
                            "letterboxd-connect"
                        )
                    ); ?>')) {
                        e.preventDefault();
                        
                        // Show progress bar and disable button
                        progressDiv.style.display = 'block';
                        updateButton.classList.add('processing');
                        updateButton.innerHTML = '<?php echo esc_js(
                            __("Processing...", "letterboxd-connect")
                        ); ?>';
                        
                        // Function to update progress through AJAX
                        const updateProgress = (currentBatch = 1) => {
                            // Make AJAX request to start the process
                            const url = e.target.href;
                            
                            // Add batch parameter to URL if this isn't the first batch
                            const batchUrl = currentBatch > 1 
                                ? url + '&batch=' + currentBatch 
                                : url;
                            
                            fetch(batchUrl)
                                .then(response => {
                                    // Check if redirected to the next batch
                                    const redirectUrl = response.url;
                                    
                                    if (redirectUrl.includes('batch=')) {
                                        // Extract batch number
                                        const batchMatch = redirectUrl.match(/batch=(\d+)/);
                                        if (batchMatch && batchMatch[1]) {
                                            const nextBatch = parseInt(batchMatch[1]);
                                            
                                            // Update progress
                                            const progress = Math.min(90, (nextBatch - 1) * 10); // Estimate progress
                                            progressBar.style.width = progress + '%';
                                            progressCount.textContent = progress;
                                            
                                            // Continue with next batch
                                            updateProgress(nextBatch);
                                        }
                                    } else if (redirectUrl.includes('updated=true')) {
                                        // Process completed
                                        progressBar.style.width = '100%';
                                        progressCount.textContent = '100';
                                        
                                        // Reload page after short delay
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1000);
                                    } else {
                                        // Something went wrong, reload
                                        window.location.reload();
                                    }
                                })
                                .catch(error => {
                                    console.error('Error updating TMDB data:', error);
                                    alert('<?php echo esc_js(
                                        __(
                                            "An error occurred. Please try again.",
                                            "letterboxd-connect"
                                        )
                                    ); ?>');
                                    window.location.reload();
                                });
                        };
                        
                        // Start the process
                        updateProgress();
                    }
                });
            }
        });
        </script>
        <?php
    }

    /**
     * Handle TMDB data update request
     */
    /**
     * Handle TMDB data update request
     */
    public function handle_tmdb_data_update(): void {
        // Verify nonce
        if (
            !isset($_GET["_wpnonce"]) ||
            !wp_verify_nonce($_GET["_wpnonce"], "update_tmdb_data")
        ) {
            wp_die(esc_html__("Security check failed.", "letterboxd-connect"));
        }

        // Verify permissions
        if (!current_user_can("manage_options")) {
            wp_die(
                esc_html__(
                    "You do not have sufficient permissions to perform this action.",
                    "letterboxd-connect"
                )
            );
        }

        // Tracking variables for the entire process
        $processed_total =
            (int) get_transient("letterboxd_tmdb_update_processed") ?: 0;
        $updated_total =
            (int) get_transient("letterboxd_tmdb_update_success") ?: 0;
        $failed_total =
            (int) get_transient("letterboxd_tmdb_update_failed") ?: 0;

        // Get TMDB handler
        $tmdb_handler = new Letterboxd_TMDB_Handler();

        // Check if API key is configured
        if (!$tmdb_handler->is_api_key_configured()) {
            add_settings_error(
                "letterboxd_messages",
                "tmdb_api_missing",
                __("TMDB API key is not configured.", "letterboxd-connect")
            );
            set_transient("settings_errors", get_settings_errors(), 30);
            wp_redirect(
                admin_url(
                    "options-general.php?page=letterboxd-connect&tab=advanced&error=api_missing"
                )
            );
            exit();
        }

        // Get batch size from request or use default
        $batch_size = isset($_GET["batch_size"])
            ? (int) $_GET["batch_size"]
            : 20;
        $batch_size = max(5, min(50, $batch_size)); // Ensure between 5-50

        // Get batch number
        $batch = isset($_GET["batch"]) ? (int) $_GET["batch"] : 1;

        // Get advanced options for region
        $options = get_option("letterboxd_wordpress_advanced_options", []);
        $region = $options["streaming_region"] ?? "US";

        // Get movies for this batch - use small memory limit
        $args = [
            "post_type" => "movie",
            "posts_per_page" => $batch_size,
            "paged" => $batch,
            "orderby" => "date",
            "order" => "DESC",
            "fields" => "ids", // Only get IDs for efficiency
            "no_found_rows" => true, // Don't calculate found rows for better performance
            "update_post_meta_cache" => false, // Don't include post meta in query
            "update_post_term_cache" => false, // Don't include term cache in query
        ];

        $query = new WP_Query($args);
        $post_ids = $query->posts;
        $found_posts = $query->found_posts;

        // Process the batch
        if (!empty($post_ids)) {
            // Log start of operation
            letterboxd_debug_log(
                sprintf(
                    "Starting TMDB data update batch %d with %d movies",
                    $batch,
                    count($post_ids)
                )
            );

            // Use batch update method
            $results = $tmdb_handler->batch_update_streaming_providers(
                $post_ids,
                $region
            );

            // Update tracking totals
            $processed_total += count($post_ids);
            $updated_total += $results["updated"];
            $failed_total += $results["failed"];

            // Store updated counts
            set_transient(
                "letterboxd_tmdb_update_processed",
                $processed_total,
                DAY_IN_SECONDS
            );
            set_transient(
                "letterboxd_tmdb_update_success",
                $updated_total,
                DAY_IN_SECONDS
            );
            set_transient(
                "letterboxd_tmdb_update_failed",
                $failed_total,
                DAY_IN_SECONDS
            );

            // Store results in transient for display
            $prev_results = get_transient("letterboxd_tmdb_update_results") ?: [
                "updated" => 0,
                "failed" => 0,
                "total_processed" => 0,
                "total_posts" => $query->found_posts,
            ];

            $updated_results = [
                "updated" => $prev_results["updated"] + $results["updated"],
                "failed" => $prev_results["failed"] + $results["failed"],
                "total_processed" =>
                    $prev_results["total_processed"] + count($post_ids),
                "total_posts" => $query->found_posts,
            ];

            set_transient(
                "letterboxd_tmdb_update_results",
                $updated_results,
                DAY_IN_SECONDS
            );

            // Check if there are more items to process
            if (
                $updated_results["total_processed"] <
                $updated_results["total_posts"]
            ) {
                // Explicitly clean up to free memory
                $query = null;
                $post_ids = null;
                $results = null;
                $prev_results = null;
                $updated_results = null;

                if (function_exists("wp_cache_flush")) {
                    wp_cache_flush();
                }

                // Redirect to next batch
                $next_batch_url = add_query_arg(
                    [
                        "action" => "update_tmdb_data",
                        "_wpnonce" => wp_create_nonce("update_tmdb_data"),
                        "batch" => $batch + 1,
                        "batch_size" => $batch_size,
                    ],
                    admin_url("admin-post.php")
                );

                wp_redirect($next_batch_url);
                exit();
            }
        }

        // Process completed - prepare summary message
        $message = sprintf(
            /* translators: 1: Number of processed items, 2: Number of updated items, 3: Number of failed items */
            __(
                "TMDB data update completed. Processed: %1\$d, Updated: %2\$d, Failed: %3\$d",
                "letterboxd-connect"
            ),
            $processed_total,
            $updated_total,
            $failed_total
        );

        // Clear the transients used for tracking
        delete_transient("letterboxd_tmdb_update_processed");
        delete_transient("letterboxd_tmdb_update_success");
        delete_transient("letterboxd_tmdb_update_failed");
        delete_transient("letterboxd_tmdb_update_results");

        // Add message and redirect back to settings
        add_settings_error(
            "letterboxd_messages",
            "tmdb_update_complete",
            $message,
            "success"
        );

        set_transient("settings_errors", get_settings_errors(), 30);
        wp_redirect(
            admin_url(
                "options-general.php?page=letterboxd-connect&tab=advanced&updated=true"
            )
        );
        exit();
    }

    /**
     * Enqueue admin scripts and styles with proper dependencies
     */
    public function enqueue_admin_assets(string $hook): void {
        // Only load on our settings page
        if ("settings_page_" . self::MENU_SLUG !== $hook) {
            return;
        }

        $plugin_url = plugin_dir_url(LETTERBOXD_PLUGIN_FILE);

        // jQuery UI styles first (dependency for admin styles)
        wp_enqueue_style(
            "letterboxd-jquery-ui",
            plugin_dir_url(__FILE__) . 'assets/css/jquery-ui.min.css',
            [],
            "1.12.1"
        );

        // Admin styles
        wp_enqueue_style(
            "letterboxd-admin",
            $plugin_url . "css/admin.css",
            ["letterboxd-jquery-ui"],
            LETTERBOXD_VERSION
        );

        // Core scripts
        wp_enqueue_script("jquery");
        wp_enqueue_script("jquery-ui-core");
        wp_enqueue_script("jquery-ui-datepicker");
        wp_enqueue_script("jquery-ui-tabs");
        wp_enqueue_media();

        // Settings script
        wp_enqueue_script(
            "letterboxd-settings",
            $plugin_url . "js/settings.js",
            [
                "jquery",
                "jquery-ui-core",
                "jquery-ui-datepicker",
                "jquery-ui-tabs",
                "wp-api-fetch",
                "wp-i18n",
                "wp-util",
            ],
            LETTERBOXD_VERSION,
            true
        );

        $auto_import_options = get_option("letterboxd_auto_import_options", [
            "frequency" => "daily",
            "notifications" => false,
        ]);

        // Prepare script data
        $token = get_transient("letterboxd_tmdb_auth_callback");

        // Main settings data
        $settings_data = [
            "ajaxUrl" => admin_url("admin-ajax.php"),
            "apiRoot" => esc_url_raw(rest_url()),
            "apiNonce" => wp_create_nonce("wp_rest"),
            "restNamespace" => self::REST_NAMESPACE,
            "nonce" => wp_create_nonce(self::AJAX_ACTION),
            "maxUploadSize" => wp_max_upload_size(),
            "dateFormat" => get_option("date_format"),
            "settings" => [
                "username" => $this->options["username"] ?? "",
                "start_date" => $this->options["start_date"] ?? "",
                "draft_status" => $this->options["draft_status"] ?? false,
                "tmdb_api_key" => $this->advanced_options["tmdb_api_key"] ?? "",
                "auto_import" => $auto_import_options,
            ],
        ];

        // Localize scripts
        wp_localize_script(
            "letterboxd-settings",
            "letterboxdSettings",
            $settings_data
        );

        if (!empty($token)) {
            wp_localize_script("letterboxd-settings", "letterboxdTmdbAuth", [
                "request_token" => $token,
            ]);
            delete_transient("letterboxd_tmdb_auth_callback");
        }
    }

    /**
     * Validate and sanitize input data
     *
     * @param array $input The input data to validate and sanitize
     * @return array The validated and sanitized data
     * @throws \Exception If validation fails
     */
    private function validateAndSanitize(array $input): array {
        $validated = [];
        $errors = [];

        // Username validation
        if (isset($input["username"])) {
            $username = sanitize_text_field($input["username"]);
            $validation = $this->api_service->validateUsername($username);

            if (!is_wp_error($validation)) {
                $validated["username"] = $username;
            } else {
                $errors[] = $validation->get_error_message();
            }
        }

        // Date validation
        if (isset($input["start_date"])) {
            $date = sanitize_text_field($input["start_date"]);
            if (empty($date) || $this->api_service->validateDate($date)) {
                $validated["start_date"] = $date;
            } else {
                $errors[] = __("Invalid date format.", "letterboxd-connect");
            }
        }

        // Draft status validation
        $validated["draft_status"] = !empty($input["draft_status"]);

        if (!empty($errors)) {
            throw new \Exception(esc_html(implode(" ", $errors)));
        }

        return $validated;
    }

    /**
     * Sanitize main options
     *
     * @param array $input Options to sanitize
     * @return array Sanitized options
     */
    public function sanitize_options(array $input): array {
        try {
            // Just sanitize and return the options
            return [
                "username" => isset($input["username"])
                    ? sanitize_text_field($input["username"])
                    : "",
                "start_date" => isset($input["start_date"])
                    ? sanitize_text_field($input["start_date"])
                    : "",
                "draft_status" => !empty($input["draft_status"]),
            ];
        } catch (\Exception $e) {
            add_settings_error(
                "letterboxd_messages",
                "validation_error",
                $e->getMessage()
            );
            return $this->options;
        }
    }

    /**
     * Sanitize advanced options
     *
     * @param array $input Advanced options to sanitize
     * @return array Sanitized advanced options
     */
    public function sanitize_advanced_options(array $input): array {
        $sanitized = [];

        if (isset($input["tmdb_api_key"])) {
            $sanitized["tmdb_api_key"] = sanitize_text_field(
                $input["tmdb_api_key"]
            );
        }

        // Preserve other advanced options
        $existing = get_option(self::ADVANCED_OPTION_NAME, []);
        if (isset($existing["tmdb_session_id"])) {
            $sanitized["tmdb_session_id"] = $existing["tmdb_session_id"];
        }

        return $sanitized;
    }

    /**
     * Render settings description
     */
    public function render_settings_description(): void {
        ?>
        <p>
            <?php esc_html_e(
                "Configure your Letterboxd import settings below. Make sure to save your settings before importing.",
                "letterboxd-connect"
            ); ?>
        </p>
        <?php
    }

    /**
     * Render username field
     */
    public function render_username_field($args): void {
        $field = $args['label_for'] ?? 'username';
        printf(
            '<input type="text" id="%1$s" name="%2$s[%1$s]" value="%3$s" class="regular-text" required>
            <p class="description">%4$s</p>',
            esc_attr($field),
            esc_attr(self::OPTION_NAME),
            esc_attr($this->options[$field] ?? ''),
            esc_html__("Your Letterboxd username", "letterboxd-connect")
        );
    }

    /**
     * Render start date field
     */
    public function render_start_date_field(): void {
        printf(
            '<input type="date" id="start_date" name="%s[start_date]" value="%s" class="regular-text" max="%s">
            <p class="description">%s</p>',
            esc_attr(self::OPTION_NAME),
            esc_attr($this->options["start_date"]),
            esc_attr(gmdate("Y-m-d")),
            esc_html__(
                "Optional: Only import movies watched after this date",
                "letterboxd-connect"
            )
        );
    }

    /**
     * Render draft status field
     */
    public function render_draft_status_field(): void {
        printf(
            '<input type="checkbox" name="%s[draft_status]" value="1" %s>
            <span class="description">%s</span>',
            esc_attr(self::OPTION_NAME),
            checked($this->options["draft_status"], true, false),
            esc_html__(
                "Save imported movies as drafts instead of publishing immediately",
                "letterboxd-connect"
            )
        );
    }

    /**
     * This method is now simplified and only used as a fallback
     * for any old code that might still call it
     */
    public function run_import_if_flagged(): void {
        $flag = get_option("letterboxd_run_import_flag", false);

        // This method should no longer be used directly - the import should be triggered
        // only from the update_settings method when the checkbox is checked
        if (!$flag) {
            return;
        }

        do_action("letterboxd_check_and_import");

        // Always clean up
        delete_option("letterboxd_run_import_flag");
    }

    /**
     * Adds a "Settings" link next to the Deactivate link on the plugins screen.
     *
     * @param array $links Existing plugin action links.
     * @return array Modified links including our Settings link.
     */
    public function add_plugin_action_links(array $links): array {
        $settings_link = sprintf(
            '<a href="%s">%s</a>',
            admin_url("options-general.php?page=" . self::MENU_SLUG),
            __("Settings", "letterboxd-connect")
        );
        // Prepend the link so it appears first
        array_unshift($links, $settings_link);
        return $links;
    }

    /**
     * Adds custom columns to the movie list.
     *
     * @param array $columns The existing columns.
     * @return array Modified columns including the new columns.
     */
    public function add_movie_columns(array $columns): array {
        $new_columns = [];
        foreach ($columns as $key => $value) {
            $new_columns[$key] = $value;
            if ($key === "title") {
                // Insert after the Title column
                $new_columns["rating"] = __("Rating", "letterboxd-connect");

                // Only add director column if TMDB is authenticated
                if ($this->is_tmdb_authenticated()) {
                    $new_columns["director"] = __(
                        "Director",
                        "letterboxd-connect"
                    );
                }
            }
        }
        return $new_columns;
    }

    /**
     * Displays values in custom columns.
     *
     * @param string $column  The name of the column to display.
     * @param int    $post_id The current post ID.
     */
    public function display_movie_columns(string $column, int $post_id): void {
        switch ($column) {
            case "rating":
                $rating = get_post_meta($post_id, "movie_rating", true);
                echo $rating
                    ? esc_html($rating)
                    : esc_html__("No Rating", "letterboxd-connect");
                break;

            case "director":
                $director = get_post_meta($post_id, "director", true);
                echo $director ? esc_html($director) : "";
                break;
        }
    }

    /**
     * Validate a Letterboxd username
     *
     * @param string $username Username to validate
     * @return true|WP_Error True if valid, WP_Error if not
     */
    private function validate_letterboxd_username($username) {
        // Check if username is empty
        if (empty($username)) {
            return new WP_Error(
                "invalid_username",
                __("Username cannot be empty.", "letterboxd-connect")
            );
        }

        // Check username length
        if (
            strlen($username) < self::USERNAME_MIN_LENGTH ||
            strlen($username) > self::USERNAME_MAX_LENGTH
        ) {
            return new WP_Error(
                "invalid_username",
                sprintf(
                    /* translators: 1: Minimum username length, 2: Maximum username length */
                    __(
                        "Username must be between %1\$d and %2\$d characters.",
                        "letterboxd-connect"
                    ),
                    self::USERNAME_MIN_LENGTH,
                    self::USERNAME_MAX_LENGTH
                )
            );
        }

        // Check username format
        if (!preg_match(self::USERNAME_PATTERN, $username)) {
            return new WP_Error(
                "invalid_username",
                __(
                    "Username can only contain lowercase letters, numbers, and hyphens. It cannot start or end with a hyphen.",
                    "letterboxd-connect"
                )
            );
        }

        return true;
    }

    /**
     * Method to create TMDB request token
     *
     * @return WP_REST_Response
     */
    public function create_tmdb_request_token() {
        $api_key = $this->advanced_options['tmdb_api_key'] ?? '';

        if (empty($api_key)) {
            return new WP_REST_Response([
                'success' => false,
                'message' => __('TMDB API key is missing.', 'letterboxd-connect'),
            ], 400);
        }

        $result = $this->api_service->createTmdbRequestToken($api_key);

        if (is_wp_error($result)) {
            return new WP_REST_Response([
                'success' => false,
                'message' => $result->get_error_message(),
            ], 400);
        }

        $request_token = $result['request_token'];

        // Store the token temporarily for later use
        set_transient('letterboxd_tmdb_request_token', $request_token, 15 * MINUTE_IN_SECONDS);

        //  Build the redirect URI to return to your plugin with the necessary flag
        $redirect_url = add_query_arg([
            'page' => 'letterboxd-connect',
            'tab' => 'advanced',
            'tmdb_auth' => 'callback',
        ], admin_url('options-general.php'));

        //  Build full TMDB authorization URL
        $auth_url = "https://www.themoviedb.org/authenticate/{$request_token}?redirect_to=" . urlencode($redirect_url);

        return new WP_REST_Response([
            'success' => true,
            'request_token' => $request_token,
            'auth_url' => $auth_url,
        ]);
    }


    /**
     * Method to create TMDB session
     *
     * @param WP_REST_Request $request
     * @return WP_REST_Response
     */
    public function create_tmdb_session(WP_REST_Request $request): WP_REST_Response {
        $request_token = $request->get_param('request_token');
        $api_key = $this->advanced_options['tmdb_api_key'] ?? '';

        if (empty($api_key)) {
            return new WP_REST_Response([
                'success' => false,
                'message' => __('TMDB API key is missing.', 'letterboxd-connect'),
            ], 400);
        }

        $result = $this->api_service->createTmdbSession($api_key, $request_token);

        if (is_wp_error($result)) {
            return new WP_REST_Response([
                'success' => false,
                'message' => $result->get_error_message(),
            ], 400);
        }

        // Optional: Save session ID to advanced options
        $this->advanced_options['tmdb_session_id'] = $result['session_id'];
        update_option(self::ADVANCED_OPTION_NAME, $this->advanced_options);

        //  Stop the reload loop
        delete_transient('letterboxd_tmdb_auth_callback');

        return new WP_REST_Response([
            'success' => true,
            'session_id' => $result['session_id'],
        ]);
    }

}

================
File: includes/class-tmdb-handler.php
================
<?php
/**
 * Handles interactions with The Movie Database API with improved efficiency
 *
 * @package letterboxd-connect
 * @since 1.1.0
 */

declare(strict_types=1);

// Prevent direct access
if (!defined("ABSPATH")) {
    exit();
}

class Letterboxd_TMDB_Handler {
    private function debug_log($message) {
        letterboxd_debug_log($message, "TMDB_Handler");
    }

    /**
     * API constants
     */
    private const API_URL = "https://api.themoviedb.org/3";
    private const CACHE_GROUP = "letterboxd_tmdb";
    private const CACHE_DURATION = 604800; // 1 week
    private const STREAMING_CACHE_DURATION = 172800; // 2 days (streaming data changes more frequently)
    private const RATE_LIMIT_KEY = "tmdb_rate_limit";
    private const RATE_LIMIT_PERIOD = 1; // 1 second
    private const RATE_LIMIT_REQUESTS = 3; // Max 3 requests per second (TMDB's rate limit)

    /**
     * @var string API key
     */
    private string $api_key;

    /**
     * @var string|null Session ID
     */
    private ?string $session_id;

    /**
     * Class constructor
     */
    public function __construct() {
        $this->load_api_credentials();
    }

    /**
     * Load API credentials from options
     */
    private function load_api_credentials(): void {
        $options = get_option("letterboxd_wordpress_advanced_options", []);
        $this->api_key = $options["tmdb_api_key"] ?? "";
        $this->session_id = $options["tmdb_session_id"] ?? null;
    }

    /**
     * Check if API key is configured
     *
     * @return bool Whether API key is configured
     */
    public function is_api_key_configured(): bool {
        return !empty($this->api_key);
    }

    /**
     * Rate limit API requests to avoid hitting TMDB limits
     *
     * @return bool True if request should proceed, false if it should wait
     */
    private function check_rate_limit(): bool {
        $rate_data = get_transient(self::RATE_LIMIT_KEY);

        if (!$rate_data) {
            $rate_data = [
                "count" => 1,
                "timestamp" => time(),
            ];
            set_transient(
                self::RATE_LIMIT_KEY,
                $rate_data,
                self::RATE_LIMIT_PERIOD
            );
            return true;
        }

        $current_time = time();
        $elapsed = $current_time - $rate_data["timestamp"];

        // If period has elapsed, reset the counter
        if ($elapsed >= self::RATE_LIMIT_PERIOD) {
            $rate_data = [
                "count" => 1,
                "timestamp" => $current_time,
            ];
            set_transient(
                self::RATE_LIMIT_KEY,
                $rate_data,
                self::RATE_LIMIT_PERIOD
            );
            return true;
        }

        // If we've reached the limit, enforce waiting
        if ($rate_data["count"] >= self::RATE_LIMIT_REQUESTS) {
            return false;
        }

        // Increment the counter
        $rate_data["count"]++;
        set_transient(
            self::RATE_LIMIT_KEY,
            $rate_data,
            self::RATE_LIMIT_PERIOD - $elapsed
        );
        return true;
    }

    /**
     * Make an API request with rate limiting
     *
     * @param string $endpoint API endpoint
     * @param array $query_args Query arguments
     * @return array|WP_Error Response data or error
     */
    private function make_api_request(
        string $endpoint,
        array $query_args = []
    ): array|WP_Error {
        if (!$this->is_api_key_configured()) {
            return new WP_Error(
                "tmdb_api_not_configured",
                __("TMDB API key is not configured.", "letterboxd-connect")
            );
        }

        // Add API key to query args
        $query_args["api_key"] = $this->api_key;

        // Build full URL
        $url = self::API_URL . $endpoint;
        $url = add_query_arg($query_args, $url);

        // Apply rate limiting with retry logic
        $max_retries = 3;
        $retry_count = 0;

        while ($retry_count < $max_retries) {
            if ($this->check_rate_limit()) {
                $response = wp_remote_get($url, [
                    "timeout" => 30,
                    "headers" => [
                        "Accept" => "application/json",
                    ],
                ]);

                if (is_wp_error($response)) {
                    letterboxd_debug_log(
                        "TMDB API Error: " . $response->get_error_message()
                    );
                    return $response;
                }

                $status_code = wp_remote_retrieve_response_code($response);

                // Handle rate limiting response
                if ($status_code === 429) {
                    $retry_after = (int) wp_remote_retrieve_header(
                        $response,
                        "retry-after"
                    );
                    $retry_after = max(1, $retry_after); // Ensure at least 1 second
                    sleep($retry_after);
                    $retry_count++;
                    continue;
                }

                if ($status_code !== 200) {
                    $body = wp_remote_retrieve_body($response);
                    $data = json_decode($body, true);
                    $error_message = $data["status_message"] ?? "Unknown error";

                    letterboxd_debug_log(
                        "TMDB API Error ({$status_code}): {$error_message}"
                    );

                    return new WP_Error(
                        "tmdb_api_error_" . $status_code,
                        sprintf(
                            /* translators: %s: Error message from TMDB API */
                            __("TMDB API error: %s", "letterboxd-connect"),
                            $error_message
                        ),
                        ["status" => $status_code]
                    );
                }

                $data = json_decode(wp_remote_retrieve_body($response), true);

                if (empty($data) || !is_array($data)) {
                    return new WP_Error(
                        "tmdb_invalid_response",
                        __(
                            "Invalid response from TMDB API.",
                            "letterboxd-connect"
                        )
                    );
                }

                return $data;
            } else {
                // Wait for rate limit to reset
                sleep(self::RATE_LIMIT_PERIOD);
                $retry_count++;
            }
        }

        return new WP_Error(
            "tmdb_rate_limit_exceeded",
            __(
                "TMDB API rate limit exceeded after retries.",
                "letterboxd-connect"
            )
        );
    }

    /**
     * Get movie details from TMDB
     *
     * @param int $movie_id TMDB movie ID
     * @return array|WP_Error Movie data or error
     */
    public function get_movie_details(int $movie_id): array|WP_Error {
        $cache_key = "movie_" . $movie_id;
        $cached_data = wp_cache_get($cache_key, self::CACHE_GROUP);

        if ($cached_data !== false) {
            return $cached_data;
        }

        $response = $this->make_api_request("/movie/{$movie_id}", [
            "append_to_response" => "credits,release_dates,images,external_ids",
        ]);

        if (!is_wp_error($response)) {
            wp_cache_set(
                $cache_key,
                $response,
                self::CACHE_GROUP,
                self::CACHE_DURATION
            );
        }

        return $response;
    }

    /**
     * Batch fetch movie details for multiple movies
     *
     * @param array $movie_ids Array of TMDB movie IDs
     * @return array Array of movie data indexed by movie ID
     */
    public function batch_get_movie_details(array $movie_ids): array {
        $results = [];
        $ids_to_fetch = [];

        // Check cache first
        foreach ($movie_ids as $movie_id) {
            $cache_key = "movie_" . $movie_id;
            $cached_data = wp_cache_get($cache_key, self::CACHE_GROUP);

            if ($cached_data !== false) {
                $results[$movie_id] = $cached_data;
            } else {
                $ids_to_fetch[] = $movie_id;
            }
        }

        // Fetch uncached items
        foreach ($ids_to_fetch as $movie_id) {
            $data = $this->get_movie_details($movie_id);

            if (!is_wp_error($data)) {
                $results[$movie_id] = $data;
            } else {
                $results[$movie_id] = $data;
            }

            // Small delay between requests to respect rate limits
            if (count($ids_to_fetch) > 1) {
                usleep(300000); // 300ms
            }
        }

        return $results;
    }

    /**
     * Get streaming providers for a movie
     *
     * @param int $movie_id TMDB movie ID
     * @param string $region Region code (ISO 3166-1 alpha-2 code)
     * @return array|WP_Error Streaming providers data or error
     */
    public function get_streaming_providers(
        int $movie_id,
        string $region = "US"
    ): array|WP_Error {
        $cache_key = "streaming_" . $movie_id . "_" . $region;
        $cached_data = wp_cache_get($cache_key, self::CACHE_GROUP);

        if ($cached_data !== false) {
            return $cached_data;
        }

        $response = $this->make_api_request(
            "/movie/{$movie_id}/watch/providers"
        );

        if (is_wp_error($response)) {
            return $response;
        }

        // Extract providers for the requested region
        $providers = [];
        if (!empty($response["results"][$region])) {
            $providers = $response["results"][$region];
        }

        wp_cache_set(
            $cache_key,
            $providers,
            self::CACHE_GROUP,
            self::STREAMING_CACHE_DURATION
        );

        return $providers;
    }

    /**
     * Batch get streaming providers for multiple movies
     *
     * @param array $movie_ids Array of TMDB movie IDs
     * @param string $region Region code
     * @return array Streaming providers data indexed by movie ID
     */
    public function batch_get_streaming_providers(
        array $movie_ids,
        string $region = "US"
    ): array {
        $results = [];
        $ids_to_fetch = [];

        // Check cache first
        foreach ($movie_ids as $movie_id) {
            $cache_key = "streaming_" . $movie_id . "_" . $region;
            $cached_data = wp_cache_get($cache_key, self::CACHE_GROUP);

            if ($cached_data !== false) {
                $results[$movie_id] = $cached_data;
            } else {
                $ids_to_fetch[] = $movie_id;
            }
        }

        // Fetch uncached items
        foreach ($ids_to_fetch as $movie_id) {
            $providers = $this->get_streaming_providers($movie_id, $region);

            if (!is_wp_error($providers)) {
                $results[$movie_id] = $providers;
            } else {
                $results[$movie_id] = [];
            }

            // Small delay between requests to respect rate limits
            if (count($ids_to_fetch) > 1) {
                usleep(300000); // 300ms
            }
        }

        return $results;
    }

    /**
     * Process and format streaming provider data
     *
     * @param array $providers Raw provider data from TMDB
     * @return array Formatted provider data
     */
    public function format_streaming_providers(array $providers): array {
        $formatted = [
            "flatrate" => [],
            "rent" => [],
            "buy" => [],
            "free" => [],
            "ads" => [],
            "link" => $providers["link"] ?? "",
        ];

        $categories = ["flatrate", "rent", "buy", "free", "ads"];

        foreach ($categories as $category) {
            if (
                !empty($providers[$category]) &&
                is_array($providers[$category])
            ) {
                foreach ($providers[$category] as $provider) {
                    $formatted[$category][] = [
                        "provider_id" => $provider["provider_id"] ?? 0,
                        "provider_name" => $provider["provider_name"] ?? "",
                        "logo_path" => !empty($provider["logo_path"])
                            ? $this->get_image_url(
                                $provider["logo_path"],
                                "w92"
                            )
                            : "",
                    ];
                }
            }
        }

        return $formatted;
    }

    /**
     * Get a slug for the provider based on its name
     *
     * @param string $provider_name The provider's full name
     * @return string A slugified version of the provider name
     */
    private function get_provider_slug(string $provider_name): string {
        // Convert to lowercase and replace spaces with dashes
        $slug = strtolower(str_replace(" ", "-", $provider_name));

        // Remove any non-alphanumeric characters except dashes
        $slug = preg_replace("/[^a-z0-9-]/", "", $slug);

        // Remove multiple consecutive dashes
        $slug = preg_replace("/-+/", "-", $slug);

        return $slug;
    }

    /**
     * Create a URL-friendly slug from a movie title
     *
     * @param string $title Movie title
     * @return string URL-friendly slug
     */
    private function create_title_slug(string $title): string {
        // Remove special characters
        $slug = preg_replace("/[^\p{L}\p{N}\s-]/u", "", $title);
        // Replace spaces with dashes
        $slug = preg_replace("/\s+/", "-", $slug);
        // Convert to lowercase
        $slug = strtolower($slug);
        // Remove consecutive dashes
        $slug = preg_replace("/-+/", "-", $slug);
        // Trim dashes from beginning and end
        $slug = trim($slug, "-");

        return $slug;
    }

    /**
     * Get external IDs for a movie (IMDb, etc.)
     *
     * @param int $movie_id TMDB movie ID
     * @return array|WP_Error External IDs or error
     */
    public function get_external_ids(int $movie_id): array|WP_Error {
        $cache_key = "external_ids_" . $movie_id;
        $cached_data = wp_cache_get($cache_key, self::CACHE_GROUP);

        if ($cached_data !== false) {
            return $cached_data;
        }

        $response = $this->make_api_request("/movie/{$movie_id}/external_ids");

        if (!is_wp_error($response)) {
            wp_cache_set(
                $cache_key,
                $response,
                self::CACHE_GROUP,
                self::CACHE_DURATION
            );
        }

        return $response;
    }

    /**
     * Get directors from movie credits
     *
     * @param array $movie_data Movie data from TMDB
     * @return array List of directors
     */
    public function get_directors(array $movie_data): array {
        if (empty($movie_data["credits"]["crew"])) {
            return [];
        }

        $directors = [];
        foreach ($movie_data["credits"]["crew"] as $crew_member) {
            if ($crew_member["job"] === "Director") {
                $directors[] = $crew_member["name"];
            }
        }

        return $directors;
    }

    /**
     * Extract relevant movie metadata
     *
     * @param array $movie_data Movie data from TMDB
     * @param string $region Region code for streaming providers
     * @return array Extracted metadata
     */
    public function extract_movie_metadata(
        array $movie_data,
        string $region = "US"
    ): array {
        $metadata = [];

        // Basic movie information
        $metadata["tmdb_title"] = $movie_data["title"] ?? "";
        $metadata["tmdb_original_title"] = $movie_data["original_title"] ?? "";
        $metadata["tmdb_overview"] = $movie_data["overview"] ?? "";
        $metadata["tmdb_release_date"] = $movie_data["release_date"] ?? "";
        $metadata["tmdb_id"] = $movie_data["id"] ?? 0; // Store the TMDB ID consistently

        // Images
        if (!empty($movie_data["poster_path"])) {
            $metadata["tmdb_poster_path"] = $movie_data["poster_path"];
        }
        if (!empty($movie_data["backdrop_path"])) {
            $metadata["tmdb_backdrop_path"] = $movie_data["backdrop_path"];
        }

        // Directors (from credits)
        $directors = $this->get_directors($movie_data);
        if (!empty($directors)) {
            $metadata["director"] = implode(", ", $directors);
        }

        // Extract external IDs
        if (!empty($movie_data["external_ids"])) {
            if (!empty($movie_data["external_ids"]["imdb_id"])) {
                $metadata["imdb_id"] = $movie_data["external_ids"]["imdb_id"];
            }
        } elseif (!empty($movie_data["id"])) {
            // If we don't have external IDs in the current data, fetch them separately
            $external_ids = $this->get_external_ids($movie_data["id"]);
            if (
                !is_wp_error($external_ids) &&
                !empty($external_ids["imdb_id"])
            ) {
                $metadata["imdb_id"] = $external_ids["imdb_id"];
            }
        }

        // Genres
        if (!empty($movie_data["genres"])) {
            $genres = array_map(function ($genre) {
                return $genre["name"];
            }, $movie_data["genres"]);

            $metadata["tmdb_genres"] = implode(", ", $genres);
        }

        // Get streaming providers if TMDB ID is available
        if (!empty($movie_data["id"])) {
            $providers = $this->get_streaming_providers(
                $movie_data["id"],
                $region
            );
            if (!is_wp_error($providers) && !empty($providers)) {
                $metadata["streaming_providers"] = wp_json_encode(
                    $this->format_streaming_providers($providers)
                );
                $metadata["streaming_link"] = $providers["link"] ?? "";
                $metadata["streaming_providers_updated"] = current_time(
                    "mysql"
                );
            }
        }

        return $metadata;
    }

    /**
     * Batch update streaming providers for movies
     *
     * @param array $post_ids Array of WordPress post IDs
     * @param string $region Region code
     * @return array Results with updated count and errors
     */
    public function batch_update_streaming_providers(
        array $post_ids,
        string $region = "US"
    ): array {
        $results = [
            "updated" => 0,
            "failed" => 0,
            "errors" => [],
        ];

        if (!$this->is_api_key_configured()) {
            letterboxd_debug_log(
                "TMDB API key not configured for streaming provider update"
            );
            return [
                "updated" => 0,
                "failed" => count($post_ids),
                "errors" => ["TMDB API key is not configured."],
            ];
        }

        // Get TMDB IDs for all posts - check both possible meta keys
        $tmdb_ids = [];
        $post_tmdb_map = [];

        foreach ($post_ids as $post_id) {
            // Check both possible meta key names
            $tmdb_id = get_post_meta($post_id, "tmdb_id", true);
            if (empty($tmdb_id)) {
                $tmdb_id = get_post_meta($post_id, "tmdb_movie_id", true);
            }

            if (!empty($tmdb_id)) {
                $tmdb_ids[] = (int) $tmdb_id;
                $post_tmdb_map[(int) $tmdb_id] = $post_id;
            } else {
                $results["failed"]++;
                letterboxd_debug_log("No TMDB ID for post {$post_id}");
            }
        }

        if (empty($tmdb_ids)) {
            return $results;
        }

        try {
            // Process in chunks to avoid timeouts (max 5 at a time)
            $tmdb_id_chunks = array_chunk($tmdb_ids, 5);

            foreach ($tmdb_id_chunks as $chunk) {
                // Batch get streaming providers
                $providers_data = $this->batch_get_streaming_providers(
                    $chunk,
                    $region
                );

                // Update post meta for each movie
                foreach ($providers_data as $tmdb_id => $providers) {
                    $post_id = $post_tmdb_map[$tmdb_id] ?? 0;
                    if (!$post_id) {
                        $results["failed"]++;
                        continue;
                    }

                    if (empty($providers) || is_wp_error($providers)) {
                        $results["failed"]++;
                        $error_msg = is_wp_error($providers)
                            ? $providers->get_error_message()
                            : "No providers for TMDB ID {$tmdb_id}";
                        $results["errors"][] = $error_msg;
                        letterboxd_debug_log($error_msg);
                        continue;
                    }

                    try {
                        $formatted_providers = $this->format_streaming_providers(
                            $providers
                        );

                        // Update post meta
                        update_post_meta(
                            $post_id,
                            "streaming_providers",
                            wp_json_encode($formatted_providers)
                        );
                        update_post_meta(
                            $post_id,
                            "streaming_link",
                            $providers["link"] ?? ""
                        );
                        update_post_meta(
                            $post_id,
                            "streaming_providers_updated",
                            current_time("mysql")
                        );

                        $results["updated"]++;
                    } catch (Exception $e) {
                        $results["failed"]++;
                        $error_msg =
                            "Error processing TMDB ID {$tmdb_id}: " .
                            $e->getMessage();
                        $results["errors"][] = $error_msg;
                        letterboxd_debug_log($error_msg);
                    }
                }

                // Small pause between chunks to avoid overloading the server
                if (count($tmdb_id_chunks) > 1) {
                    usleep(500000); // 500ms pause
                }
            }
        } catch (Exception $e) {
            letterboxd_debug_log(
                "Exception during batch update: " . $e->getMessage()
            );
            $results["errors"][] =
                "Exception during batch update: " . $e->getMessage();
        }

        return $results;
    }

    /**
     * Generate IMDb URL from IMDb ID
     *
     * @param string $imdb_id IMDb ID
     * @return string IMDb URL
     */
    public function get_imdb_url(string $imdb_id): string {
        return "https://www.imdb.com/title/{$imdb_id}/";
    }

    /**
     * Generate Rotten Tomatoes search URL based on movie title and year
     *
     * @param string $title Movie title
     * @param string $year Release year
     * @return string Rotten Tomatoes search URL
     */
    public function get_rotten_tomatoes_url(
        string $title,
        string $year
    ): string {
        $search_query = urlencode(trim($title) . " " . trim($year));
        return "https://www.rottentomatoes.com/search?search={$search_query}";
    }

    /**
     * Get image URL with size
     *
     * @param string $path Image path from TMDB
     * @param string $size Image size (w500, original, etc.)
     * @return string Full image URL
     */
    public function get_image_url(string $path, string $size = "w500"): string {
        return "https://image.tmdb.org/t/p/{$size}{$path}";
    }

    /**
     * Clear streaming provider cache for a region
     *
     * @param string $region Region code
     * @return bool Success
     */
    public function clear_streaming_cache(string $region = ""): bool {
        global $wpdb;

        if (wp_using_ext_object_cache()) {
            // For external object cache, we need to selectively delete
            // This implementation is simplified and may need customization based on actual cache setup
            if (empty($region)) {
                wp_cache_flush();
            } else {
                // You'd need a way to iterate over all cache keys matching a pattern
                // This is a simplification since pattern-based deletion depends on the cache implementation
                $pattern = "streaming_*_" . $region;
                // Implementation depends on your cache system
            }
            return true;
        } else {
            // For WordPress transients
            $pattern = empty($region)
                ? "%_streaming_%"
                : "%_streaming_%" . $region . "%";

            return $wpdb->query(
                $wpdb->prepare(
                    "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s",
                    "_transient_" . self::CACHE_GROUP . $pattern
                )
            ) !== false;
        }
    }
}

================
File: includes/functions.php
================
<?php
/**
 * Helper functions for the Letterboxd Connect plugin
 *
 * @package letterboxd-connect
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Register Letterboxd block category
 */
function letterboxd_register_block_category($categories, $post) {
     return array_merge($categories, [
         [
             'slug' => 'letterboxd-blocks',
             'title' => __('Letterboxd', 'letterboxd-connect'),
             'icon' => 'video-alt2'
         ]
     ]);
 }
 if (version_compare(get_bloginfo('version'), '5.8', '>=')) {
     add_filter('block_categories_all', 'letterboxd_register_block_category', 10, 2);
 } else {
     add_filter('block_categories', 'letterboxd_register_block_category', 10, 2);
 }

/**
* Register block assets and scripts
*/
function letterboxd_register_block_assets() {
    if (!function_exists('register_block_type')) {
        return;
    }
    
    $plugin_dir = plugin_dir_path(LETTERBOXD_PLUGIN_FILE);
    $plugin_url = plugin_dir_url(LETTERBOXD_PLUGIN_FILE);
    
    if (!file_exists($plugin_dir . 'js/movie-block.js')) {
        letterboxd_debug_log('Movie block JS file not found at: ' . $plugin_dir . 'js/movie-block.js', 'Block_Assets');
        return;
    }
    
    wp_register_script(
        'letterboxd-blocks',
        $plugin_url . 'js/movie-block.js',
        [
            'wp-blocks',
            'wp-element',
            'wp-editor',
            'wp-components',
            'wp-i18n',
            'wp-block-editor',
            'wp-server-side-render',
            'lodash'
        ],
        LETTERBOXD_VERSION,
        true
    );
    
    wp_localize_script('letterboxd-blocks', 'letterboxdBlockData', [
        'pluginUrl' => $plugin_url
    ]);
}

/**
 * Clean up any temporary files created during import
 */
function letterboxd_cleanup_temp_files() {
    $upload_dir = wp_upload_dir();
    $temp_dir = $upload_dir['basedir'] . '/letterboxd-temp';
    
    if (is_dir($temp_dir)) {
        // Initialize filesystem
        global $wp_filesystem;
        if (empty($wp_filesystem)) {
            require_once(ABSPATH . '/wp-admin/includes/file.php');
            WP_Filesystem();
        }
        
        $files = glob($temp_dir . '/*');
        foreach ($files as $file) {
            if (is_file($file) && time() - filemtime($file) > 3600) {
                $wp_filesystem->delete($file);
            }
        }
    }
    
}

================
File: js/settings.js
================
/**
 * Letterboxd Connect Settings Page JavaScript
 */

jQuery(document).ready(($) => {
	// Cache frequently used selectors and constants
	const SELECTORS = {
		startDate: '#start_date',
		usernameField: 'input[name="letterboxd_wordpress_options[username]"]',
		usernameMessage: '#username-validation-message',
		settingsForm: '#letterboxd-settings-form',
		settingsMessage: '#settings-update-message',
		importDetails: '#last-import-details',
		runImportTrigger: '#letterboxd_run_import_trigger',
		// Auto-import selectors
		autoImportFrequency: 'select[name="letterboxd_auto_import_options[frequency]"]',
		autoImportNotifications: 'input[name="letterboxd_auto_import_options[notifications]"]',
		// TMDB API selectors
		tmdbApiKeyField: '#tmdb_api_key',
		validateTmdbButton: '#validate-tmdb-api',
		tmdbValidationResult: '#tmdb-api-validation-result',
		tmdbAuthorizeButton: '#tmdb-authorize-button',
		tmdbAuthStatus: '#tmdb-auth-status'
	};
	
	const CLASSES = {
		notice: {
			error: 'notice-error',
			success: 'notice-success',
			info: 'notice-info',
			hidden: 'hidden'
		}
	};

	const UPDATE_INTERVAL = 30000; // 30 seconds
	const USERNAME_DEBOUNCE = 500; // 500ms debounce for username validation

	// Validate required settings
	if (typeof letterboxdSettings === 'undefined') {
		console.error('Letterboxd settings not found');
		return;
	}

	const { apiRoot, apiNonce, restNamespace } = letterboxdSettings;
		
	if (!apiRoot || !apiNonce) {
		console.error('Required Letterboxd API settings missing');
		return;
	}
	
	// Define default messages
	const messages = {
		errorValidating: "Error validating username.",
		savingSettings: "Saving settings...",
		settingsSaved: "Settings saved successfully.",
		errorSaving: "Error saving settings.",
		lastImport: "Last Import",
		totalImported: "Total Imported",
		nextCheck: "Next Check",
		lastError: "Last Error",
		// TMDB API messages
		testingConnection: "Testing connection...",
		enterApiKey: "Please enter an API key first",
		connectionSuccess: "API connection successful!",
		connectionError: "Error connecting to TMDB API"
	};
	
	function initializeComponents() {
		initializeDatepicker();
		setupUsernameValidation();
		setupTmdbApiValidation();
		setupFormSubmission();
		initializeStatusUpdates();
		setupTmdbAuth();
		setupTmdbUpdateButton();
	}
	
	function initializeDatepicker() {
		$(SELECTORS.startDate).datepicker({
			dateFormat: 'yy-mm-dd',
			maxDate: new Date(),
			changeMonth: true,
			changeYear: true
		});
	}
	
	
	function setupTmdbAuth() {
		const authorizeButton = $(SELECTORS.tmdbAuthorizeButton);
		const authStatusDiv = $(SELECTORS.tmdbAuthStatus);
		
		authorizeButton.on('click', function(e) {
			e.preventDefault();
		
			authStatusDiv.html('<span>Creating authorization request...</span>');
			
			wp.apiFetch({
				path: `${restNamespace}/tmdb-create-request-token`,
				method: 'GET'
			}).then(response => {
				if (response.success && response.auth_url) {
					// Redirect user to TMDB authorization page
					window.open(response.auth_url, "_self");
				} else {
					updateMessage(
						authStatusDiv, 
						response.message || 'Failed to create authorization request.',
						CLASSES.notice.error
					);
				}
			}).catch(error => {
				updateMessage(
					authStatusDiv,
					error.message || 'An error occurred during authorization.',
					CLASSES.notice.error
				);
			});
		});
		
		// Handle callback from TMDB authorization
		if (typeof letterboxdTmdbAuth !== 'undefined' && letterboxdTmdbAuth.request_token) {
			authStatusDiv.html('<span>Creating session...</span>');
			
			wp.apiFetch({
				path: `${restNamespace}/tmdb-create-session`,
				method: 'POST',
				data: {
					request_token: letterboxdTmdbAuth.request_token
				}
			}).then(response => {
				if (response.success) {
					updateMessage(
						authStatusDiv,
						'TMDB authentication successful!',
						CLASSES.notice.success
					);
					
					// Reload page after a delay to show current auth status
					setTimeout(() => window.location.reload(), 2000);
				} else {
					updateMessage(
						authStatusDiv,
						response.message || 'Failed to create session.',
						CLASSES.notice.error
					);
				}
			}).catch(error => {
				updateMessage(
					authStatusDiv,
					error.message || 'An error occurred during session creation.',
					CLASSES.notice.error
				);
			});
		}
	}

	function setupUsernameValidation() {
		let debounceTimer;
		const usernameField = $(SELECTORS.usernameField);
		const messageDiv = $(SELECTORS.usernameMessage);

		usernameField.on('input', function() {
			const username = this.value;
			clearTimeout(debounceTimer);

			if (username) {
				debounceTimer = setTimeout(() => validateUsername(username, messageDiv), USERNAME_DEBOUNCE);
			} else {
				messageDiv.fadeOut();
			}
		});
	}

	function validateUsername(username, messageDiv) {
		wp.apiFetch({
			path: `${restNamespace}/validate-username?username=${encodeURIComponent(username)}`,
			method: 'GET'
		}).then(response => {
			updateMessage(
				messageDiv,
				response.message,
				response.success ? CLASSES.notice.success : CLASSES.notice.error
			);
		}).catch(error => {
			updateMessage(messageDiv, messages.errorValidating, CLASSES.notice.error);
		});
	}
	
	function setupTmdbApiValidation() {
		const validateButton = $(SELECTORS.validateTmdbButton);
		const resultSpan = $(SELECTORS.tmdbValidationResult);

		validateButton.on('click', function() {
			const apiKey = $(SELECTORS.tmdbApiKeyField).val();
			
			if (!apiKey) {
				updateMessage(resultSpan, messages.enterApiKey, CLASSES.notice.error);
				return;
			}
			
			resultSpan.html(`<span>${messages.testingConnection}</span>`);
			
			wp.apiFetch({
				path: `${restNamespace}/validate-tmdb-api?api_key=${encodeURIComponent(apiKey)}`,
				method: 'GET'
			}).then(response => {
				updateMessage(
					resultSpan,
					response.message,
					response.success ? CLASSES.notice.success : CLASSES.notice.error
				);
			}).catch(error => {
				console.error('API validation error:', error);
				updateMessage(
					resultSpan,
					error.message || messages.connectionError,
					CLASSES.notice.error
				);
			});
		});
	}
	
	function setupTmdbUpdateButton() {
		$('.tmdb-bulk-update-section a.button').on('click', function(e) {
			
			// Disable button and add spinner
			const $button = $(this);
			$button.addClass('disabled').css('pointer-events', 'none');
			$button.prepend('<span class="spinner is-active"></span>');
			
			// Add status text
			$button.parent().append('<p class="update-status">Update in progress, please wait...</p>');
		});
	}

	function setupFormSubmission() {
		const form = $(SELECTORS.settingsForm);
		const messageDiv = $(SELECTORS.settingsMessage);
	
		form.on('submit', function(e) {
			e.preventDefault();
			const submitButton = form.find(':submit');
			submitButton.prop('disabled', true);
			
			updateMessage(messageDiv, messages.savingSettings, CLASSES.notice.info);
			
			// Get current tab
			const currentTab = window.location.href.indexOf('tab=advanced') > -1 ? 'advanced' : 'general';
			
			// Create data object with required fields
			const data = {};
			
			// Always include username (required field)
			const usernameField = form.find('input[name="letterboxd_wordpress_options[username]"]');
			data.username = usernameField.val() || '';
			
			// Include other fields
			if (currentTab === 'general') {
				// Get from form for general tab
				const formData = new FormData(this);
				data.start_date = formData.get('letterboxd_wordpress_options[start_date]');
				data.draft_status = formData.get('letterboxd_wordpress_options[draft_status]') === '1';
				
				// Get the checkbox value explicitly - be very explicit about the '1' value
				const runImportChecked = formData.get('letterboxd_run_import_trigger') === '1';
				data.run_import_trigger = runImportChecked ? '1' : '0';
				
				data.letterboxd_auto_import_options = {
					frequency: formData.get('letterboxd_auto_import_options[frequency]') || 'daily',
					notifications: formData.get('letterboxd_auto_import_options[notifications]') === '1'
				};
			} else {
				// Use existing values for general tab fields
				data.start_date = letterboxdSettings.settings.start_date || '';
				data.draft_status = letterboxdSettings.settings.draft_status || false;
				
				// IMPORTANT: Always explicitly set run_import_trigger to '0' for advanced tab
				data.run_import_trigger = '0';
			}
			
			// Get TMDB API key regardless of tab
			data.tmdb_api_key = $(SELECTORS.tmdbApiKeyField).val();
			
			wp.apiFetch({
				path: `${restNamespace}/settings`,
				method: 'POST',
				data: data
			}).then(response => {
				updateMessage(
					messageDiv,
					response.message,
					response.success ? CLASSES.notice.success : CLASSES.notice.error
				);
		
				if (response.success) {
					// Reload to show updated status
					setTimeout(() => window.location.reload(), 1000);
				}
			}).catch(error => {
				updateMessage(
					messageDiv, 
					error.message || messages.errorSaving, 
					CLASSES.notice.error
				);
			}).finally(() => {
				submitButton.prop('disabled', false);
			});
		});
	}

	function initializeStatusUpdates() {
		updateImportStatus();
		setInterval(updateImportStatus, UPDATE_INTERVAL);
	}

	function updateImportStatus() {
		wp.apiFetch({
			path: `${restNamespace}/import-status`,
			method: 'GET'
		}).then(response => {
			if (response.success) {
				updateStatusDisplay(response);
			}
		}).catch(error => {
			console.error('Failed to fetch import status:', error);
		});
	}

	function updateStatusDisplay(status) {
		const details = [];
		
		if (status.last_import) {
			details.push(`<p>${messages.lastImport}: ${formatTimestamp(status.last_import)}</p>`);
		}
		if (status.imported_count) {
			details.push(`<p>${messages.totalImported}: ${status.imported_count}</p>`);
		}
		if (status.next_check) {
			details.push(`<p>${messages.nextCheck}: ${formatTimestamp(status.next_check)}</p>`);
		}
		if (status.last_error) {
			details.push(`<p class="error">${messages.lastError}: ${status.last_error}</p>`);
		}
	
		$(SELECTORS.importDetails).html(details.join(''));
	}

	function formatTimestamp(timestamp) {
		return new Date(timestamp * 1000).toLocaleString();
	}

	function updateMessage(div, message, className) {
		div
			.removeClass(`${CLASSES.notice.error} ${CLASSES.notice.success} ${CLASSES.notice.info} ${CLASSES.notice.hidden}`)
			.addClass(className)
			.html(`<p>${message}</p>`)
			.fadeIn();
	}
	
	initializeComponents();
});

================
File: letterboxd.php
================
<?php
/**
 * Plugin Name: Letterboxd Connect
 * Plugin URI: https://letterboxdconnect.com
 * Description: Connect your Letterboxd film diary to WordPress by automatically importing and displaying your watched movies, enhanced by TMDB metadata in customizable grid layouts
 * Version: 1.0
 * Author: David Stagg
 * Author URI: https://davidstagg.com
 * License: GPL v3 or later
 * License URI: https://www.gnu.org/licenses/gpl-3.0.html
 */

// Prevent direct access
if (!defined("ABSPATH")) {
    if (headers_sent()) {
        die("Direct access not permitted.");
    } else {
        header("HTTP/1.0 403 Forbidden");
        die("Direct access not permitted.");
    }
}

/**
 * Conditional debug logging
 *
 * @param string $message The message to log
 * @param string $component Optional component name
 */
function letterboxd_debug_log($message, $component = "") {
    if (defined("WP_DEBUG") && WP_DEBUG) {
        $prefix = empty($component)
            ? "Letterboxd: "
            : "Letterboxd {$component}: ";
        error_log($prefix . $message);
    }
}

/**
 * Check if WordPress version is compatible with plugin requirements
 *
 * @return bool Whether WordPress is compatible
 */
function letterboxd_check_wp_compatibility() {
    global $wp_version;
    $is_compatible = version_compare($wp_version, "5.6", ">=");

    if (!$is_compatible) {
        add_action("admin_notices", function () {
            echo '<div class="error"><p>';
            esc_html_e(
                "Letterboxd Connect requires WordPress version 5.6 or higher.",
                "letterboxd-connect"
            );
            echo "</p></div>";
        });
    }

    return $is_compatible;
}

// Check compatibility before loading the rest of the plugin
if (!letterboxd_check_wp_compatibility()) {
    return;
}

// Define plugin constants
if (!defined("LETTERBOXD_PLUGIN_FILE")) {
    define("LETTERBOXD_PLUGIN_FILE", __FILE__);
}
define("LETTERBOXD_PLUGIN_DIR", plugin_dir_path(__FILE__));
define("LETTERBOXD_PLUGIN_URL", plugin_dir_url(__FILE__));
define("LETTERBOXD_VERSION", "1.0.0");

// Load traits
require_once LETTERBOXD_PLUGIN_DIR .
    "includes/traits/trait-letterboxd-validation.php";
require_once LETTERBOXD_PLUGIN_DIR .
    "includes/traits/trait-letterboxd-error-handling.php";
require_once LETTERBOXD_PLUGIN_DIR .
    "includes/traits/trait-letterboxd-security.php";

// Load interfaces and services first
require_once LETTERBOXD_PLUGIN_DIR .
    "includes/interfaces/interface-letterboxd-api-service.php";
require_once LETTERBOXD_PLUGIN_DIR .
    "includes/services/class-letterboxd-api-service.php";

// Autoload classes
spl_autoload_register(function ($class_name) {
    // Only process classes with the Letterboxd prefix
    if (strpos($class_name, "Letterboxd_") !== 0) {
        return;
    }

    $class_files = [
        "Letterboxd_Movie_Post_Type" => "includes/class-movie-post-type.php",
        "Letterboxd_Importer" => "includes/class-letterboxd-importer.php",
        "Letterboxd_Movie_Block_Renderer" =>
            "includes/class-movie-block-renderer.php",
        "Letterboxd_Settings_Manager" => "includes/class-settings-manager.php",
        "Letterboxd_Auto_Import" => "includes/class-auto-import.php",
        "Letterboxd_TMDB_Handler" => "includes/class-tmdb-handler.php"
    ];

    if (isset($class_files[$class_name])) {
        require_once LETTERBOXD_PLUGIN_DIR . $class_files[$class_name];
    }
});

/**
 * Main plugin class
 */
class Letterboxd_To_WordPress {
    /**
     * Plugin instance (Singleton pattern)
     *
     * @var Letterboxd_To_WordPress
     */
    private static $instance = null;

    /**
     * Get plugin instance (Singleton pattern)
     *
     * @return Letterboxd_To_WordPress
     */
    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    /**
     * @var Letterboxd_Movie_Post_Type
     */
    private $post_type = null;

    /**
     * @var Letterboxd_Importer
     */
    public $importer = null;

    /**
     * @var Letterboxd_Movie_Block_Renderer
     */
    private $block_renderer = null;

    /**
     * @var Letterboxd_Settings_Manager
     */
    private $settings = null;

    /**
     * @var Letterboxd_Auto_Import
     */
    private $auto_import = null;

    /**
     * @var LetterboxdApiServiceInterface
     */
    private $api_service = null;

    /**
     * Initialize the plugin
     */
    public function __construct() {
        // Initialize API service first
        $this->api_service = new LetterboxdApiService();

        // Initialize components with dependencies
        $this->post_type = new Letterboxd_Movie_Post_Type();
        $this->importer = new Letterboxd_Importer($this->post_type);
        $this->block_renderer = new Letterboxd_Movie_Block_Renderer();
        $this->settings = new Letterboxd_Settings_Manager($this->api_service);
        $this->auto_import = new Letterboxd_Auto_Import($this);

        // Register all hooks
        $this->register_hooks();
    }

    /**
     * Register all hooks for plugin components
     */
    private function register_hooks(): void {
        // Register activation/deactivation hooks
        register_activation_hook(__FILE__, [$this, "activate"]);
        register_deactivation_hook(__FILE__, [$this, "deactivate"]);

        // Register admin notices
        add_action("admin_notices", [$this, "display_username_notice"]);
    }

    // Add this new method
    public function ensure_block_renderer_initialized() {
        // initialize the block renderer if it's not already initialized
        $this->get_block_renderer();
    }

    // Prevent cloning
    public function __clone() {}

    // Prevent wakeup
    public function __wakeup() {}

    /**
     * Set up public property access to maintain compatibility
     */
    public function setup_property_access() {
        // For public property access (keeps backward compatibility)
        // Make the importer property work as expected for external code
        if ($this->importer === null) {
            $this->importer = $this->get_importer();
        }
    }

    /**
     * Get API service with lazy loading
     *
     * @return LetterboxdApiServiceInterface
     */
    private function get_api_service() {
        if (null === $this->api_service) {
            $this->api_service = new LetterboxdApiService();
        }
        return $this->api_service;
    }

    /**
     * Get post type handler with lazy loading
     *
     * @return Letterboxd_Movie_Post_Type
     */
    private function get_post_type() {
        if (null === $this->post_type) {
            $this->post_type = new Letterboxd_Movie_Post_Type();
        }
        return $this->post_type;
    }

    /**
     * Get importer with lazy loading
     *
     * @return Letterboxd_Importer
     */
    private function get_importer() {
        if (null === $this->importer) {
            $this->importer = new Letterboxd_Importer($this->get_post_type());
        }
        return $this->importer;
    }

    /**
     * Get block renderer with lazy loading
     *
     * @return Letterboxd_Movie_Block_Renderer
     */
    private function get_block_renderer() {
        if (null === $this->block_renderer) {
            $this->block_renderer = new Letterboxd_Movie_Block_Renderer();
        }
        return $this->block_renderer;
    }

    /**
     * Get settings manager with lazy loading
     *
     * @return Letterboxd_Settings_Manager
     */
    private function get_settings() {
        if (null === $this->settings) {
            $this->settings = new Letterboxd_Settings_Manager(
                $this->get_api_service()
            );
        }
        return $this->settings;
    }

    /**
     * Get auto import handler with lazy loading
     *
     * @return Letterboxd_Auto_Import
     */
    private function get_auto_import() {
        if (null === $this->auto_import) {
            $this->auto_import = new Letterboxd_Auto_Import($this);
        }
        return $this->auto_import;
    }

    /**
     * Plugin activation
     */
    public function activate() {
        // Create necessary directories in one operation
        $upload_dir = wp_upload_dir();
        $base_dir = $upload_dir["basedir"];

        $dirs = [
            $base_dir . "/letterboxd-temp",
            $base_dir . "/letterboxd-posters"
        ];

        foreach ($dirs as $dir) {
            if (!file_exists($dir)) {
                wp_mkdir_p($dir);
            }
        }

        // Set up the auto-import schedule.
        if (!isset($this->auto_import)) {
            $this->auto_import = $this->get_auto_import();
        }

        if (method_exists($this->auto_import, "initialize_schedule")) {
            $this->auto_import->initialize_schedule();
        }

        // Flush rewrite rules.
        flush_rewrite_rules();
    }

    /**
     * Plugin deactivation
     */
    public function deactivate(): void {
        // Clear scheduled events
        wp_clear_scheduled_hook("letterboxd_check_and_import");

        // Also clear the transient cleanup schedule
        wp_clear_scheduled_hook("letterboxd_cleanup_transients");

        // Clean up specific transients by type
        $transients_to_delete = [
            // Importer transients
            "letterboxd_to_wp_import_import_lock",
            "letterboxd_to_wp_import_feed_",

            // Auto-import transients
            "letterboxd_auto_import_import_lock",
            "letterboxd_rate_limit",

            // Block renderer transients
            "letterboxd_blocks_editor_data",
            "letterboxd_blocks_block_",
            "letterboxd_blocks_movie_query_",

            // TMDB Handler transients
            "letterboxd_tmdb_movie_",
            "letterboxd_tmdb_streaming_",
            "letterboxd_tmdb_external_ids_",
            "tmdb_rate_limit",
            "letterboxd_tmdb_request_token",
            "letterboxd_tmdb_auth_callback",

            // Debug transient
            "letterboxd_created_transients"
        ];

        global $wpdb;

        // Process each transient type with both direct and pattern-based deletion
        foreach ($transients_to_delete as $transient_base) {
            // For exact matches (simple transients)
            delete_transient($transient_base);

            // For pattern-based matches (transients with dynamic parts)
            $like_pattern = $wpdb->esc_like($transient_base) . "%";
            $transient_keys = $wpdb->get_col(
                $wpdb->prepare(
                    "SELECT option_name FROM {$wpdb->options} 
                    WHERE option_name LIKE %s 
                    OR option_name LIKE %s",
                    "_transient_" . $like_pattern,
                    "_transient_timeout_" . $like_pattern
                )
            );

            foreach ($transient_keys as $key) {
                $clean_name = str_replace(
                    ["_transient_", "_transient_timeout_"],
                    "",
                    $key
                );
                delete_transient($clean_name);
            }
        }

        // Flush rewrite rules
        flush_rewrite_rules();
    }

    /**
     * Display admin notice for missing username
     */
    public function display_username_notice() {
        // Get the saved options - use static caching
        static $options = null;
        if (null === $options) {
            $options = get_option("letterboxd_wordpress_options", []);
        }

        $username = isset($options["username"]) ? $options["username"] : "";

        // Only show notice if username isn't set
        if (empty($username)) {
            $settings_url = admin_url(
                "options-general.php?page=letterboxd-connect"
            ); ?>
            <div class="notice notice-warning is-dismissible">
                <p>
                    <?php
                    printf(
                        wp_kses(
                            // translators: %s is the URL to the settings page
                            __(
                                'Please <a href="%s">set your Letterboxd username</a> to start using the Letterboxd Connect plugin',
                                "letterboxd-connect"
                            ),
                            ['a' => ['href' => []]]
                        ),
                        esc_url($settings_url)
                    ); ?>
                </p>
            </div>
            <?php
        }
    }
}

// Initialize plugin
$letterboxd_to_wordpress = Letterboxd_To_WordPress::get_instance();

// Include helper functions
require_once LETTERBOXD_PLUGIN_DIR . "includes/functions.php";

================
File: uninstall.php
================
<?php
/**
 * Uninstall script for Letterboxd Connect plugin
 * 
 * This file will be called automatically when the plugin is uninstalled through WordPress.
 * It cleans up all plugin-related data from the database.
 *
 * @package letterboxd-connect
 */

// Exit if not called by WordPress during uninstall
if (!defined('WP_UNINSTALL_PLUGIN')) {
    exit;
}

// Define plugin constants if not already defined
if (!defined('LETTERBOXD_VERSION')) {
    define('LETTERBOXD_VERSION', '1.0.0');
}

/**
 * Main cleanup class
 */
class Letterboxd_Uninstaller {

    private function validate_uninstall_context(): bool {
        if (!defined('WP_UNINSTALL_PLUGIN')) {
            return false;
        }
        if (!current_user_can('activate_plugins')) {
            return false;
        }
        return true;
    }
    
    /**
     * Plugin options and transients
     */
    private const OPTIONS = [
        // Main plugin options
        'letterboxd_wordpress_options',
        'letterboxd_auto_import_options',
        
        // Statistics and logs
        'letterboxd_last_import',
        'letterboxd_last_check',
        'letterboxd_last_import_date',
        'letterboxd_imported_count',
        'letterboxd_last_error',
        'letterboxd_import_log',
        'letterboxd_error_log'
    ];

    /**
     * Transient prefixes to clean
     */
    private const TRANSIENT_PREFIXES = [
        'letterboxd_import_lock',
        'letterboxd_cache',
        'letterboxd_block'
    ];

    /**
     * Post meta keys
     */
    private const POST_META_KEYS = [
        'letterboxd_url',
        'watch_date',
        'poster_url'
    ];

    /**
     * Run the uninstaller
     */
    public static function uninstall(): void {
        $uninstaller = new self();
        
        // Perform cleanup in specific order
        $uninstaller->remove_attachments();
        $uninstaller->remove_post_type();
        $uninstaller->remove_taxonomies();
        $uninstaller->remove_options();
        $uninstaller->remove_transients();
        $uninstaller->cleanup_uploads();
        $uninstaller->clear_caches();
    }

    /**
     * Remove all attachments associated with movie posts
     */
    private function remove_attachments(): void {
        global $wpdb;
        
        // Get all movie post IDs
        $movie_ids = get_posts([
            'post_type' => 'movie',
            'numberposts' => -1,
            'post_status' => 'any',
            'fields' => 'ids'
        ]);
        
        if (empty($movie_ids)) {
            return;
        }
        
        // Get all featured images from these posts
        $thumbnail_ids = [];
        foreach ($movie_ids as $post_id) {
            $thumbnail_id = get_post_thumbnail_id($post_id);
            if ($thumbnail_id) {
                $thumbnail_ids[] = $thumbnail_id;
            }
        }
        
        // Get all attachments that are attached to movie posts
        $placeholders = implode(',', array_fill(0, count($movie_ids), '%d'));
        $attached_attachments = $wpdb->get_col($wpdb->prepare(
            "SELECT ID FROM {$wpdb->posts} 
            WHERE post_type = 'attachment' 
            AND post_parent IN ($placeholders)",
            $movie_ids
        ));
        
        // Merge unique attachment IDs
        $all_attachments = array_unique(array_merge($thumbnail_ids, $attached_attachments));
        
        // Delete each attachment and ensure metadata is removed
        foreach ($all_attachments as $attachment_id) {
            // Get the file paths before deleting the attachment
            $file_data = get_post_meta($attachment_id, '_wp_attached_file', true);
            $metadata = get_post_meta($attachment_id, '_wp_attachment_metadata', true);
            
            // Delete the attachment (should remove the post and postmeta)
            wp_delete_attachment($attachment_id, true);
            
            // Extra safety: manually delete any potentially orphaned metadata
            $wpdb->delete(
                $wpdb->postmeta,
                [
                    'post_id' => $attachment_id,
                    'meta_key' => '_wp_attached_file'
                ]
            );
            
            $wpdb->delete(
                $wpdb->postmeta,
                [
                    'post_id' => $attachment_id,
                    'meta_key' => '_wp_attachment_metadata'
                ]
            );
        }
        
        // Final cleanup: search for any orphaned attachment metadata
        $wpdb->query("
            DELETE FROM {$wpdb->postmeta}
            WHERE meta_key IN ('_wp_attached_file', '_wp_attachment_metadata')
            AND post_id NOT IN (
                SELECT ID FROM {$wpdb->posts} WHERE post_type = 'attachment'
            )
        ");
    }

    /**
     * Remove all movie posts, revisions and associated meta
     */
    private function remove_post_type(): void {
        global $wpdb;

        // First, get all revisions associated with movie posts
        $movie_ids = get_posts([
            'post_type' => 'movie',
            'numberposts' => -1,
            'post_status' => 'any',
            'fields' => 'ids'
        ]);
        
        if (!empty($movie_ids)) {
            // Get all revisions for movie posts
            $placeholders = implode(',', array_fill(0, count($movie_ids), '%d'));
            $revisions = $wpdb->get_col($wpdb->prepare(
                "SELECT ID FROM {$wpdb->posts} 
                WHERE post_type = 'revision' 
                AND post_parent IN ($placeholders)",
                $movie_ids
            ));
            
            // Delete revision meta
            if (!empty($revisions)) {
                $rev_placeholders = implode(',', array_fill(0, count($revisions), '%d'));
                $wpdb->query($wpdb->prepare(
                    "DELETE FROM {$wpdb->postmeta} WHERE post_id IN ($rev_placeholders)",
                    $revisions
                ));
                
                // Delete revisions
                $wpdb->query($wpdb->prepare(
                    "DELETE FROM {$wpdb->posts} WHERE ID IN ($rev_placeholders)",
                    $revisions
                ));
            }
            
            // Remove post meta from movie posts
            $wpdb->query($wpdb->prepare(
                "DELETE FROM {$wpdb->postmeta} WHERE post_id IN ($placeholders)",
                $movie_ids
            ));
            
            // Remove movie posts
            $wpdb->query($wpdb->prepare(
                "DELETE FROM {$wpdb->posts} WHERE ID IN ($placeholders)",
                $movie_ids
            ));
            
            // Also get any remaining movie posts (in case the above missed any)
            $wpdb->query("DELETE FROM {$wpdb->posts} WHERE post_type = 'movie'");
            
            // Clean up any orphaned meta
            $wpdb->query("
                DELETE pm FROM {$wpdb->postmeta} pm
                LEFT JOIN {$wpdb->posts} p ON p.ID = pm.post_id
                WHERE p.ID IS NULL
            ");
        }
    }

    /**
     * Remove movie taxonomies and terms
     */
    private function remove_taxonomies(): void {
        global $wpdb;

        $taxonomies = ['movie_year'];

        foreach ($taxonomies as $taxonomy) {
            // Get all terms for this taxonomy
            $terms = get_terms([
                'taxonomy' => $taxonomy,
                'hide_empty' => false,
                'fields' => 'ids'
            ]);

            if (!is_wp_error($terms) && !empty($terms)) {
                // Remove term relationships
                $placeholders = implode(',', array_fill(0, count($terms), '%d'));
                $query = "DELETE FROM {$wpdb->term_relationships} WHERE term_taxonomy_id IN ($placeholders)";
                // Prepare SQL with variable number of placeholders
                $prepared = call_user_func_array([$wpdb, 'prepare'], array_merge([$query], $terms));
                // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared -- $prepared is already prepared above
                $wpdb->query($prepared);
            
                // Remove term taxonomy
                $query = "DELETE FROM {$wpdb->term_taxonomy} WHERE term_id IN ($placeholders)";
                // Prepare SQL with variable number of placeholders
                $prepared = call_user_func_array([$wpdb, 'prepare'], array_merge([$query], $terms));
                // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared -- $prepared is already prepared above
                $wpdb->query($prepared);
            
                // Remove terms
                $query = "DELETE FROM {$wpdb->terms} WHERE term_id IN ($placeholders)";
                // Prepare SQL with variable number of placeholders
                $prepared = call_user_func_array([$wpdb, 'prepare'], array_merge([$query], $terms));
                // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared -- $prepared is already prepared above
                $wpdb->query($prepared);
            }
        }
    }

    /**
     * Remove all plugin options
     */
    private function remove_options(): void {
        foreach (self::OPTIONS as $option) {
            delete_option($option);
        }
    }

    /**
     * Remove all plugin transients
     */
    private function remove_transients(): void {
        global $wpdb;
    
        // Remove known transients by prefix
        foreach (self::TRANSIENT_PREFIXES as $prefix) {
            $wpdb->query($wpdb->prepare(
                "DELETE FROM {$wpdb->options} 
                WHERE option_name LIKE %s OR option_name LIKE %s",
                "_transient_{$prefix}%",
                "_transient_timeout_{$prefix}%"
            ));
        }
    }

    /**
     * Clean up uploaded files and directories
     */
    private function cleanup_uploads(): void {
        // Get WordPress upload directory
        $upload_dir = wp_upload_dir();
        
        $directories = [
            $upload_dir['basedir'] . '/letterboxd-temp',
            $upload_dir['basedir'] . '/letterboxd-posters'
        ];
    
        // Remove each directory and its contents
        foreach ($directories as $dir) {
            if (is_dir($dir)) {
                $this->remove_directory($dir);
            }
        }
    }

    /**
     * Recursively remove a directory and its contents
     */
    private function remove_directory(string $dir): void {
        if (is_dir($dir)) {
            $objects = scandir($dir);
            
            // Initialize filesystem
            global $wp_filesystem;
            if (empty($wp_filesystem)) {
                require_once(ABSPATH . '/wp-admin/includes/file.php');
                WP_Filesystem();
            }
            
            foreach ($objects as $object) {
                if ($object !== '.' && $object !== '..') {
                    $path = $dir . '/' . $object;
                    if (is_dir($path)) {
                        $this->remove_directory($path);
                    } else {
                        $wp_filesystem->delete($path);
                    }
                }
            }
            $wp_filesystem->rmdir($dir);
        }
    }

    /**
     * Clear various WordPress caches
     */
    private function clear_caches(): void {
        // Clear object cache if external cache is used
        wp_cache_flush();
        
        // Clear rewrite rules
        delete_option('rewrite_rules');
        
        // Clear block cache
        if (function_exists('wp_cache_delete_multiple')) {
            wp_cache_delete_multiple(['letterboxd_block_patterns', 'letterboxd_block_cache']);
        }
    }
}

// Run the uninstaller
Letterboxd_Uninstaller::uninstall();

================
File: includes/class-movie-block-renderer.php
================
<?php
/**
 * Class to handle Movie Block registration and integration
 *
 * @package letterboxd-connect
 * @since 1.0.0
 */

declare(strict_types=1);

// Prevent direct access
if (!defined("ABSPATH")) {
    exit();
}

class Letterboxd_Movie_Block_Renderer {
    private function debug_log($message) {
        letterboxd_debug_log($message, "Movie_Block_Renderer");
    }

    /**
     * Block-related constants
     */
    private const BLOCK_NAME = "letterboxd-connect/movie-grid";
    private const CACHE_GROUP = "letterboxd_blocks";
    private const CACHE_DURATION = 3600; // 1 hour
    private const MOVIE_POSTER_SIZE = "movie-poster";

    /**
     * Default block attributes
     */
    private const DEFAULT_ATTRIBUTES = [
        "number" => [
            "type" => "number",
            "default" => 12,
        ],
        "orderby" => [
            "type" => "string",
            "default" => "watch_date",
        ],
        "order" => [
            "type" => "string",
            "default" => "DESC",
        ],
    ];

    /**
     * Initialize the block functionality
     */
    public function __construct() {
        $this->setup_hooks();
    }

    /**
     * Set up WordPress hooks
     */
    private function setup_hooks(): void {
        // Register custom image size
        add_action("after_setup_theme", [$this, "register_movie_poster_size"]);
        add_filter("image_size_names_choose", [
            $this,
            "add_movie_poster_to_image_sizes",
        ]);

        // Registration hooks
        add_action("init", [$this, "register_block"]);
        add_action("rest_api_init", [$this, "register_rest_route"]);

        // Asset handling
        if (is_admin()) {
            add_action("enqueue_block_editor_assets", [
                $this,
                "enqueue_editor_assets",
            ]);
        }
        add_action("enqueue_block_assets", [$this, "enqueue_block_assets"]);

        // Cache clearing
        add_action("save_post_movie", [$this, "clear_block_cache"]);
        add_action("deleted_post", [$this, "clear_block_cache"]);
        add_action("edited_movie_genre", [$this, "clear_taxonomy_cache"]);
        add_action("edited_movie_year", [$this, "clear_taxonomy_cache"]);
    }

    public function register_rest_route(): void {
        register_rest_route("letterboxd-connect/v1", "/render-movie-grid", [
            "methods" => "GET",
            "callback" => [$this, "render_block"],
            "permission_callback" => [$this, "check_block_permissions"],
            "args" => [
                "number" => [
                    "validate_callback" => function ($param) {
                        return is_numeric($param) &&
                            $param > 0 &&
                            $param <= 100;
                    },
                ],
                "orderby" => [
                    "validate_callback" => function ($param) {
                        return in_array($param, [
                            "title",
                            "watch_date",
                            "release_year",
                        ]);
                    },
                ],
                "order" => [
                    "validate_callback" => function ($param) {
                        return in_array(strtoupper($param), ["ASC", "DESC"]);
                    },
                ],
            ],
        ]);
    }

    public function check_block_permissions(): bool {
        return current_user_can("edit_posts");
    }

    /**
     * Register the movie grid block
     */
    public function register_block(): void {
        if (!function_exists("register_block_type")) {
            return;
        }

        register_block_type("letterboxd-connect/movie-grid", [
            "api_version" => 2,
            "editor_script" => "letterboxd-blocks",
            "editor_style" => "letterboxd-blocks-editor",
            "style" => "letterboxd-movie-grid",
            "render_callback" => [$this, "render_block"],
            "attributes" => [
                "number" => [
                    "type" => "number",
                    "default" => 12,
                ],
                "showAll" => [
                    "type" => "boolean",
                    "default" => false,
                ],
                "perPage" => [
                    "type" => "number",
                    "default" => 12,
                ],
                "orderby" => [
                    "type" => "string",
                    "default" => "watch_date",
                ],
                "order" => [
                    "type" => "string",
                    "default" => "DESC",
                ],
                "columns" => [
                    "type" => "number",
                    "default" => 3,
                ],
                "displayMode" => [
                    "type" => "string",
                    "default" => "cards",
                ],
                // Display options
                "showDirector" => [
                    "type" => "boolean",
                    "default" => true,
                ],
                "showRating" => [
                    "type" => "boolean",
                    "default" => true,
                ],
                "showStreamingLink" => [
                    "type" => "boolean",
                    "default" => true,
                ],
                "showExternalLinks" => [
                    "type" => "boolean",
                    "default" => true,
                ],
            ],
        ]);
    }

    /**
     * Enqueue editor-specific assets
     */
    public function enqueue_editor_assets(): void {
        // Enqueue block script with dependencies
        wp_enqueue_script(
            "letterboxd-movie-block",
            plugins_url("js/movie-block.js", LETTERBOXD_PLUGIN_FILE),
            [
                "wp-blocks",
                "wp-element",
                "wp-editor",
                "wp-components",
                "wp-i18n",
                "wp-block-editor",
                "wp-server-side-render", // Added this dependency to match block.js
            ],
            LETTERBOXD_VERSION,
            true
        );

        // Add dynamic data for the editor
        wp_localize_script(
            "letterboxd-movie-block",
            "letterboxdMovieBlock",
            $this->get_editor_data()
        );

        // Enqueue editor styles
        wp_enqueue_style(
            "letterboxd-movie-block-editor",
            plugins_url("css/movie-block-editor.css", LETTERBOXD_PLUGIN_FILE),
            [],
            LETTERBOXD_VERSION
        );
    }

    /**
     * Get cached editor data
     */
    private function get_editor_data(): array {
        $cache_key = "editor_data";
        $data = wp_cache_get($cache_key, self::CACHE_GROUP);

        if ($data === false) {
            $data = [
                "pluginUrl" => plugins_url("", LETTERBOXD_PLUGIN_FILE),
            ];
            wp_cache_set(
                $cache_key,
                $data,
                self::CACHE_GROUP,
                self::CACHE_DURATION
            );
        }

        return $data;
    }

    /**
     * Enqueue block assets for both editor and front-end
     */
    public function enqueue_block_assets(): void {
        if (has_block(self::BLOCK_NAME)) {
            wp_enqueue_style(
                "letterboxd-movie-grid",
                plugins_url("css/movie-grid.css", LETTERBOXD_PLUGIN_FILE),
                ["wp-components"],
                LETTERBOXD_VERSION
            );
        }
    }

    /**
     * Render the movie grid block
     */
    public function render_block(array $attributes): string {
        // Determine context to differentiate editor preview from front-end
        $is_rest = defined("REST_REQUEST") && REST_REQUEST;
        $context = $is_rest ? "edit" : "front";
    
        // Get current page if we're showing all with pagination
        $paged = 1;
        if ($attributes["showAll"] ?? false) {
            $paged = get_query_var("paged") ? get_query_var("paged") : 1;
        }
    
        $cache_key = "block_" . md5(serialize($attributes)) . "_" . $context . "_page_" . $paged;
        $output = wp_cache_get($cache_key, self::CACHE_GROUP);
    
        if ($output === false) {
            $query = $this->get_movies_query($attributes, $context, $paged);
    
            // Get attributes with defaults
            $columns = isset($attributes["columns"]) ? intval($attributes["columns"]) : 3;
            $display_mode = isset($attributes["displayMode"]) ? sanitize_text_field($attributes["displayMode"]) : "cards";
            $show_all = isset($attributes["showAll"]) ? (bool) $attributes["showAll"] : false;
    
            // Add display options to render attributes
            $render_options = [
                "layout" => $display_mode === "list" ? "list" : "grid",
                "columns" => $columns,
                "showDirector" => $attributes["showDirector"] ?? true,
                "showRating" => $attributes["showRating"] ?? true,
                "showStreamingLink" => $attributes["showStreamingLink"] ?? true,
                "showExternalLinks" => $attributes["showExternalLinks"] ?? true,
                "showPagination" => $show_all,
            ];
    
            // Use the unified render_movie_collection method with display options
            $grid = $this->render_movie_collection($query, $render_options);
    
            // Handle pagination display based on context
            $pagination = "";
            if ($show_all) {
                if ($is_rest) {
                    $pagination = '<div class="pagination-note">' . 
                        __("Pagination will appear on the front end", "letterboxd-connect") . 
                        "</div>";
                } else {
                    $pagination = $this->render_pagination($query);
                }
            }
    
            // Create container with appropriate class based on context
            $container_class = $context === "edit" ? "editor-preview" : "wp-block-letterboxd-connect-movie-grid";
            
            $output = sprintf(
                '<div class="%s" data-columns="%d" data-display-mode="%s">%s%s</div>',
                esc_attr($container_class),
                $columns,
                esc_attr($display_mode),
                $grid,
                $pagination
            );
    
            // Cache editor content for less time than front-end content
            $cache_duration = $context === "edit" ? 300 : self::CACHE_DURATION;
            wp_cache_set($cache_key, $output, self::CACHE_GROUP, $cache_duration);
        }
    
        return $output;
    }

    /**
     * Get movies query based on block attributes
     *
     * @param array $attributes Block attributes from the editor
     * @return WP_Query Query object with movies
     */
    private function get_movies_query(
        array $attributes,
        string $context = "front",
        int $paged = 1
    ): WP_Query {
        // Skip cache for admin/editing context when debugging
        $use_cache = !($context === "edit" && defined("WP_DEBUG") && WP_DEBUG);
        $cache_key =
            "movie_query_" .
            md5(serialize($attributes)) .
            "_" .
            $context .
            "_page_" .
            $paged;
        if ($use_cache) {
            $cached_query = wp_cache_get($cache_key, self::CACHE_GROUP);
            if ($cached_query !== false) {
                return $cached_query;
            }
        }

        $show_all = isset($attributes["showAll"])
            ? (bool) $attributes["showAll"]
            : false;
        $per_page = isset($attributes["perPage"])
            ? intval($attributes["perPage"])
            : 12;

        // Base query arguments
        $args = [
            "post_type" => "movie",
            "order" =>
                $attributes["order"] ??
                self::DEFAULT_ATTRIBUTES["order"]["default"],

            // Set posts_per_page based on showAll setting
            "posts_per_page" => $show_all
                ? $per_page
                : $attributes["number"] ??
                    self::DEFAULT_ATTRIBUTES["number"]["default"],

            // Add pagination if showing all
            "paged" => $show_all ? $paged : 1,

            // Performance optimization flags - disable if showing all
            "no_found_rows" => !$show_all,
            "update_post_term_cache" => true,
            "update_post_meta_cache" => true,
        ];

        // Define filter callback variables for later removal
        $orderby_filter = null;
        $join_filter = null;

        // Handle different ordering options
        switch (
            $attributes["orderby"] ??
            self::DEFAULT_ATTRIBUTES["orderby"]["default"]
        ) {
            case "title":
                $args["orderby"] = "title";
                break;

            case "release_year":
                // Join with terms table and order by term name
                $args["tax_query"] = [
                    [
                        "taxonomy" => "movie_year",
                        "operator" => "EXISTS",
                    ],
                ];
                $args["orderby"] = "terms";
                $args["order"] = $attributes["order"];

                // Define filter callbacks and assign them to variables
                $orderby_filter = function ($orderby, $query) use ($args) {
                    global $wpdb;
                    return "{$wpdb->terms}.name " . $args["order"];
                };
                $join_filter = function ($join, $query) {
                    global $wpdb;
                    $join .= " LEFT JOIN {$wpdb->term_relationships} tr ON {$wpdb->posts}.ID = tr.object_id";
                    $join .= " LEFT JOIN {$wpdb->term_taxonomy} tt ON tr.term_taxonomy_id = tt.term_taxonomy_id AND tt.taxonomy = 'movie_year'";
                    $join .= " LEFT JOIN {$wpdb->terms} ON tt.term_id = {$wpdb->terms}.term_id";
                    return $join;
                };

                add_filter("posts_orderby", $orderby_filter, 10, 2);
                add_filter("posts_join", $join_filter, 10, 2);
                break;

            case "watch_date":
            default:
                $args["meta_key"] = "watch_date";
                $args["orderby"] = "meta_value";
        }

        // Create the query
        $query = new WP_Query($args);

        // Remove the filters if they were added
        if (($attributes["orderby"] ?? "") === "release_year") {
            if ($orderby_filter !== null) {
                remove_filter("posts_orderby", $orderby_filter, 10);
            }
            if ($join_filter !== null) {
                remove_filter("posts_join", $join_filter, 10);
            }
        }

        // Cache the query
        wp_cache_set(
            $cache_key,
            $query,
            self::CACHE_GROUP,
            self::CACHE_DURATION
        );

        return $query;
    }

    /**
     * Render pagination for movie grid
     *
     * @param WP_Query $query The WordPress query object
     * @return string HTML pagination markup
     */
    private function render_pagination(WP_Query $query): string {
        if (!$query->max_num_pages || $query->max_num_pages <= 1) {
            return "";
        }

        $big = 999999999; // Need an unlikely integer
        $pages = paginate_links([
            "base" => str_replace(
                (string) $big,
                "%#%",
                esc_url(get_pagenum_link($big))
            ),
            "format" => "?paged=%#%",
            "current" => max(1, get_query_var("paged")),
            "total" => $query->max_num_pages,
            "type" => "array",
            "prev_text" => __("&laquo; Previous", "letterboxd-connect"),
            "next_text" => __("Next &raquo;", "letterboxd-connect"),
        ]);

        if (is_array($pages)) {
            $pagination =
                '<nav class="movie-grid-pagination" aria-label="' .
                __("Movies navigation", "letterboxd-connect") .
                '">';
            $pagination .= '<ul class="page-numbers">';

            foreach ($pages as $page) {
                $pagination .= "<li>" . $page . "</li>";
            }

            $pagination .= "</ul>";
            $pagination .= "</nav>";

            return $pagination;
        }

        return "";
    }

    /**
     * Render a collection of movies in either grid or list format
     *
     * @param WP_Query $query      The WordPress query with movie posts
     * @param array    $attributes Display attributes (layout, columns, etc.)
     * @return string              The rendered HTML
     */
    private function render_movie_collection(
        WP_Query $query,
        array $attributes
    ): string {
        ob_start();

        // Layout type (grid or list)
        $layout = isset($attributes["layout"]) ? $attributes["layout"] : "grid";

        if ($query->have_posts()) {
            // Container class based on layout
            $container_class = $layout === "list" ? "movie-list" : "movie-grid";

            // Add columns attribute for grid layout
            if ($layout === "grid") {
                $columns = isset($attributes["columns"])
                    ? intval($attributes["columns"])
                    : 3;
                printf(
                    '<div class="%s columns-%s">',
                    esc_attr($container_class),
                    esc_attr($columns)
                );
            } else {
                printf('<div class="%s">', esc_attr($container_class));
            }

            // Extract display options
            $display_options = [
                "showDirector" => $attributes["showDirector"] ?? true,
                "showRating" => $attributes["showRating"] ?? true,
                "showStreamingLink" => $attributes["showStreamingLink"] ?? true,
                "showExternalLinks" => $attributes["showExternalLinks"] ?? true,
            ];

            // Render each movie item
            while ($query->have_posts()) {
                $query->the_post();
                $this->render_movie_item(
                    get_the_ID(),
                    $layout,
                    $display_options
                );
            }

            echo "</div>";
        } else {
            echo '<p class="no-movies">' .
                esc_html__("No movies found.", "letterboxd-connect") .
                "</p>";
        }

        wp_reset_postdata();
        return ob_get_clean();
    }

    /**
     * Returns the movie poster HTML
     *
     * @param int $post_id The post ID
     * @param string $size The image size
     * @param string $title The movie title
     * @return string The poster HTML
     */
    private function get_movie_poster(
        int $post_id,
        string $size = "movie-poster"
    ): string {
        if (!has_post_thumbnail($post_id)) {
            // Return placeholder if no thumbnail
            return '<div class="movie-poster movie-poster-placeholder"></div>';
        }

        $title = get_the_title($post_id);
        return sprintf(
            '<div class="movie-poster">%s</div>',
            get_the_post_thumbnail($post_id, $size, [
                "alt" => sprintf(
                    /* translators: %s: Movie title */
                    __("Movie poster for %s", "letterboxd-connect"),
                    esc_attr($title)
                ),
            ])
        );
    }

    /**
     * Get movie title HTML
     */
    private function get_movie_title(int $post_id): string {
        return sprintf(
            '<h3 class="movie-title">%s</h3>',
            esc_html(get_the_title($post_id))
        );
    }
    
    /**
     * Generate HTML for all movie links (streaming, IMDb, Rotten Tomatoes)
     *
     * @param array $display_options Display options including which links to show
     * @param array $meta_data Movie metadata including IDs and URLs
     * @param int $post_id Post ID
     * @param bool $is_list_view Whether being displayed in list view
     * @return string HTML for all links wrapped in div
     */
    private function get_movie_links(
        array $display_options,
        array $meta_data,
        int $post_id,
        bool $is_list_view = false
    ): string {
        $links = [];
        $title = get_the_title($post_id);
        
        // Add streaming link if available and option is enabled
        if (
            $display_options["showStreamingLink"] &&
            !empty($meta_data["streaming_link"])
        ) {
            $links[] = sprintf(
                '<a href="%s" target="_blank" rel="noopener noreferrer" class="external-link watch-link">Watch</a>',
                esc_url($meta_data["streaming_link"])
            );
        }
        
        // Add external links if option is enabled
        if ($display_options["showExternalLinks"]) {
            // Create IMDb link if ID exists
            if (!empty($meta_data["imdb_id"])) {
                $imdb_url = "https://www.imdb.com/title/{$meta_data["imdb_id"]}/";
                $links[] = sprintf(
                    '<a href="%s" target="_blank" class="external-link imdb-link" title="View on IMDb">IMDb</a>',
                    esc_url($imdb_url)
                );
            }
            
            // Create Rotten Tomatoes link if we have a title and year
            if (!empty($title) && !empty($meta_data["year"])) {
                $rt_search_query = urlencode(trim($title) . " " . trim($meta_data["year"]));
                $rt_url = "https://www.rottentomatoes.com/search?search={$rt_search_query}";
                $links[] = sprintf(
                    '<a href="%s" target="_blank" class="external-link rt-link" title="Search on Rotten Tomatoes">RT</a>',
                    esc_url($rt_url)
                );
            }
        }
        
        // Return empty string if no links, otherwise wrap links in div
        if (empty($links)) {
            return "";
        }
        
        return sprintf(
            '<div class="movie-links">%s</div>',
            implode(' ', $links)
        );
    }

    /**
     * Render an individual movie item (card or list item)
     *
     * @param int    $post_id The movie post ID
     * @param string $layout  The layout type ('grid' or 'list')
     */
    private function render_movie_item(
        int $post_id,
        string $layout = "grid",
        array $display_options = []
    ): void {
        // Set default display options if not provided
        $display_options = wp_parse_args($display_options, [
            "showDirector" => true,
            "showRating" => true,
            "showStreamingLink" => true,
            "showExternalLinks" => true,
        ]);

        // Get all needed meta data once
        $meta_data = [
            "director" => get_post_meta($post_id, "director", true),
            "watch_date" => get_post_meta($post_id, "watch_date", true),
            "rating" => get_post_meta($post_id, "movie_rating", true),
            "imdb_id" => get_post_meta($post_id, "imdb_id", true),
            "year" => $this->get_movie_year($post_id),
            "streaming_link" => get_post_meta($post_id, "streaming_link", true),
        ];

        // Format watch date if available
        $date_watched_html = "";
        if (!empty($meta_data["watch_date"])) {
            $formatted_date = date_i18n(
                get_option("date_format"),
                strtotime($meta_data["watch_date"])
            );
            $date_watched_html = sprintf(
                '<p class="watch-date">%s</p>',
                esc_html($formatted_date)
            );
        }

        // Format rating if available and option is enabled
        $rating_html = "";
        if ($display_options["showRating"] && !empty($meta_data["rating"])) {
            $rating_html = sprintf(
                '<p class="movie-rating">%s</p>',
                esc_html($meta_data["rating"])
            );
        }

        // Format director if available and option is enabled
        $director_html = "";
        if (
            $display_options["showDirector"] &&
            !empty($meta_data["director"])
        ) {
            $director_html = sprintf(
                '<p class="movie-director">%s</p>',
                esc_html($meta_data["director"])
            );
        }
        
        // Get all movie links using the new combined function
        $movie_links = $this->get_movie_links(
            $display_options,
            $meta_data,
            $post_id
        );
        
        // Set the appropriate CSS class based on layout
        $layout_class = ($layout === "grid") ? "movie-card" : "movie-list-item";
        
        // Render using a single template with dynamic class
        printf(
            '<div class="%1$s movie-item">
                %2$s
                <div class="movie-details">
                    %3$s
                    <div class="movie-meta">
                        %4$s
                        %5$s
                        %6$s
                    </div>
                    %7$s
                </div>
            </div>',
            esc_attr($layout_class),
            wp_kses_post($this->get_movie_poster($post_id, "movie-poster")),
            wp_kses_post($this->get_movie_title($post_id)),
            wp_kses_post($date_watched_html),
            wp_kses_post($director_html),
            wp_kses_post($rating_html),
            wp_kses_post($movie_links)
        );
    }

    /**
     * Register custom movie poster image size
     */
    public function register_movie_poster_size(): void {
        // Register a 2:3 aspect ratio image size (600px width  900px height)
        add_image_size(self::MOVIE_POSTER_SIZE, 600, 900, true);
    }

    /**
     * Add custom movie poster size to admin UI
     */
    public function add_movie_poster_to_image_sizes(array $sizes): array {
        return array_merge($sizes, [
            self::MOVIE_POSTER_SIZE => __(
                "Movie Poster (2:3)",
                "letterboxd-connect"
            ),
        ]);
    }

    /**
     * Get movie year from taxonomy
     */
    private function get_movie_year(int $post_id): string {
        $terms = wp_get_object_terms($post_id, "movie_year");
        if (!empty($terms) && !is_wp_error($terms)) {
            return $terms[0]->name;
        }
        return "";
    }

    /**
     * Clear block cache when a movie post is updated
     *
     * @param int $post_id Post ID that was changed
     */
    public function clear_block_cache($post_id = 0): void {
        // Always clear editor data
        wp_cache_delete("editor_data", self::CACHE_GROUP);

        // If a specific post was updated, try to clear only related caches
        if ($post_id > 0 && get_post_type($post_id) === "movie") {
            // Clear any cache with this post ID in the key
            $this->delete_block_cache_pattern("*" . $post_id . "*");

            // For broader changes, also clear recent pages
            $this->delete_block_cache_pattern("*_page_1*");
        } else {
            // If we can't determine what changed, clear all block caches
            $this->delete_block_cache_pattern();
        }
    }

    /**
     * Clear taxonomy cache when a taxonomy term is edited
     */
    public function clear_taxonomy_cache(): void {
        // Clear editor data
        wp_cache_delete("editor_data", self::CACHE_GROUP);

        // Clear first page caches which are most likely to show the change
        $this->delete_block_cache_pattern("*_page_1*");
    }

    /**
     * Delete block cache entries by pattern
     *
     * @param string $pattern Cache key pattern to match
     */
    private function delete_block_cache_pattern(
        string $pattern = "block_*"
    ): void {
        if (wp_using_ext_object_cache()) {
            wp_cache_flush();
        } else {
            global $wpdb;
            $wpdb->query(
                $wpdb->prepare(
                    "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s",
                    "_transient_" . self::CACHE_GROUP . "_" . $pattern
                )
            );
        }
    }
}

================
File: includes/class-auto-import.php
================
<?php
/**
 * Class for handling automated imports from Letterboxd
 *
 * @package letterboxd-connect
 * @since 1.0.0
 */

// Prevent direct access
if (!defined("ABSPATH")) {
    exit();
}

class Letterboxd_Auto_Import {
    private function debug_log($message) {
        letterboxd_debug_log($message, "Auto_Import");
    }

    /**
     * Plugin settings and constants
     */
    private const OPTION_NAME = "letterboxd_auto_import_options";
    private const LOG_LIMIT = 50;
    private const HOOK_NAME = "letterboxd_check_and_import";
    private const CACHE_GROUP = "letterboxd_auto_import";
    private const CACHE_DURATION = 3600; // 1 hour
    private const IMPORT_LOCK_DURATION = 300; // 5 minutes

    /**
     * Available schedule intervals
     */
    private const SCHEDULES = [
        "disabled" => "Disabled",
        "hourly" => [
            "interval" => 3600,
            "display" => "Once Hourly"
        ],
        "twicedaily" => [
            "interval" => 43200,
            "display" => "Twice Daily"
        ],
        "daily" => [
            "interval" => 86400,
            "display" => "Once Daily"
        ],
        "weekly" => [
            "interval" => 604800,
            "display" => "Once Weekly"
        ]
    ];

    /**
     * Instance of the main plugin class
     *
     * @var Letterboxd_To_WordPress
     */
    private Letterboxd_To_WordPress $main_plugin;

    /**
     * Cached plugin options
     *
     * @var array
     */
    private array $cached_options;

    /**
     * Initialize the class with better option handling
     *
     * @param Letterboxd_To_WordPress $main_plugin Main plugin instance
     */
    public function __construct(Letterboxd_To_WordPress $main_plugin) {
        $this->main_plugin = $main_plugin;

        // Only register hooks ONCE
        static $hooks_registered = false;

        if (!$hooks_registered) {
            $this->setup_hooks();
            $hooks_registered = true;
        }

        // Only load options when needed based on current context
        $is_settings_page =
            is_admin() &&
            isset($_GET["page"]) &&
            $_GET["page"] === "letterboxd-connect";
        $is_cron_run = defined("DOING_CRON") && DOING_CRON;
        $is_rest_request = defined("REST_REQUEST") && REST_REQUEST;

        // Only load options when needed (settings page, cron, or REST API call)
        if ($is_settings_page || $is_cron_run || $is_rest_request) {
            $this->load_options();
        } else {
            // Otherwise just set defaults without DB query
            $this->cached_options = [
                "frequency" => "daily",
                "notifications" => false
            ];
        }
    }

    /**
     * Set up WordPress hooks and filters
     */
    private function setup_hooks(): void {
        // Add custom cron schedules - needed everywhere
        add_filter("cron_schedules", [$this, "add_custom_cron_intervals"]);

        // Import action - needed for functionality
        add_action(self::HOOK_NAME, [$this, "letterboxd_check_and_import"]);

        // Schedule transient cleanup - add this line
        $this->schedule_transient_cleanup();

        // Only add admin-specific hooks when in admin
        if (is_admin()) {
            // Check if we're on our settings page
            $is_settings_page =
                isset($_GET["page"]) &&
                $_GET["page"] === "letterboxd-connect";

            // Only register these hooks on our settings page
            if ($is_settings_page) {
                add_action("admin_init", [
                    $this,
                    "register_auto_import_settings"
                ]);
                add_action("admin_notices", [$this, "display_import_notices"]);
            }

            // This hook is needed for initialization
            add_action("letterboxd_auto_import_options", [
                $this,
                "initialize_schedule"
            ]);
        }
    }

    /**
     * Load and cache plugin options with defaults
     *
     * @param bool $force Force reload from database
     */
    private function load_options(bool $force = false): void {
        // Use static caching to prevent multiple DB queries in same request
        static $options_loaded = false;
        static $cached_options_static = null;

        if (!$force && $options_loaded && $cached_options_static !== null) {
            $this->cached_options = $cached_options_static;
            return;
        }

        $defaults = [
            "frequency" => "daily",
            "notifications" => false
        ];

        $saved_options = get_option("letterboxd_auto_import_options", []);
        //letterboxd_debug_log('Loading auto import options from DB: ' . print_r($saved_options, true));

        $this->cached_options = wp_parse_args($saved_options, $defaults);

        // Save to static cache
        $cached_options_static = $this->cached_options;
        $options_loaded = true;
    }

    /**
     * Add custom cron schedules
     *
     * @param array $schedules Existing cron schedules
     * @return array Modified cron schedules
     */
    public function add_custom_cron_intervals(array $schedules): array {
        foreach (self::SCHEDULES as $name => $config) {
            if ($name !== "disabled" && !isset($schedules[$name])) {
                $schedules[$name] = $config;
            }
        }
        return $schedules;
    }

    /**
     * Register auto-import settings
     */
    public function register_auto_import_settings(): void {
        if (!current_user_can("manage_options")) {
            return;
        }

        add_settings_section(
            "letterboxd_auto_import_section",
            __("Auto-Import Settings", "letterboxd-connect"),
            [$this, "render_settings_section"],
            "letterboxd-connect"
        );

        $this->register_settings_fields();
        
        function letterboxd_sanitize_options($input) {
            $sanitized = [];
            
            // Basic array structure validation
            if (!is_array($input)) {
                return [];
            }
            
            // Sanitize enabled setting (boolean)
            if (isset($input['enabled'])) {
                $sanitized['enabled'] = (bool) $input['enabled'];
            }
            
            // Sanitize frequency (string)
            if (isset($input['frequency'])) {
                $sanitized['frequency'] = sanitize_text_field($input['frequency']);
            }
            
            // Sanitize email notification (boolean)
            if (isset($input['email_notification'])) {
                $sanitized['email_notification'] = (bool) $input['email_notification'];
            }
            
            // Sanitize start date (string)
            if (isset($input['start_date'])) {
                $sanitized['start_date'] = sanitize_text_field($input['start_date']);
            }
            
            // Sanitize username (string)
            if (isset($input['username'])) {
                $sanitized['username'] = sanitize_text_field($input['username']);
            }
            
            // Sanitize TMDB API key (string)
            if (isset($input['tmdb_api_key'])) {
                $sanitized['tmdb_api_key'] = sanitize_text_field($input['tmdb_api_key']);
            }
            
            return $sanitized;
        }
        
        // Register settings
        add_filter('sanitize_option_letterboxd_auto_import_options', 'letterboxd_sanitize_options');
        
        // And modify your register_setting:
        register_setting(
            "letterboxd_wordpress_options",
            "letterboxd_auto_import_options",
            array(
                "type" => "object",
                "show_in_rest" => false,
                "default" => array()
            )
        );
    }

    /**
     * Register individual settings fields
     */
    private function register_settings_fields(): void {
        $fields = [
            "frequency" => [
                "title" => __("Check for New Movies", "letterboxd-connect"),
                "callback" => "render_frequency_field"
            ],
            "notifications" => [
                "title" => __("Email Notifications", "letterboxd-connect"),
                "callback" => "render_notifications_field"
            ],
            "status" => [
                "title" => __("Import Status", "letterboxd-connect"),
                "callback" => "render_status_field"
            ]
        ];

        foreach ($fields as $id => $field) {
            add_settings_field(
                "letterboxd_auto_import_{$id}",
                $field["title"],
                [$this, $field["callback"]],
                "letterboxd-connect",
                "letterboxd_auto_import_section"
            );
        }
    }

    /**
     * Render settings section description
     */
    public function render_settings_section(): void {
        echo "<p>" .
            esc_html__(
                "Configure how often the plugin should check for new movies in your Letterboxd feed.",
                "letterboxd-connect"
            ) .
            "</p>";
    }

    /**
     * Render frequency field
     */
    public function render_frequency_field(): void {
        $current = $this->cached_options["frequency"] ?? "daily"; // Add default

        echo '<select name="letterboxd_auto_import_options[frequency]">'; // Update name attribute
        foreach (self::SCHEDULES as $value => $config) {
            printf(
                '<option value="%s" %s>%s</option>',
                esc_attr($value),
                selected($current, $value, false),
                esc_html($config["display"] ?? $config)
            );
        }
        echo "</select>";
    }

    /**
     * Render notifications field
     */
    public function render_notifications_field(): void {
        printf(
            '<input type="checkbox" name="letterboxd_auto_import_options[notifications]" %s value="1">
            <span class="description">%s</span>',
            checked($this->cached_options["notifications"], true, false),
            esc_html__(
                "Send email notifications when new movies are imported",
                "letterboxd-connect"
            )
        );
    }

    /**
     * Render import status field
     */
    public function render_status_field(): void {
        // Check if the cron has run at least once
        $last_check = get_option("letterboxd_last_check");
        if (!$last_check) {
            echo "<p>" .
                esc_html__(
                    "The import will run for the first time after the settings are configured.",
                    "letterboxd-connect"
                ) .
                "</p>";
            return;
        }

        $current_time = time();

        // Define the statuses you want to display
        $statuses = [
            "Last checked" => "letterboxd_last_check",
            "Last import" => "letterboxd_last_import"
        ];

        echo '<div class="letterboxd-status-wrap">';

        // Loop over the statuses and render each if available
        foreach ($statuses as $label => $option) {
            $timestamp = get_option($option);
            if ($timestamp) {
                printf(
                    '<p class="time-wrap"><span class="status-label">%s:</span> <span class="status-time">%s</span></p>',
                    esc_html($label),
                    esc_html(
                        sprintf(
                            /* translators: %s: Human-readable time difference */
                            __('%s ago', 'letterboxd-connect'),
                            human_time_diff($timestamp, $current_time)
                        )
                    )
                );
            }
        }

        // Render the next check scheduled time, if available
        $next_check = wp_next_scheduled(self::HOOK_NAME);
        if ($next_check) {
            printf(
                '<p class="time-wrap"><span class="status-label">%s:</span> <span class="status-time">%s</span></p>',
                esc_html__("Next check scheduled", "letterboxd-connect"),
                esc_html(
                    human_time_diff($current_time, $next_check) .
                        " " .
                        __("from now", "letterboxd-connect")
                )
            );
        }

        echo "</div>";
    }

    /**
     * Initialize or reset schedule based on settings
     */
    public function initialize_schedule(): void {
        // Clear existing schedule
        wp_clear_scheduled_hook(self::HOOK_NAME);

        $frequency = $this->cached_options["frequency"];
        if ($frequency !== "disabled" && isset(self::SCHEDULES[$frequency])) {
            $last_check = get_option("letterboxd_last_check");
            $interval = self::SCHEDULES[$frequency]["interval"];

            // Calculate next check time based on last check plus interval
            $next_check = $last_check ? $last_check + $interval : time();

            wp_schedule_event($next_check, $frequency, self::HOOK_NAME);
        }

        $this->load_options();
    }

    /**
     * Update import schedule with improved error handling
     */
    public function update_import_schedule(string $interval): bool {
        letterboxd_debug_log(
            "update_import_schedule called with interval: " . $interval
        );

        // Validate the interval
        $valid_intervals = array_keys(self::SCHEDULES);
        if (!in_array($interval, $valid_intervals)) {
            letterboxd_debug_log("Invalid interval: " . $interval);
            return false;
        }

        // Clear the existing schedule
        $hook_name = self::HOOK_NAME;
        if (wp_next_scheduled($hook_name)) {
            letterboxd_debug_log(
                "Clearing existing schedule for " . $hook_name
            );
            wp_clear_scheduled_hook($hook_name);
        }

        if (!empty($interval) && $interval !== "disabled") {
            letterboxd_debug_log(
                "Setting up new schedule with interval: " . $interval
            );

            // Update the cached options first
            $this->cached_options["frequency"] = $interval;

            // Calculate a future time based on the interval
            $schedules = wp_get_schedules();
            $interval_seconds = $schedules[$interval]["interval"] ?? 86400; // Default to daily
            $timestamp = time() + $interval_seconds; // Schedule for the next interval

            // Schedule the event
            $schedule_result = wp_schedule_event(
                $timestamp,
                $interval,
                $hook_name
            );
            letterboxd_debug_log(
                "wp_schedule_event result: " .
                    ($schedule_result !== false ? "Success" : "Failed")
            );

            // Only update options if scheduling was successful
            if ($schedule_result !== false) {
                // Update the auto import options
                update_option(
                    "letterboxd_auto_import_options",
                    $this->cached_options
                );

                // Update the import interval for compatibility
                update_option("letterboxd_import_interval", $interval);

                return true;
            }
        }

        return false;
    }

    /**
     * Check feed and import new movies
     */
    public function letterboxd_check_and_import(): void {
        // Check if this is being called right after settings update
        if (get_transient("letterboxd_settings_just_updated")) {
            letterboxd_debug_log(
                "Skipping auto-import because settings were just updated"
            );
            delete_transient("letterboxd_settings_just_updated");
            return;
        }

        $lock_key = self::CACHE_GROUP . "_import_lock";

        // Check if another import is running
        if (get_transient($lock_key)) {
            letterboxd_debug_log(
                "Skipping import - another process is running"
            );
            return;
        }

        // Set lock to prevent parallel imports
        set_transient($lock_key, true, self::IMPORT_LOCK_DURATION);

        try {
            letterboxd_debug_log("Starting scheduled import");
            $this->update_last_check();
            $importer = $this->main_plugin->importer;
            $settings = get_option("letterboxd_wordpress_options", []);
            $result = $importer->import_movies($settings, true);

            if ($result && $result["imported"] > 0) {
                $this->handle_successful_import($result);
            }
            $this->log_import_result($result);
        } catch (Exception $e) {
            $this->handle_import_error($e);
        } finally {
            // Always clear the transient lock after processing
            delete_transient($lock_key);
            letterboxd_debug_log("Import completed and lock cleared");
        }
    }

    /**
     * Check if import should run (prevents parallel imports)
     */
    private function should_run_import(): bool {
        $lock_key = self::CACHE_GROUP . "_import_lock";
        if (get_transient($lock_key)) {
            return false;
        }
        set_transient($lock_key, true, self::IMPORT_LOCK_DURATION);
        return true;
    }

    /**
     * Update last check timestamp
     */
    private function update_last_check(): void {
        $now = time();
        update_option("letterboxd_last_check", $now);
        wp_cache_set(
            "last_check",
            $now,
            self::CACHE_GROUP,
            self::CACHE_DURATION
        );
    }

    /**
     * Handle successful import
     */
    private function handle_successful_import(array $result): void {
        $now = time();
        update_option("letterboxd_last_import", $now);
        update_option("letterboxd_last_import_date", current_time("mysql"));

        wp_cache_set(
            "last_import",
            $now,
            self::CACHE_GROUP,
            self::CACHE_DURATION
        );

        if ($this->cached_options["notifications"]) {
            $this->send_notification($result);
        }
    }

    /**
     * Handle import error
     */
    private function handle_import_error(Exception $e): void {
        $result = [
            "imported" => 0,
            "status" => "error",
            "message" => $e->getMessage()
        ];

        $this->log_import_result($result);
        letterboxd_debug_log(
            sprintf(
                "Letterboxd import error: %s in %s:%d",
                $e->getMessage(),
                $e->getFile(),
                $e->getLine()
            )
        );

        // Clear the lock and clean up any stale transients
        delete_transient(self::CACHE_GROUP . "_import_lock");
        $this->cleanup_stale_transients();
    }

    /**
     * Send notification email
     */
    private function send_notification(array $result): void {
        $site_name = get_bloginfo("name");
        $admin_email = get_option("admin_email");
    
        // translators: %s: Website name
        $subject = sprintf(
            "[%s] %s",
            $site_name,
            // translators: This is the email subject for new movie imports
            __("New movies imported from Letterboxd", "letterboxd-connect")
        );
        
        // translators: %d is the number of imported movies
        $message = sprintf(
            // translators: %d is the number of imported movies
            __(
                "The Letterboxd importer has just imported %d new movie(s) to your website.",
                "letterboxd-connect"
            ),
            $result["imported"]
        );
    
        wp_mail($admin_email, $subject, $message);
    }

    /**
     * Log import results
     */
    private function log_import_result(array $result): void {
        $log = get_option("letterboxd_import_log", []);

        array_unshift($log, [
            "timestamp" => current_time("mysql"),
            "imported" => $result["imported"],
            "status" => $result["status"],
            "message" => $result["message"]
        ]);

        $log = array_slice($log, 0, self::LOG_LIMIT);
        update_option("letterboxd_import_log", $log);
        wp_cache_set(
            "import_log",
            $log,
            self::CACHE_GROUP,
            self::CACHE_DURATION
        );
    }

    /**
     * Display admin notices for import status
     */
    public function display_import_notices(): void {
        if (!$this->should_display_notices()) {
            return;
        }

        $log =
            wp_cache_get("import_log", self::CACHE_GROUP) ?:
            get_option("letterboxd_import_log", []);

        if (!empty($log) && $log[0]["status"] === "error") {
            printf(
                '<div class="notice notice-error is-dismissible"><p>%s: %s</p></div>',
                esc_html__(
                    "Last import attempt failed",
                    "letterboxd-connect"
                ),
                esc_html($log[0]["message"])
            );
        }
    }

    /**
     * Check if notices should be displayed
     */
    private function should_display_notices(): bool {
        if (!current_user_can("manage_options")) {
            return false;
        }

        $screen = get_current_screen();
        return $screen && $screen->id === "settings_page_letterboxd-connect";
    }

    /**
     * Sanitize options before saving
     */
    public function sanitize_options(array $options): array {
        $sanitized = [
            "frequency" => $this->sanitize_frequency(
                $options["frequency"] ?? "daily"
            ),
            "notifications" => !empty($options["notifications"])
        ];

        do_action("letterboxd_auto_import_options"); // Add this line
        return $sanitized;
    }

    /**
     * Sanitize frequency setting
     */
    private function sanitize_frequency(string $frequency): string {
        return isset(self::SCHEDULES[$frequency]) ? $frequency : "daily";
    }

    /**
     * Clean up stale transients related to the import process
     *
     * @param bool $force_cleanup Whether to force cleanup of all plugin transients
     * @return int Number of transients removed
     */
    private function cleanup_stale_transients(
        bool $force_cleanup = false
    ): int {
        global $wpdb;
        $count = 0;

        // Define patterns for transients to clean up
        $patterns = [
            // Lock transients should always be checked
            self::CACHE_GROUP . "_import_lock"
        ];

        // Add more patterns if we're doing a force cleanup
        if ($force_cleanup) {
            $patterns[] = self::CACHE_GROUP . "_%"; // All auto-import transients
        }

        foreach ($patterns as $pattern) {
            // Get transients matching the pattern
            $transients = $wpdb->get_col(
                $wpdb->prepare(
                    "SELECT option_name FROM $wpdb->options 
                WHERE option_name LIKE %s OR option_name LIKE %s",
                    "_transient_" . $pattern,
                    "_transient_timeout_" . $pattern
                )
            );

            // For each matching transient
            foreach ($transients as $transient) {
                // Extract the transient name without the _transient_ prefix
                $transient_name = str_replace(
                    ["_transient_", "_transient_timeout_"],
                    "",
                    $transient
                );

                // For lock transients, only delete if they're older than the import lock duration
                if (strpos($transient_name, "_import_lock") !== false) {
                    $transient_value = get_transient($transient_name);

                    // If the transient exists (not expired) and we're not force cleaning
                    if ($transient_value !== false && !$force_cleanup) {
                        $timeout = get_option(
                            "_transient_timeout_" . $transient_name
                        );

                        // Only delete if the transient is older than import lock duration + 60 seconds buffer
                        if (
                            !$timeout ||
                            time() > $timeout - self::IMPORT_LOCK_DURATION + 60
                        ) {
                            delete_transient($transient_name);
                            $count++;
                        }
                    } else {
                        // Transient is already expired or we're force cleaning
                        delete_transient($transient_name);
                        $count++;
                    }
                } elseif ($force_cleanup) {
                    // For other transients, only delete if we're doing a force cleanup
                    delete_transient($transient_name);
                    $count++;
                }
            }
        }

        letterboxd_debug_log("Cleaned up {$count} stale transients");
        return $count;
    }

    /**
     * Schedule periodic cleanup of all plugin transients
     */
    private function schedule_transient_cleanup(): void {
        if (!wp_next_scheduled("letterboxd_cleanup_transients")) {
            wp_schedule_event(time(), "daily", "letterboxd_cleanup_transients");
        }

        add_action("letterboxd_cleanup_transients", [
            $this,
            "perform_scheduled_cleanup"
        ]);
    }

    /**
     * Execute scheduled cleanup of all plugin transients
     */
    public function perform_scheduled_cleanup(): void {
        $this->cleanup_stale_transients(true);
    }
}

================
File: README.md
================
# Letterboxd Connect
- Contributors: dcstagg
- Tags: letterboxd, movies, films, import, tmdb
- Requires at least: 5.0
- Tested up to: 6.7.2
- Stable tag: 1.0
- Requires PHP: 7.4
- License: GPLv3 or later
- License URI: http://www.gnu.org/licenses/gpl-3.0.html

Import your Letterboxd film diary into WordPress as custom movie posts with metadata, posters, and director information.

## Description

The Letterboxd Connect Plugin bridges the gap between your Letterboxd film log and your WordPress site. Letterbox does not offer an API, so this plugin uses the RSS feed of your username to automatically imports your watched films. L2WP creates custom movie posts with optional metadata including ratings, watch dates, posters, and more.

## Key Features

- **Automatic Film Import**: Import your Letterboxd diary entries via RSS feed
- **Custom Movie Post Type**: Films are stored as a dedicated movie post type with custom fields
- **TMDB Integration**: Enrich film data with posters, directors, and streaming information from [The Movie Database](https://www.themoviedb.org/)
- **Scheduled Imports**: Configure automatic imports to keep your site in sync with Letterboxd
- **Gutenberg Block**: Display your films in grid or list view with customizable settings
- **Year Taxonomy**: Films are automatically categorized by release year

## Installation

1. Download the plugin zip file
2. Navigate to your WordPress admin area and go to Plugins > Add New
3. Click "Upload Plugin" and select the downloaded zip file
4. Activate the plugin through the 'Plugins' menu

## Configuration

### Basic Setup

1. Go to Settings > Letterboxd Connect
2. Enter your Letterboxd username
3. Configure import settings (draft status, start date for import)
4. Save your settings

### TMDB Integration (Optional but Recommended)

For enhanced film data including posters, directors, and streaming information:

1. Create a free account at [The Movie Database (TMDB)](https://www.themoviedb.org/signup)
2. Grab your API key on the [TMDB Settings > API screen](https://www.themoviedb.org/settings/api)
3. Enter your TMDB API key in the plugin settings
4. Test the connection to verify it's working

## Usage

### Manual Import

1. Visit Settings > Letterboxd Connect page
2. Check the box that says "Run Import After Save"
2. Save the settings
3. The plugin will fetch your latest Letterboxd entries and create corresponding movie posts

### Automatic Import

1. Enable scheduled imports in the settings
2. Select your preferred frequency (hourly, daily, weekly)
3. Optionally enable email notifications for import results

### Displaying Movies

Use the custom Gutenberg block to showcase your movies:

1. Add a new block in the editor and search for "Movie Grid"
2. Configure display options (number of movies, columns, sort order)
3. Choose between card view (with posters) or list view
4. Publish your page or post

## Frequently Asked Questions

- **How many films can I import?**
The plugin can handle your entire Letterboxd diary. Imports are batched, so limitations are based on your server resources and WordPress configuration.

- **Do I need a TMDB API key?**
No, but it's highly recommended. Without it, you'll miss additional metadata like posters and director information.

- **How often should I schedule imports?**
This depends on how frequently you log films on Letterboxd. Daily imports work well for most users.

- **Can I import films from a specific date?**
Yes, you can set a start date in the plugin settings to limit which films are imported.

## Troubleshooting

**Import Issues**
- Verify your Letterboxd username is correct
- Check that your Letterboxd profile is public
- Ensure your server allows outgoing connections to Letterboxd's RSS feeds

**TMDB Connection Problems**
- Confirm your API key is entered correctly
- Check that your server allows connections to the TMDB API
- Verify your TMDB account is in good standing

## Changelog

- 1.0
* Initial release

## Upgrade Notice

- 1.0
Initial release of Letterboxd Connect.

## Screenshots

Coming soon!

## Credits

- Uses the [TMDB API](https://www.themoviedb.org/documentation/api) for enhanced film data
- Inspired by the Letterboxd community




================================================================
End of Codebase
================================================================
